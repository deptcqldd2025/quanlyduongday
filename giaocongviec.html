<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giao việc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="pb-16 bg-[#F4F7FA]">

    <div id="sidebar-container"></div>

    <div class="evn-header">
        <div class="max-w-md mx-auto flex items-center">
            <i class="fa fa-bars text-2xl cursor-pointer mr-4" onclick="toggleSidebar()"></i>
            <h1 class="font-black text-lg italic uppercase leading-none">Giao công việc</h1>
        </div>
    </div>

    <div class="max-w-md mx-auto px-6 -mt-8 space-y-6">
        <section class="bg-white p-6 rounded-[30px] shadow-lg border border-slate-50 space-y-4">
            <div class="border-l-4 border-green-500 pl-3 mb-2">
                <h2 class="text-[11px] font-black text-slate-800 uppercase tracking-widest">Phiếu giao việc</h2>
            </div>
            
            <div>
                <label class="text-[9px] font-black text-slate-400 uppercase ml-2 mb-1 block">Tên công việc</label>
                <input type="text" id="task-name" class="input-evn font-bold text-blue-900" placeholder="Nhập tên việc...">
            </div>

            <div>
                <label class="text-[9px] font-black text-slate-400 uppercase ml-2 mb-1 block">Người thực hiện</label>
                <select id="task-assignee" class="input-evn select-evn font-bold text-slate-700">
                    <option value="">Đang tải danh sách...</option>
                </select>
            </div>

            <div>
                <label class="text-[9px] font-black text-slate-400 uppercase ml-2 mb-1 block">Mô tả / Yêu cầu</label>
                <textarea id="task-desc" rows="4" class="input-evn" placeholder="Chi tiết yêu cầu..."></textarea>
            </div>

            <div>
                <label class="text-[9px] font-black text-slate-400 uppercase ml-2 mb-1 block">Hạn hoàn thành</label>
                <input type="date" id="task-deadline" class="input-evn font-bold text-slate-700">
            </div>

            <button onclick="assignTask()" id="btn-assign" class="w-full bg-green-600 text-white font-black py-4 rounded-[18px] shadow-lg shadow-green-100 uppercase text-[11px] tracking-widest active:scale-95 transition">
                Phát lệnh giao việc
            </button>
        </section>
    </div>

    <div class="footer-evn"><p>Hệ thống quản lý - Version 1.0</p></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M", authDomain: "baocaongay-e73a2.firebaseapp.com", projectId: "baocaongay-e73a2", storageBucket: "baocaongay-e73a2.firebasestorage.app", messagingSenderId: "75165392007", appId: "1:75165392007:web:4ec22bb1612108b096ac22" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        fetch('sidebar.html').then(res=>res.text()).then(data=>document.getElementById('sidebar-container').innerHTML=data);

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                document.getElementById('sidebar-user-name').innerText = user.displayName;
                checkManagerRoleAndLoadStaff(user);
            } else { window.location.href = "index.html"; }
        });

        async function checkManagerRoleAndLoadStaff(user) {
            const doc = await db.collection("users").doc(user.email).get();
            const role = doc.exists ? doc.data().position : "";
            const allowed = ["Tổ trưởng", "Tổ phó", "Đội trưởng", "Đội phó"];
            
            if (!allowed.includes(role)) {
                alert("Bạn không có quyền truy cập chức năng này!");
                window.location.href = "index.html";
            } else {
                setTimeout(() => document.querySelectorAll('.manager-only').forEach(el => el.classList.remove('hidden')), 500);
                loadStaff();
            }
        }

        async function loadStaff() {
            const select = document.getElementById('task-assignee');
            select.innerHTML = "";
            const snap = await db.collection("users").get();
            snap.forEach(doc => {
                const d = doc.data();
                const opt = document.createElement("option");
                // Value là tên hiển thị (displayName) để khớp với hệ thống báo cáo
                opt.value = d.name || "Không tên"; 
                opt.text = `${d.name} (${d.position || 'NV'})`;
                select.appendChild(opt);
            });
        }

        window.assignTask = async () => {
            const name = document.getElementById('task-name').value;
            const assignee = document.getElementById('task-assignee').value;
            if(!name || !assignee) return alert("Thiếu thông tin!");
            
            const btn = document.getElementById('btn-assign'); btn.innerText = "ĐANG XỬ LÝ..."; btn.disabled = true;
            try {
                await db.collection("tasks").add({
                    don_vi_de_nghi: name, description: document.getElementById('task-desc').value,
                    assigned_leader: assignee, deadline: document.getElementById('task-deadline').value,
                    status: "assigned", sender: auth.currentUser.displayName,
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Giao việc thành công!"); window.location.href="index.html";
            } catch(e) { alert(e.message); btn.innerText = "PHÁT LỆNH GIAO VIỆC"; btn.disabled = false; }
        }

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.menuAction = (action) => {
            toggleSidebar();
            if (action === 'report' || action === 'assigned') window.location.href = "index.html";
            else if (action === 'profile') window.location.href = "thongtincanhan.html";
            else if (action === 'guide') window.location.href = "huongdan.html";
            else if (action === 'send-notify') window.location.href = "guithongbao.html";
            else if (action === 'assign-task') {}; // Trang hiện tại
        };
        window.handleLogout = () => confirm("Đăng xuất?") && auth.signOut().then(()=>window.location.href='index.html');
    </script>
</body>
</html>
