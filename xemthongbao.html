<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông báo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="pb-16 bg-[#F4F7FA]">

    <div id="sidebar-container"></div>

    <div class="evn-header">
        <div class="max-w-md mx-auto flex items-center">
            <i class="fa fa-bars text-2xl cursor-pointer mr-4" onclick="toggleSidebar()"></i>
            <h1 class="font-black text-lg italic uppercase leading-none">Thông báo mới</h1>
        </div>
    </div>

    <div class="max-w-md mx-auto px-6 -mt-8 space-y-4" id="notification-list">
        <p class="text-center text-xs text-slate-400 italic py-10">Đang tải dữ liệu...</p>
    </div>

    <div class="footer-evn"><p>Hệ thống quản lý - Version 1.61</p></div>

    <script>
        // 1. CONFIG
        const firebaseConfig = { apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M", authDomain: "baocaongay-e73a2.firebaseapp.com", projectId: "baocaongay-e73a2", storageBucket: "baocaongay-e73a2.firebasestorage.app", messagingSenderId: "75165392007", appId: "1:75165392007:web:4ec22bb1612108b096ac22", measurementId: "G-TEGTD9KFCW" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = null;

        // 2. LOAD SIDEBAR
        fetch('sidebar.html')
            .then(res => res.text())
            .then(data => {
                document.getElementById('sidebar-container').innerHTML = data;
                // Nếu User đã đăng nhập, cập nhật Badge ngay
                if(currentUser) {
                    updateSidebarInfo(currentUser);
                    countUnreadNotifications(currentUser.email);
                }
                highlightActiveMenu();
            });

        // 3. AUTH CHECK
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                updateSidebarInfo(user);
                checkManagerRole(user);
                
                // Tải danh sách thông báo
                loadNotifications();
                // Đếm số tin chưa đọc để hiện lên Badge
                countUnreadNotifications(user.email);
            } else {
                window.location.href = "index.html";
            }
        });

        // 4. LOAD NOTIFICATIONS
        async function loadNotifications() {
            const list = document.getElementById('notification-list');
            try {
                // Lấy 20 tin mới nhất
                const snap = await db.collection("notifications").orderBy("timestamp", "desc").limit(20).get();
                
                if (snap.empty) {
                    list.innerHTML = `<div class="text-center text-slate-400 mt-10"><i class="fa fa-inbox text-4xl mb-2"></i><p class="text-xs">Không có thông báo nào</p></div>`;
                    return;
                }

                list.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    // Kiểm tra xem user hiện tại đã có trong mảng read_by chưa
                    const isRead = d.read_by && d.read_by.includes(currentUser.email);
                    
                    let iconClass = "fa-bell text-blue-500 bg-blue-100";
                    let borderClass = "border-slate-100";
                    
                    if(d.priority === 'urgent') {
                        iconClass = "fa-bolt text-red-500 bg-red-100";
                        borderClass = "border-red-200 bg-red-50/30";
                    } else if (d.priority === 'warning') {
                        iconClass = "fa-triangle-exclamation text-orange-500 bg-orange-100";
                    }

                    // Render Files (nếu có)
                    let filesHtml = "";
                    if(d.files && d.files.length > 0) {
                        filesHtml = `<div class="mt-3 border-t border-dashed border-slate-200 pt-2 space-y-1">` + 
                            d.files.map(f => `<div class="flex items-center text-[10px] text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded"><i class="fa fa-paperclip mr-2"></i>${f.name}</div>`).join('') + 
                        `</div>`;
                    }

                    // Nút xác nhận
                    let btnHtml = isRead 
                        ? `<button class="w-full mt-3 bg-slate-100 text-slate-400 text-[10px] font-black py-2 rounded-xl cursor-default"><i class="fa fa-check mr-1"></i> ĐÃ XEM</button>`
                        : `<button onclick="markAsRead('${doc.id}')" class="w-full mt-3 bg-blue-600 text-white text-[10px] font-black py-2 rounded-xl shadow active:scale-95 transition">XÁC NHẬN ĐÃ XEM</button>`;

                    // Thêm dấu chấm đỏ nếu chưa xem
                    const unreadDot = !isRead ? `<span class="absolute top-4 right-4 w-2 h-2 bg-red-500 rounded-full"></span>` : '';

                    return `
                    <div class="bg-white p-5 rounded-[24px] shadow-sm border ${borderClass} mb-3 relative">
                        ${unreadDot}
                        <div class="flex gap-3 mb-2">
                            <div class="w-8 h-8 rounded-full ${iconClass} flex items-center justify-center shrink-0">
                                <i class="fa ${iconClass.split(' ')[0]} text-xs"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-sm text-slate-800 leading-tight">${d.title}</h3>
                                <p class="text-[10px] text-slate-400 mt-1">${d.date} • ${d.sender}</p>
                            </div>
                        </div>
                        <div class="text-xs text-slate-600 leading-relaxed pl-11">
                            ${d.content.replace(/\n/g, '<br>')}
                        </div>
                        <div class="pl-11">
                            ${filesHtml}
                            ${btnHtml}
                        </div>
                    </div>`;
                }).join('');

            } catch (e) {
                console.error(e);
                list.innerHTML = `<p class="text-red-400 text-center text-xs">Lỗi tải tin: ${e.message}</p>`;
            }
        }

        // 5. MARK AS READ
        window.markAsRead = async (id) => {
            try {
                // Thêm email vào mảng read_by
                await db.collection("notifications").doc(id).update({
                    read_by: firebase.firestore.FieldValue.arrayUnion(currentUser.email)
                });
                // Reload lại list và badge
                loadNotifications();
                countUnreadNotifications(currentUser.email);
            } catch(e) { alert("Lỗi: " + e.message); }
        };

        // 6. TÍNH NĂNG ĐẾM BONG BÓNG (BADGE)
        async function countUnreadNotifications(email) {
            try {
                // Lấy tất cả thông báo (thực tế nên limit, nhưng ở đây lấy hết để đếm cho chuẩn)
                const snap = await db.collection("notifications").get();
                let unreadCount = 0;
                
                snap.forEach(doc => {
                    const d = doc.data();
                    // Nếu chưa có mảng read_by HOẶC email không nằm trong mảng read_by -> Chưa đọc
                    if(!d.read_by || !d.read_by.includes(email)) {
                        unreadCount++;
                    }
                });

                // Cập nhật lên Sidebar
                const badge = document.getElementById('notif-badge');
                if(badge) {
                    if(unreadCount > 0) {
                        badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch(e) { console.error("Lỗi đếm badge:", e); }
        }

        // 7. UTILS
        async function checkManagerRole(user) {
            try {
                const doc = await db.collection("users").doc(user.email).get();
                if(doc.exists) {
                    const role = doc.data().position || "";
                    const allowed = ["Tổ trưởng", "Tổ phó", "Đội trưởng", "Đội phó"];
                    if(allowed.includes(role)) setTimeout(() => document.querySelectorAll('.manager-only').forEach(el => el.classList.remove('hidden')), 500);
                }
            } catch(e) {}
        }

        function updateSidebarInfo(user) {
            const nameEl = document.getElementById('sidebar-user-name');
            const emailEl = document.getElementById('sidebar-user-email');
            if(nameEl && emailEl) { nameEl.innerText = user.displayName; emailEl.innerText = user.email; }
        }

        function highlightActiveMenu() {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(item => { if(item.getAttribute('onclick') && item.getAttribute('onclick').includes('notification')) item.classList.add('active'); });
        }

        // 8. MENU ACTION (Đã sửa lỗi cú pháp)
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        
        window.menuAction = (action) => {
            toggleSidebar();
            if (action === 'report') {
                window.location.href = "index.html";
            } else if (action === 'assigned') {
                window.location.href = "congvieccuatoi.html";
            } else if (action === 'notification') {
                // Trang hiện tại
            } else if (action === 'profile') {
                window.location.href = "thongtincanhan.html";
            } else if (action === 'guide') {
                window.location.href = "huongdan.html";
            } else if (action === 'send-notify') {
                window.location.href = "guithongbao.html";
            } else if (action === 'assign-task') {
                window.location.href = "giaocongviec.html";
            } else {
                alert("Tính năng đang phát triển!");
            }
        };

        window.handleLogout = () => confirm("Đăng xuất?") && auth.signOut().then(() => window.location.href = "index.html");
    </script>
</body>
</html>
