<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản Trị - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-tab { cursor: pointer; padding: 10px 20px; font-weight: bold; color: #64748B; border-bottom: 3px solid transparent; transition: 0.3s; white-space: nowrap; }
        .admin-tab.active { color: #1A479A; border-bottom-color: #1A479A; }
        .table-header { background: #F1F5F9; color: #475569; font-size: 11px; text-transform: uppercase; font-weight: 800; }
        .table-row { border-bottom: 1px solid #E2E8F0; transition: 0.2s; }
        .table-row:hover { background: #F8FAFC; }
        .td-cell { padding: 12px; font-size: 12px; color: #334155; vertical-align: middle; }
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; }
        /* Loading Screen */
        #auth-loading { position: fixed; inset: 0; background: #F4F7FA; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-[#F4F7FA] pb-10">

    <div id="auth-loading">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mb-4"></div>
        <p class="text-xs font-bold text-slate-500 uppercase">Đang xác thực quyền Admin...</p>
    </div>

    <div id="admin-main-content" class="hidden">
        
        <div id="sidebar-container"></div>

        <div class="evn-header">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fa fa-bars text-2xl cursor-pointer mr-4 lg:hidden" onclick="toggleSidebar()"></i>
                    <h1 class="font-black text-xl italic uppercase leading-none">Hệ thống quản trị</h1>
                </div>
                <div class="flex flex-col items-end">
                    <div class="text-[10px] bg-white/20 px-3 py-1 rounded-full font-bold">SUPER ADMIN</div>
                    <span id="current-admin-name" class="text-[9px] mt-1 opacity-80">...</span>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 mt-6">
            <div class="bg-white rounded-t-2xl shadow-sm border-b border-slate-200 flex overflow-x-auto no-scrollbar">
                <div class="admin-tab active" onclick="switchTab('reports')"><i class="fa fa-file-alt mr-2"></i>Báo cáo</div>
                <div class="admin-tab" onclick="switchTab('users')"><i class="fa fa-users mr-2"></i>Nhân sự</div>
                <div class="admin-tab" onclick="switchTab('notifications')"><i class="fa fa-bullhorn mr-2"></i>Thông báo</div>
                <div class="admin-tab" onclick="switchTab('tasks')"><i class="fa fa-tasks mr-2"></i>Công việc</div>
            </div>

            <div class="bg-white rounded-b-2xl shadow-lg min-h-[500px] p-4 overflow-x-auto">
                
                <div id="tab-reports" class="tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-blue-900 text-sm uppercase">Dữ liệu báo cáo ngày</h3>
                        <button onclick="loadReports()" class="text-xs bg-slate-100 p-2 rounded hover:bg-slate-200"><i class="fa fa-sync"></i> Làm mới</button>
                    </div>
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead>
                            <tr class="table-header">
                                <th class="p-3">Thời gian</th>
                                <th class="p-3">Nhân viên</th>
                                <th class="p-3">Loại báo cáo</th>
                                <th class="p-3 w-1/3">Nội dung</th>
                                <th class="p-3 text-center">File</th>
                                <th class="p-3 text-center">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-reports"></tbody>
                    </table>
                </div>

                <div id="tab-users" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-blue-900 text-sm uppercase">Quản lý nhân viên & Phân quyền</h3>
                        <button onclick="loadUsers()" class="text-xs bg-slate-100 p-2 rounded hover:bg-slate-200"><i class="fa fa-sync"></i> Làm mới</button>
                    </div>
                    <p class="text-[10px] text-red-500 italic mb-2">* Lưu ý: Chỉ Super Admin mới sửa được Chức vụ tại đây.</p>
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead>
                            <tr class="table-header">
                                <th class="p-3">Họ và tên</th>
                                <th class="p-3">Email</th>
                                <th class="p-3">Số điện thoại</th>
                                <th class="p-3">Chức vụ (Sửa)</th>
                                <th class="p-3">Đơn vị (Sửa)</th>
                                <th class="p-3 text-center">Lưu</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-users"></tbody>
                    </table>
                </div>

                <div id="tab-notifications" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-blue-900 text-sm uppercase">Lịch sử thông báo đã gửi</h3>
                        <button onclick="loadNoti()" class="text-xs bg-slate-100 p-2 rounded hover:bg-slate-200"><i class="fa fa-sync"></i> Làm mới</button>
                    </div>
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead>
                            <tr class="table-header">
                                <th class="p-3">Ngày gửi</th>
                                <th class="p-3">Tiêu đề</th>
                                <th class="p-3">Người gửi</th>
                                <th class="p-3 w-1/4">Nội dung</th>
                                <th class="p-3 text-center">Đính kèm</th>
                                <th class="p-3 text-center">Đã xem</th>
                                <th class="p-3 text-center">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-notifications"></tbody>
                    </table>
                </div>

                <div id="tab-tasks" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-blue-900 text-sm uppercase">Theo dõi giao việc</h3>
                        <button onclick="loadTasks()" class="text-xs bg-slate-100 p-2 rounded hover:bg-slate-200"><i class="fa fa-sync"></i> Làm mới</button>
                    </div>
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead>
                            <tr class="table-header">
                                <th class="p-3">Ngày giao</th>
                                <th class="p-3">Hạn chót</th>
                                <th class="p-3">Tên việc</th>
                                <th class="p-3">Người làm</th>
                                <th class="p-3">Trạng thái</th>
                                <th class="p-3 text-center">File</th>
                                <th class="p-3 text-center">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-tasks"></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content relative">
            <span class="absolute top-2 right-4 text-2xl font-bold cursor-pointer text-slate-400 hover:text-red-500" onclick="closeModal()">&times;</span>
            <h2 id="modal-title" class="font-black text-lg text-blue-900 mb-4 border-b pb-2">Chi tiết</h2>
            <div id="modal-body" class="text-sm text-slate-700 leading-relaxed"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M", authDomain: "baocaongay-e73a2.firebaseapp.com", projectId: "baocaongay-e73a2", storageBucket: "baocaongay-e73a2.firebasestorage.app", messagingSenderId: "75165392007", appId: "1:75165392007:web:4ec22bb1612108b096ac22", measurementId: "G-TEGTD9KFCW" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); const auth = firebase.auth();
        let currentUser = null;

        // LOAD SIDEBAR
        fetch('sidebar.html').then(r=>r.text()).then(d=>{ document.getElementById('sidebar-container').innerHTML=d; });

        // --- BẢO MẬT & PHÂN QUYỀN ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Kiểm tra chức vụ trong Database
                try {
                    const doc = await db.collection("users").doc(user.email).get();
                    if(doc.exists) {
                        const role = doc.data().position;
                        // DANH SÁCH ĐƯỢC PHÉP VÀO ADMIN: Tổ phó trở lên
                        const allowedRoles = ["Tổ phó", "Tổ trưởng", "Đội phó", "Đội trưởng", "Lãnh đạo"];
                        
                        if(allowedRoles.includes(role)) {
                            // ĐỦ QUYỀN: Hiện nội dung
                            currentUser = user;
                            document.getElementById('current-admin-name').innerText = user.displayName;
                            document.getElementById('auth-loading').classList.add('hidden');
                            document.getElementById('admin-main-content').classList.remove('hidden');
                            loadReports(); // Load tab đầu tiên
                        } else {
                            // KHÔNG ĐỦ QUYỀN
                            alert("Bạn không có quyền truy cập trang Admin (Yêu cầu: Tổ phó trở lên).");
                            window.location.href = "index.html";
                        }
                    } else {
                        // CHƯA CÓ DỮ LIỆU USER
                        alert("Tài khoản chưa được thiết lập hồ sơ.");
                        window.location.href = "index.html";
                    }
                } catch(e) {
                    alert("Lỗi xác thực: " + e.message);
                    window.location.href = "index.html";
                }
            } else {
                // CHƯA ĐĂNG NHẬP
                window.location.href = "index.html";
            }
        });

        // --- LOGIC GIAO DIỆN ADMIN ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            event.currentTarget.classList.add('active');
            
            if(tabName === 'reports') loadReports();
            if(tabName === 'users') loadUsers();
            if(tabName === 'notifications') loadNoti();
            if(tabName === 'tasks') loadTasks();
        }

        // 1. LOAD BÁO CÁO
        async function loadReports() {
            const tbody = document.getElementById('tbody-reports'); tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Đang tải...</td></tr>';
            try {
                const s = await db.collection("daily_reports").orderBy("timestamp", "desc").limit(50).get();
                if(s.empty) { tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Không có dữ liệu</td></tr>'; return; }
                tbody.innerHTML = s.docs.map(doc => {
                    const d = doc.data();
                    const filesHtml = renderFileIcons(d.files);
                    return `<tr class="table-row">
                        <td class="td-cell">${d.date}</td>
                        <td class="td-cell font-bold text-blue-900">${d.worker}</td>
                        <td class="td-cell"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-[10px] font-bold uppercase">${d.reportType}</span></td>
                        <td class="td-cell truncate max-w-xs" title="${d.content}">${d.content}</td>
                        <td class="td-cell text-center">${filesHtml}</td>
                        <td class="td-cell text-center">
                            <i class="fa fa-eye text-green-500 cursor-pointer mx-1" onclick="showModal('Chi tiết báo cáo', '${d.content.replace(/\n/g, '<br>')}')"></i>
                            <i class="fa fa-trash text-red-400 cursor-pointer mx-1" onclick="deleteItem('daily_reports','${doc.id}')"></i>
                        </td>
                    </tr>`;
                }).join('');
            } catch(e) { console.error(e); }
        }

        // 2. LOAD NHÂN SỰ
        async function loadUsers() {
            const tbody = document.getElementById('tbody-users'); tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Đang tải...</td></tr>';
            try {
                const s = await db.collection("users").orderBy("name").get();
                tbody.innerHTML = s.docs.map(doc => {
                    const d = doc.data();
                    return `<tr class="table-row">
                        <td class="td-cell font-bold">${d.name || '---'}</td>
                        <td class="td-cell text-[10px]">${d.email}</td>
                        <td class="td-cell">${d.phone || '---'}</td>
                        <td class="td-cell">
                            <select id="role-${doc.id}" class="border rounded p-1 text-[11px] font-bold bg-white">
                                <option value="Công nhân" ${d.position=='Công nhân'?'selected':''}>Công nhân</option>
                                <option value="Kỹ thuật viên" ${d.position=='Kỹ thuật viên'?'selected':''}>Kỹ thuật viên</option>
                                <option value="Tổ phó" ${d.position=='Tổ phó'?'selected':''}>Tổ phó</option>
                                <option value="Tổ trưởng" ${d.position=='Tổ trưởng'?'selected':''}>Tổ trưởng</option>
                                <option value="Đội phó" ${d.position=='Đội phó'?'selected':''}>Đội phó</option>
                                <option value="Đội trưởng" ${d.position=='Đội trưởng'?'selected':''}>Đội trưởng</option>
                                <option value="Lãnh đạo" ${d.position=='Lãnh đạo'?'selected':''}>Lãnh đạo</option>
                            </select>
                        </td>
                        <td class="td-cell">
                            <select id="unit-${doc.id}" class="border rounded p-1 text-[11px] font-bold bg-white">
                                <option value="Nhóm 1" ${d.unit=='Nhóm 1'?'selected':''}>Nhóm 1</option>
                                <option value="Nhóm 2" ${d.unit=='Nhóm 2'?'selected':''}>Nhóm 2</option>
                                <option value="Nhóm 3" ${d.unit=='Nhóm 3'?'selected':''}>Nhóm 3</option>
                                <option value="Nhóm 4" ${d.unit=='Nhóm 4'?'selected':''}>Nhóm 4</option>
                                <option value="Nhóm kỹ thuật" ${d.unit=='Nhóm kỹ thuật'?'selected':''}>Nhóm kỹ thuật</option>
                                <option value="Văn phòng đội" ${d.unit=='Văn phòng đội'?'selected':''}>Văn phòng đội</option>
                            </select>
                        </td>
                        <td class="td-cell text-center">
                            <button onclick="updateUser('${doc.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] hover:bg-blue-700">Lưu</button>
                        </td>
                    </tr>`;
                }).join('');
            } catch(e) { console.error(e); }
        }

        async function updateUser(emailKey) {
            const role = document.getElementById(`role-${emailKey}`).value;
            const unit = document.getElementById(`unit-${emailKey}`).value;
            if(confirm(`Cập nhật cho ${emailKey}:\n- Chức vụ: ${role}\n- Đơn vị: ${unit}?`)) {
                await db.collection("users").doc(emailKey).update({ position: role, unit: unit });
                alert("Đã cập nhật!");
            }
        }

        // 3. LOAD THÔNG BÁO
        async function loadNoti() {
            const tbody = document.getElementById('tbody-notifications'); tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Đang tải...</td></tr>';
            try {
                const s = await db.collection("notifications").orderBy("timestamp", "desc").limit(30).get();
                tbody.innerHTML = s.docs.map(doc => {
                    const d = doc.data();
                    const readCount = d.read_by ? d.read_by.length : 0;
                    const filesHtml = renderFileIcons(d.files);
                    return `<tr class="table-row">
                        <td class="td-cell">${d.date}</td>
                        <td class="td-cell font-bold">${d.title}</td>
                        <td class="td-cell">${d.sender}</td>
                        <td class="td-cell truncate max-w-xs">${d.content}</td>
                        <td class="td-cell text-center">${filesHtml}</td>
                        <td class="td-cell text-center"><span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-[10px] font-bold">${readCount} người</span></td>
                        <td class="td-cell text-center"><i class="fa fa-trash text-red-400 cursor-pointer" onclick="deleteItem('notifications','${doc.id}')"></i></td>
                    </tr>`;
                }).join('');
            } catch(e) { console.error(e); }
        }

        // 4. LOAD CÔNG VIỆC
        async function loadTasks() {
            const tbody = document.getElementById('tbody-tasks'); tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Đang tải...</td></tr>';
            try {
                const s = await db.collection("tasks").orderBy("created_at", "desc").limit(50).get();
                tbody.innerHTML = s.docs.map(doc => {
                    const d = doc.data();
                    const statusHtml = d.accepted_at 
                        ? `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[9px] font-bold"><i class="fa fa-check"></i> ${new Date(d.accepted_at.seconds*1000).toLocaleString('vi-VN')}</span>`
                        : `<span class="bg-orange-100 text-orange-600 px-2 py-1 rounded text-[9px] font-bold">Chưa nhận</span>`;
                    const filesHtml = renderFileIcons(d.files);
                    return `<tr class="table-row">
                        <td class="td-cell">${new Date(d.created_at.seconds*1000).toLocaleDateString('vi-VN')}</td>
                        <td class="td-cell text-red-500 font-bold">${d.deadline}</td>
                        <td class="td-cell font-bold text-blue-900">${d.don_vi_de_nghi}</td>
                        <td class="td-cell">${d.assigned_leader}</td>
                        <td class="td-cell">${statusHtml}</td>
                        <td class="td-cell text-center">${filesHtml}</td>
                        <td class="td-cell text-center"><i class="fa fa-trash text-red-400 cursor-pointer" onclick="deleteItem('tasks','${doc.id}')"></i></td>
                    </tr>`;
                }).join('');
            } catch(e) { console.error(e); }
        }

        // UTILS
        function renderFileIcons(files) {
            if (!files || files.length === 0) return '<span class="text-slate-300 text-[10px]">-</span>';
            return `<i class="fa fa-paperclip text-blue-500" title="${files.length} file"></i> <span class="text-[10px]">(${files.length})</span>`;
        }

        async function deleteItem(col, id) {
            if(confirm("Xóa dữ liệu này vĩnh viễn?")) {
                await db.collection(col).doc(id).delete();
                alert("Đã xóa!");
                const activeTab = document.querySelector('.admin-tab.active').innerText;
                if(activeTab.includes('Báo cáo')) loadReports();
                else if(activeTab.includes('Thông báo')) loadNoti();
                else if(activeTab.includes('Công việc')) loadTasks();
            }
        }

        function showModal(title, content) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('detailModal').style.display = "block";
        }
        function closeModal() { document.getElementById('detailModal').style.display = "none"; }
        window.onclick = function(e) { if (e.target == document.getElementById('detailModal')) closeModal(); }

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.menuAction = (a) => { window.location.href="index.html"; };
        window.handleLogout = () => confirm("Đăng xuất?") && auth.signOut().then(()=>window.location.href='index.html');
    </script>
</body>
</html>
