<script>
    // ... (Các phần code khác giữ nguyên)

    // LOAD NHÂN SỰ
    async function loadUsers() {
        const tbody = document.getElementById('tbody-users'); 
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Đang tải...</td></tr>';
        
        try {
            // Sắp xếp: Pending lên đầu để dễ thấy
            const s = await db.collection("users").orderBy("status", "desc").get(); // pending > approved (theo alphabet P > A)
            
            tbody.innerHTML = s.docs.map(doc => {
                const d = doc.data();
                const isPending = d.status === 'pending';
                const statusBadge = isPending 
                    ? `<span class="bg-orange-100 text-orange-600 px-2 py-1 rounded text-[9px] font-black uppercase animate-pulse">Chờ duyệt</span>`
                    : `<span class="bg-green-100 text-green-600 px-2 py-1 rounded text-[9px] font-bold uppercase">Đã duyệt</span>`;
                
                // Nếu đang chờ duyệt, hiện nút DUYỆT. Nếu đã duyệt, hiện nút LƯU
                const actionBtn = isPending
                    ? `<button onclick="approveUser('${doc.id}', '${d.name}')" class="bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold shadow hover:bg-green-700"><i class="fa fa-check mr-1"></i> DUYỆT NGAY</button>`
                    : `<button onclick="updateUser('${doc.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold hover:bg-blue-700">Lưu</button>`;

                return `<tr class="table-row ${isPending ? 'bg-orange-50/50' : ''}">
                    <td class="td-cell font-bold">${d.name || '---'}</td>
                    <td class="td-cell text-[10px]">${d.email}</td>
                    <td class="td-cell text-center">${statusBadge}</td>
                    <td class="td-cell">
                        <select id="role-${doc.id}" class="border rounded p-1 text-[11px] font-bold bg-white">
                            <option value="Công nhân" ${d.position=='Công nhân'?'selected':''}>Công nhân</option>
                            <option value="Kỹ thuật viên" ${d.position=='Kỹ thuật viên'?'selected':''}>Kỹ thuật viên</option>
                            <option value="Tổ phó" ${d.position=='Tổ phó'?'selected':''}>Tổ phó</option>
                            <option value="Tổ trưởng" ${d.position=='Tổ trưởng'?'selected':''}>Tổ trưởng</option>
                            <option value="Đội phó" ${d.position=='Đội phó'?'selected':''}>Đội phó</option>
                            <option value="Đội trưởng" ${d.position=='Đội trưởng'?'selected':''}>Đội trưởng</option>
                            <option value="Lãnh đạo" ${d.position=='Lãnh đạo'?'selected':''}>Lãnh đạo</option>
                        </select>
                    </td>
                    <td class="td-cell">
                        <select id="unit-${doc.id}" class="border rounded p-1 text-[11px] font-bold bg-white">
                            <option value="Nhóm 1" ${d.unit=='Nhóm 1'?'selected':''}>Nhóm 1</option>
                            <option value="Nhóm 2" ${d.unit=='Nhóm 2'?'selected':''}>Nhóm 2</option>
                            <option value="Nhóm 3" ${d.unit=='Nhóm 3'?'selected':''}>Nhóm 3</option>
                            <option value="Nhóm 4" ${d.unit=='Nhóm 4'?'selected':''}>Nhóm 4</option>
                            <option value="Nhóm kỹ thuật" ${d.unit=='Nhóm kỹ thuật'?'selected':''}>Nhóm kỹ thuật</option>
                            <option value="Văn phòng đội" ${d.unit=='Văn phòng đội'?'selected':''}>Văn phòng đội</option>
                        </select>
                    </td>
                    <td class="td-cell text-center">${actionBtn}</td>
                    <td class="td-cell text-center"><i class="fa fa-trash text-red-400 cursor-pointer" onclick="deleteItem('users','${doc.id}')"></i></td>
                </tr>`;
            }).join('');
        } catch(e) { console.error(e); }
    }

    // HÀM DUYỆT USER MỚI
    async function approveUser(email, name) {
        if(confirm(`Duyệt tài khoản ${name} (${email}) vào hệ thống?`)) {
            try {
                // Mặc định set là Công nhân / Nhóm 1. Admin có thể sửa sau.
                await db.collection("users").doc(email).update({
                    status: 'approved',
                    position: document.getElementById(`role-${email}`).value,
                    unit: document.getElementById(`unit-${email}`).value
                });
                alert("Đã duyệt thành công!");
                loadUsers(); // Reload lại bảng
            } catch(e) { alert("Lỗi: " + e.message); }
        }
    }

    // HÀM CẬP NHẬT USER CŨ (GIỮ NGUYÊN)
    async function updateUser(emailKey) {
        const role = document.getElementById(`role-${emailKey}`).value;
        const unit = document.getElementById(`unit-${emailKey}`).value;
        if(confirm(`Cập nhật cho ${emailKey}?`)) {
            await db.collection("users").doc(emailKey).update({ position: role, unit: unit });
            alert("Đã cập nhật!");
        }
    }

    // ... (Các phần khác giữ nguyên)
</script>
