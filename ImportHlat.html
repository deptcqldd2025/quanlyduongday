<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini HLAT Final Fix - v1.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #0068ff; }
        body { background: #f8fafc; font-family: system-ui, sans-serif; }
        .card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <header class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-black text-blue-800 uppercase italic">Gemini Auto Import</h1>
                <p class="text-gray-500 text-sm">X·ª≠ l√Ω h·ªì s∆°: <span class="font-bold text-blue-600">QLLƒê 2</span></p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-4">
                <div class="card p-10 border-2 border-dashed border-blue-200 text-center hover:bg-blue-50 transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" class="hidden" multiple accept="image/*,application/pdf">
                    <div class="text-5xl mb-4">üìÇ</div>
                    <p class="font-black text-gray-700 uppercase">Ch·ªçn h·ªì s∆° HLAT</p>
                    <p id="fileStatus" class="text-xs text-gray-400 mt-2 italic">Vui l√≤ng ch·ªçn file PDF ho·∫∑c ·∫¢nh</p>
                </div>
                <div id="filePreview" class="flex flex-wrap gap-2"></div>
                <button id="btnScan" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition">B·∫ÆT ƒê·∫¶U TR√çCH XU·∫§T AI</button>
            </div>

            <div class="card p-6 min-h-[400px]">
                <h3 class="font-bold text-gray-800 mb-6 uppercase italic border-b pb-2">K·∫øt qu·∫£ t·ª´ h·ªì s∆°</h3>
                <div id="resultArea" class="space-y-4">
                    <p class="text-center text-gray-300 mt-20 text-sm italic">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // S·ª≠ d·ª•ng API Key c·ªßa anh
        const API_KEY = "AIzaSyCyPQUxDvVBFpAClGoS8X9mvWX72y97XMA";
        const genAI = new GoogleGenerativeAI(API_KEY);
        
        // Fix l·ªói 404: Th·ª≠ g·ªçi m√¥ h√¨nh v·ªõi t√™n ƒë·∫ßy ƒë·ªß
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest" });

        const fileInput = document.getElementById('fileInput');
        const btnScan = document.getElementById('btnScan');
        const resultArea = document.getElementById('resultArea');

        fileInput.onchange = (e) => {
            const files = e.target.files;
            document.getElementById('fileStatus').innerText = `ƒê√£ ch·ªçn ${files.length} t·ªáp`;
            const preview = document.getElementById('filePreview');
            preview.innerHTML = [...files].map(f => `<span class="bg-blue-50 text-blue-600 text-[9px] px-2 py-1 rounded border border-blue-100 font-bold">${f.name}</span>`).join("");
        };

        btnScan.onclick = async () => {
            if (fileInput.files.length === 0) return alert("Ch∆∞a c√≥ h·ªì s∆° n√†o ƒë∆∞·ª£c ch·ªçn!");

            btnScan.disabled = true;
            btnScan.innerHTML = `<span class="loader"></span> AI ƒêANG ƒê·ªåC...`;
            resultArea.innerHTML = `<div class="text-center mt-20"><span class="loader"></span><p class="text-[10px] font-bold text-blue-400 mt-2">D·ªÆ LI·ªÜU ƒêANG ƒê∆Ø·ª¢C X·ª¨ L√ù...</p></div>`;

            try {
                const prompt = "Tr√≠ch xu·∫•t th√¥ng tin t·ª´ h·ªì s∆° HLAT n√†y sang JSON array. C√°c tr∆∞·ªùng: don_vi_de_nghi, dia_chi_cong_trinh, dt_hlat_thuc_te, dt_hlat_quy_hoach. L∆∞u √Ω di·ªán t√≠ch l·∫•y t·ª´ b·∫£n ƒë·ªì. Ch·ªâ tr·∫£ v·ªÅ JSON.";
                
                const parts = await Promise.all([...fileInput.files].map(fileToPart));
                const result = await model.generateContent([prompt, ...parts]);
                const response = await result.response;
                
                // Lo·∫°i b·ªè c√°c k√Ω t·ª± th·ª´a ƒë·ªÉ l·∫•y JSON chu·∫©n
                const text = response.text().replace(/```json|```/g, "").trim();
                const data = JSON.parse(text);

                renderResults(data);
            } catch (err) {
                resultArea.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-xl text-[10px] font-bold">L·ªói h·ªá th·ªëng: ${err.message}</div>`;
            } finally {
                btnScan.disabled = false;
                btnScan.innerHTML = `B·∫ÆT ƒê·∫¶U TR√çCH XU·∫§T AI`;
            }
        };

        async function fileToPart(file) {
            const base64 = await new Promise(r => {
                const reader = new FileReader();
                reader.onload = () => r(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return { inlineData: { data: base64, mimeType: file.type } };
        }

        function renderResults(data) {
            const items = Array.isArray(data) ? data : [data];
            resultArea.innerHTML = items.map(item => `
                <div class="border-2 border-blue-50 p-4 rounded-2xl bg-white shadow-sm">
                    <h4 class="font-black text-blue-800 text-xs mb-1 uppercase">${item.don_vi_de_nghi || "N/A"}</h4>
                    <p class="text-[10px] text-gray-500 mb-2 leading-tight">${item.dia_chi_cong_trinh || "N/A"}</p>
                    <div class="flex gap-4 border-t pt-2 border-dashed">
                        <div class="text-[9px]"><b>DT Th·ª±c t·∫ø:</b> <span class="text-red-600 font-bold">${item.dt_hlat_thuc_te} m2</span></div>
                        <div class="text-[9px]"><b>DT Quy ho·∫°ch:</b> <span class="text-red-600 font-bold">${item.dt_hlat_quy_hoach} m2</span></div>
                    </div>
                    <button onclick="alert('ƒê√£ l∆∞u h·ªì s∆° v√†o kho QLLƒê 2')" class="w-full bg-blue-50 text-blue-600 font-bold text-[9px] py-2 rounded-lg mt-3 uppercase">L∆∞u v√†o kho</button>
                </div>
            `).join("");
        }
    </script>
</body>
</html>
