<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√°o C√°o T·ªï ƒê∆∞·ªùng D√¢y - v1.7</title>
    
    <style>
        :root { --primary: #0056b3; --primary-hover: #004494; --bg: #f4f6f9; --white: #ffffff; --text: #333; --border: #ced4da; --radius: 12px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); line-height: 1.5; height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout Mobile */
        .app-container { max-width: 500px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; height: 100%; background: var(--white); box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .scroll-content { flex: 1; overflow-y: auto; padding: 16px; }
        .hidden { display: none !important; }

        /* Header */
        .header { background: var(--white); padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .header h1 { font-size: 18px; color: var(--primary); font-weight: 800; text-transform: uppercase; margin: 0; }
        .user-info { font-size: 12px; color: #666; }
        .btn-logout { font-size: 11px; color: #dc3545; background: #fff5f5; padding: 4px 10px; border-radius: 20px; border: 1px solid #ffecec; text-decoration: none; font-weight: bold; cursor: pointer; }

        /* Form Elements */
        .form-card { background: var(--white); border-radius: var(--radius); padding: 0; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; font-weight: 700; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        
        input[type="text"], textarea, select { width: 100%; padding: 12px 15px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 15px; transition: border 0.2s; outline: none; background: #fdfdfd; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(0,86,179,0.1); }
        textarea { resize: none; }

        /* File Upload */
        .file-upload-wrapper { position: relative; border: 2px dashed #cbd5e0; border-radius: var(--radius); padding: 20px; text-align: center; background: #f8fafc; transition: 0.2s; cursor: pointer; }
        .file-upload-wrapper:hover { background: #f1f5f9; border-color: var(--primary); }
        .file-upload-wrapper input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-text { font-size: 13px; color: #64748b; pointer-events: none; }
        .file-icon { font-size: 24px; color: #94a3b8; display: block; margin-bottom: 5px; }

        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: var(--radius); font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(0,86,179,0.2); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-refresh { background: transparent; border: 1px solid #ddd; color: var(--primary); padding: 5px 10px; font-size: 12px; width: auto; border-radius: 6px; }

        /* Report List */
        .section-title { font-size: 14px; font-weight: 700; color: #333; border-left: 4px solid var(--primary); padding-left: 10px; margin: 20px 0 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .report-item { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .report-header { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        .worker-name { font-weight: bold; color: var(--primary); font-size: 15px; }
        .worker-role { font-size: 11px; color: #888; font-weight: normal; }
        .report-time { font-size: 12px; font-weight: bold; color: #555; }
        .gps-badge { font-size: 10px; background: #e6fffa; color: #047857; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .report-content { font-size: 14px; color: #333; white-space: pre-line; margin-bottom: 8px; }
        .report-badge { display: inline-block; font-size: 11px; background: #fffbea; color: #92400e; padding: 2px 8px; border-radius: 4px; border: 1px solid #fcd34d; margin-bottom: 5px; }
        .file-link { display: inline-block; font-size: 11px; color: var(--primary); background: #ebf8ff; padding: 4px 8px; border-radius: 4px; text-decoration: none; margin-right: 5px; margin-top: 5px; border: 1px solid #bee3f8; }

        /* Login Screen */
        #loginScreen { background: linear-gradient(135deg, #0056b3 0%, #00c6ff 100%); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-logo { width: 60px; height: 60px; background: #e6f0ff; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .login-btn-google { background: white; border: 2px solid #eee; color: #444; margin-top: 20px; }
        .login-btn-google:hover { background: #f9f9f9; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 350px; padding: 25px; border-radius: 16px; }

        /* Loading */
        .loader { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-screen { position: fixed; inset: 0; background: white; z-index: 300; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .big-loader { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: rotation 1s linear infinite; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, query, where, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- C·∫§U H√åNH (QUAN TR·ªåNG: D√ÅN LINK V√ÄO ƒê√ÇY) ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwanzWLo8PhCuOnTGrP-Ra_5rbYvkCgdgbIr-gSPMxbsXJ-5creXdid0_GYQM6AufT4rA/exec"; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M",
            authDomain: "baocaongay-e73a2.firebaseapp.com",
            projectId: "baocaongay-e73a2",
            storageBucket: "baocaongay-e73a2.firebasestorage.app",
            messagingSenderId: "75165392007",
            appId: "1:75165392007:web:4ec22bb1612108b096ac22",
            measurementId: "G-TEGTD9KFCW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUserProfile = null;

        // --- AUTH ---
        window.loginGoogle = () => {
            const btn = document.getElementById('loginBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="loader" style="border-color:#333; border-bottom-color:transparent"></span> ƒêang k·∫øt n·ªëi...`;
            btn.disabled = true;

            signInWithPopup(auth, provider).catch(err => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                if (err.code === 'auth/unauthorized-domain') {
                    alert(`‚ö†Ô∏è L·ªñI: T√™n mi·ªÅn ${window.location.hostname} ch∆∞a ƒë∆∞·ª£c ph√©p!\nVui l√≤ng th√™m v√†o Firebase Authorized Domains.`);
                } else if (err.code !== 'auth/popup-closed-by-user') {
                    alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message);
                }
            });
        };

        window.logout = () => {
            if(confirm("ƒêƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?")) signOut(auth).then(() => location.reload());
        };

        onAuthStateChanged(auth, async (user) => {
            const loading = document.getElementById('mainLoading');
            if (user) {
                document.getElementById('loginScreen').classList.add('hidden');
                try {
                    const snap = await getDoc(doc(db, "users", user.uid));
                    loading.classList.add('hidden');
                    if (snap.exists()) {
                        currentUserProfile = snap.data();
                        document.getElementById('appScreen').classList.remove('hidden');
                        document.getElementById('userName').innerText = currentUserProfile.name;
                        document.getElementById('userRole').innerText = currentUserProfile.role + " (" + currentUserProfile.empId + ")";
                        loadReports();
                    } else {
                        document.getElementById('profileModal').classList.remove('hidden');
                        document.getElementById('profileEmail').value = user.email;
                    }
                } catch (e) {
                    loading.classList.add('hidden');
                    alert("L·ªói k·∫øt n·ªëi CSDL: " + e.message);
                }
            } else {
                loading.classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
            }
        });

        window.saveProfile = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSaveProfile');
            btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;
            try {
                const user = auth.currentUser;
                await setDoc(doc(db, "users", user.uid), {
                    name: document.getElementById('profileName').value.trim(),
                    empId: document.getElementById('profileId').value.trim(),
                    role: document.getElementById('profileRole').value,
                    email: user.email,
                    uid: user.uid,
                    updatedAt: Timestamp.now()
                });
                location.reload();
            } catch (err) { alert("L·ªói: " + err.message); btn.disabled = false; btn.innerText = "L∆ØU TH√îNG TIN"; }
        };

        // --- LOGIC B√ÅO C√ÅO ---
        const convertBase64 = (file) => new Promise((res, rej) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => res(reader.result.split(',')[1]);
            reader.onerror = err => rej(err);
        });

        async function uploadFiles(files) {
            const urls = [];
            for (let i = 0; i < files.length; i++) {
                try {
                    const base64 = await convertBase64(files[i]);
                    const res = await fetch(APPS_SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify({ filename: `${Date.now()}_${files[i].name}`, mimeType: files[i].type, file: base64 })
                    });
                    const data = await res.json();
                    if(data.status === 'success') urls.push(data.url);
                } catch (e) { console.warn("L·ªói upload (th∆∞·ªùng do CORS, file v·∫´n c√≥ th·ªÉ ƒë√£ l√™n Drive):", e); }
            }
            return urls;
        }

        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="loader"></span> ƒêang g·ª≠i...`; btn.disabled = true;

            if (APPS_SCRIPT_URL.includes("D√ÅN_LINK")) {
                alert("‚ùå L·ªói: Ch∆∞a c·∫•u h√¨nh Link Apps Script!"); btn.innerHTML = originalText; btn.disabled = false; return;
            }

            // GPS (Timeout 5s)
            let lat = 0, lng = 0;
            try {
                const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, {timeout: 5000}));
                lat = pos.coords.latitude; lng = pos.coords.longitude;
            } catch (err) {}

            // Upload File
            const fileInput = document.getElementById('fileInput');
            let att = [];
            if (fileInput.files.length > 0) {
                btn.innerHTML = `üì§ ƒêang t·∫£i ${fileInput.files.length} file...`;
                att = await uploadFiles(fileInput.files);
            }

            // Save DB
            btn.innerHTML = `üíæ ƒêang l∆∞u...`;
            try {
                await addDoc(collection(db, "daily_reports"), {
                    uid: auth.currentUser.uid,
                    workerName: currentUserProfile.name,
                    workerId: currentUserProfile.empId,
                    role: currentUserProfile.role,
                    timestamp: Timestamp.now(),
                    reportDateString: new Date().toLocaleDateString('vi-VN'),
                    locationCoords: { lat, lng },
                    pct_lct: document.getElementById('pctLct').value,
                    workContent: document.getElementById('workContent').value,
                    notes: document.getElementById('notes').value,
                    attachments: att
                });
                alert("‚úÖ B√°o c√°o th√†nh c√¥ng!");
                document.getElementById('reportForm').reset();
                document.getElementById('fileLabel').innerHTML = `<span class="file-icon">üì∏</span><span class="file-text">Ch·ªçn ·∫£nh / t√†i li·ªáu minh ch·ª©ng</span>`;
                loadReports();
            } catch (err) { alert("L·ªói: " + err.message); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        });

        document.getElementById('fileInput').addEventListener('change', function() {
            const count = this.files.length;
            document.getElementById('fileLabel').innerHTML = count ? 
                `<span class="file-icon" style="color:var(--primary)">‚úÖ</span><span class="file-text" style="color:var(--primary);font-weight:bold">ƒê√£ ch·ªçn ${count} file</span>` : 
                `<span class="file-icon">üì∏</span><span class="file-text">Ch·ªçn ·∫£nh / t√†i li·ªáu minh ch·ª©ng</span>`;
        });

        async function loadReports() {
            const list = document.getElementById('reportList');
            list.innerHTML = '<div style="text-align:center;padding:20px"><span class="loader" style="border-color:#ccc;border-bottom-color:transparent"></span></div>';
            
            try {
                const today = new Date().toLocaleDateString('vi-VN');
                const q = query(collection(db, "daily_reports"), where("reportDateString", "==", today), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                list.innerHTML = "";
                
                if (snap.empty) {
                    list.innerHTML = '<div style="text-align:center;color:#999;font-style:italic;padding:20px">Ch∆∞a c√≥ b√°o c√°o n√†o h√¥m nay</div>';
                    return;
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    const time = d.timestamp.toDate().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
                    
                    let files = "";
                    if (d.attachments && d.attachments.length) {
                        files = `<div style="margin-top:8px">${d.attachments.map((l,i) => `<a href="${l}" target="_blank" class="file-link">üìé File ${i+1}</a>`).join('')}</div>`;
                    }

                    const div = document.createElement("div");
                    div.className = "report-item";
                    div.innerHTML = `
                        <div class="report-header">
                            <div><span class="worker-name">${d.workerName}</span> <span class="worker-role">(${d.role})</span></div>
                            <div class="report-time">${time} ${d.locationCoords.lat ? '<span class="gps-badge">GPS</span>' : ''}</div>
                        </div>
                        ${d.pct_lct ? `<div class="report-badge">Phi·∫øu: ${d.pct_lct}</div>` : ''}
                        <div class="report-content">${d.workContent}</div>
                        ${d.notes ? `<div style="font-size:12px;color:#888;font-style:italic">Ghi ch√∫: ${d.notes}</div>` : ''}
                        ${files}
                    `;
                    list.appendChild(div);
                });
            } catch (err) { list.innerHTML = `<div style="color:red;text-align:center;padding:10px">L·ªói t·∫£i: ${err.message}</div>`; }
        }

        window.onload = () => document.getElementById('profileForm').addEventListener('submit', window.saveProfile);
    </script>
</head>
<body>

    <div id="mainLoading" class="loading-screen">
        <div class="big-loader"></div>
        <p style="margin-top:15px;color:#666;font-size:14px">ƒêang kh·ªüi ƒë·ªông h·ªá th·ªëng...</p>
    </div>

    <div id="loginScreen" class="hidden">
        <div class="login-box">
            <div class="login-logo">‚ö°</div>
            <h1 style="color:#0056b3;font-weight:800;margin-bottom:5px">T·ªî ƒê∆Ø·ªúNG D√ÇY</h1>
            <p style="color:#888;font-size:13px">H·ªá th·ªëng b√°o c√°o hi·ªán tr∆∞·ªùng v1.7</p>
            <button id="loginBtn" onclick="window.loginGoogle()" class="btn login-btn-google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:18px;margin-right:10px">
                ƒêƒÉng nh·∫≠p b·∫±ng Gmail
            </button>
        </div>
    </div>

    <div id="profileModal" class="hidden modal-overlay">
        <div class="modal-content">
            <h2 style="text-align:center;font-size:18px;margin-bottom:15px;color:var(--primary)">C·∫≠p Nh·∫≠t Th√¥ng Tin</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="text" id="profileEmail" disabled style="background:#eee">
                </div>
                <div class="form-group">
                    <label class="form-label">H·ªç v√† T√™n</label>
                    <input type="text" id="profileName" placeholder="Nh·∫≠p h·ªç t√™n" required>
                </div>
                <div class="form-group">
                    <label class="form-label">M√£ Nh√¢n Vi√™n</label>
                    <input type="text" id="profileId" placeholder="VD: 001234" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ch·ª©c danh</label>
                    <select id="profileRole">
                        <option value="C√¥ng nh√¢n">C√¥ng nh√¢n</option>
                        <option value="T·ªï tr∆∞·ªüng">T·ªï tr∆∞·ªüng</option>
                        <option value="T·ªï ph√≥">T·ªï ph√≥</option>
                        <option value="K·ªπ thu·∫≠t vi√™n">K·ªπ thu·∫≠t vi√™n</option>
                        <option value="L√°i xe">L√°i xe</option>
                    </select>
                </div>
                <button type="submit" id="btnSaveProfile" class="btn btn-primary">L∆ØU TH√îNG TIN</button>
            </form>
        </div>
    </div>

    <div id="appScreen" class="app-container hidden">
        <div class="header">
            <div>
                <h1>B√ÅO C√ÅO NG√ÄY</h1>
                <div class="user-info">Xin ch√†o, <span id="userName" style="font-weight:bold">...</span></div>
                <div id="userRole" style="font-size:10px;color:#999">...</div>
            </div>
            <button onclick="window.logout()" class="btn-logout">Tho√°t</button>
        </div>

        <div class="scroll-content">
            <form id="reportForm" class="form-card">
                <div style="background:#eef2f7;padding:10px;border-radius:var(--radius);text-align:center;margin-bottom:15px;font-size:13px;color:#555">
                    H√¥m nay: <b><span id="displayDate"></span></b>
                    <script>document.getElementById('displayDate').innerText = new Date().toLocaleDateString('vi-VN');</script>
                </div>

                <div class="form-group">
                    <input type="text" id="pctLct" placeholder="S·ªë Phi·∫øu / L·ªánh (n·∫øu c√≥)">
                </div>

                <div class="form-group">
                    <textarea id="workContent" rows="5" placeholder="N·ªôi dung c√¥ng vi·ªác th·ª±c hi·ªán *" required></textarea>
                </div>

                <div class="form-group">
                    <div class="file-upload-wrapper">
                        <input type="file" id="fileInput" multiple>
                        <div id="fileLabel">
                            <span class="file-icon">üì∏</span>
                            <span class="file-text">Ch·ªçn ·∫£nh / t√†i li·ªáu minh ch·ª©ng</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <input type="text" id="notes" placeholder="Ghi ch√∫ / Ki·∫øn ngh·ªã">
                </div>

                <button type="submit" id="submitBtn" class="btn btn-primary">G·ª¨I B√ÅO C√ÅO</button>
            </form>

            <div class="section-title">
                <span>üìã NH·∫¨T K√ù H√îM NAY</span>
                <button type="button" onclick="loadReports()" class="btn-refresh">L√†m m·ªõi</button>
            </div>
            <div id="reportList"></div>
        </div>
    </div>

</body>
</html>
