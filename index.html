<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S·ªï tay c√¥ng vi·ªác - v1.17</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0068ff">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #0068ff; --bg: #f8fafc; }
        body { background-color: var(--bg); font-family: -apple-system, sans-serif; overflow-x: hidden; }
        
        /* Sidebar 80% screen */
        #sidebar { transition: transform 0.3s ease-in-out; z-index: 1000; width: 80%; }
        #sidebar.hidden-menu { transform: translateX(-100%); }
        #overlay { transition: opacity 0.3s ease-in-out; z-index: 900; }
        
        .form-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; outline: none; font-size: 14px; }
        .form-input:focus { border-color: var(--primary); ring: 2px; ring-color: #0068ff20; }
        
        .report-item { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .loader { width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rot 1s linear infinite; display: inline-block; }
        @keyframes rot { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 font-bold">ƒêang t·∫£i...</p>
    </div>

    <div id="overlay" class="hidden fixed inset-0 bg-black/50 opacity-0 pointer-events-none"></div>

    <div id="sidebar" class="hidden-menu fixed top-0 left-0 h-full bg-white shadow-2xl flex flex-col">
        <div class="p-6 bg-blue-600 text-white relative">
            <button onclick="toggleSidebar()" class="absolute top-4 right-4 text-2xl font-bold">‚úï</button>
            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-xl mb-3">üë§</div>
            <div id="uNameSide" class="font-bold text-lg">ƒêang t·∫£i...</div>
            <div id="uRoleSide" class="text-xs text-blue-100 italic">...</div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="showPage('assignedTasks')" class="w-full flex items-center p-3 hover:bg-gray-100 rounded-xl font-bold text-gray-700">üìã C√¥ng vi·ªác ƒë∆∞·ª£c giao</button>
            <button onclick="showPage('reportForm')" class="w-full flex items-center p-3 hover:bg-gray-100 rounded-xl font-bold text-gray-700">‚úçÔ∏è G·ª≠i b√°o c√°o</button>
            <button onclick="showPage('history')" class="w-full flex items-center p-3 hover:bg-gray-100 rounded-xl font-bold text-gray-700">üïí Nh·∫≠t k√Ω c√° nh√¢n</button>
            <hr>
            <button onclick="document.getElementById('profileModal').classList.remove('hidden')" class="w-full flex items-center p-3 hover:bg-gray-100 rounded-xl font-bold text-gray-700">‚öôÔ∏è C·∫≠p nh·∫≠t th√¥ng tin</button>
        </nav>
        <div class="p-4 border-t">
            <button onclick="window.logout()" class="w-full p-3 text-red-500 font-bold bg-red-50 rounded-xl">THO√ÅT T√ÄI KHO·∫¢N</button>
        </div>
    </div>

    <div id="appScreen" class="hidden flex flex-col h-screen">
        <header class="bg-white border-b px-4 py-4 flex items-center justify-between sticky top-0 z-10">
            <button onclick="toggleSidebar()" class="text-2xl p-1">‚ò∞</button>
            <h1 class="font-black text-blue-600 text-sm uppercase tracking-wider">S·ªï tay c√¥ng vi·ªác</h1>
            <div class="w-8"></div>
        </header>

        <main class="flex-1 overflow-y-auto p-4">
            <div id="page-reportForm" class="page-section">
                <form id="form" class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 ml-1 uppercase">Lo·∫°i b√°o c√°o</label>
                        <select id="reportType" onchange="toggleReportFields()" class="form-input bg-gray-50 font-bold">
                            <option value="daily">B√°o c√°o ng√†y</option>
                            <option value="assigned">C√¥ng vi·ªác ƒë∆∞·ª£c giao</option>
                            <option value="urgent">B√°o c√°o ƒë·ªôt xu·∫•t</option>
                        </select>
                    </div>

                    <div id="assignedFields" class="hidden space-y-4 bg-blue-50 p-3 rounded-2xl border border-blue-100">
                        <div>
                            <label class="text-[10px] font-bold text-blue-400 ml-1 uppercase">Danh s√°ch vi·ªác l√£nh ƒë·∫°o giao</label>
                            <select id="taskSelect" class="form-input font-bold text-blue-700 border-blue-200">
                                <option value="">-- Ch·ªçn c√¥ng vi·ªác --</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-blue-400 ml-1 uppercase">M·ª©c ƒë·ªô ho√†n th√†nh</label>
                            <select id="progress" onchange="toggleReasonField()" class="form-input font-bold border-blue-200">
                                <option value="100%">ƒê√£ xong (100%)</option>
                                <option value="70%">ƒêang th·ª±c hi·ªán (70%)</option>
                                <option value="50%">M·ªõi ƒë∆∞·ª£c m·ªôt n·ª≠a (50%)</option>
                                <option value="25%">M·ªõi b·∫Øt ƒë·∫ßu (25%)</option>
                            </select>
                        </div>
                        <div id="reasonField" class="hidden">
                            <label class="text-[10px] font-bold text-red-500 ml-1 uppercase">L√Ω do ch∆∞a ho√†n th√†nh *</label>
                            <input id="reason" placeholder="Vd: Thi·∫øu v·∫≠t t∆∞, th·ªùi ti·∫øt x·∫•u..." class="form-input border-red-200">
                        </div>
                    </div>

                    <input id="pct" placeholder="S·ªë Phi·∫øu / L·ªánh (N·∫øu c√≥)" class="form-input">
                    <textarea id="content" rows="4" placeholder="N·ªôi dung c√¥ng vi·ªác th·ª±c hi·ªán *" required class="form-input"></textarea>
                    
                    <div class="p-4 bg-white border-2 border-dashed border-gray-200 rounded-2xl text-center">
                        <div id="fileListPreview" class="space-y-2 mb-3"></div>
                        <input type="file" id="fileIn" multiple class="hidden">
                        <button type="button" onclick="document.getElementById('fileIn').click()" class="text-blue-600 font-bold text-sm">üì∏ CH·ª§P ·∫¢NH / CH·ªåN FILE</button>
                    </div>

                    <button type="submit" id="sBtn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">G·ª¨I B√ÅO C√ÅO</button>
                </form>
            </div>

            <div id="page-assignedTasks" class="page-section hidden"><div id="assignedList" class="space-y-3"></div></div>
            <div id="page-history" class="page-section hidden"><div id="list" class="space-y-3"></div></div>
        </main>
    </div>

    <script type="module">
        // ... (Gi·ªØ nguy√™n ph·∫ßn import v√† config firebaseConfig c·ªßa b·∫°n)
        
        // Logic m·ªõi cho Form
        window.toggleReportFields = () => {
            const type = document.getElementById('reportType').value;
            const fields = document.getElementById('assignedFields');
            if(type === 'assigned') {
                fields.classList.remove('hidden');
                document.getElementById('content').placeholder = "Chi ti·∫øt ti·∫øn ƒë·ªô th·ª±c hi·ªán...";
            } else {
                fields.classList.add('hidden');
                document.getElementById('content').placeholder = "N·ªôi dung c√¥ng vi·ªác th·ª±c hi·ªán *";
            }
        };

        window.toggleReasonField = () => {
            const progress = document.getElementById('progress').value;
            const reasonDiv = document.getElementById('reasonField');
            const reasonInput = document.getElementById('reason');
            if(progress !== '100%') {
                reasonDiv.classList.remove('hidden');
                reasonInput.required = true;
            } else {
                reasonDiv.classList.add('hidden');
                reasonInput.required = false;
            }
        };

        // C·∫≠p nh·∫≠t h√†m Submit Form
        document.getElementById('form').onsubmit = async (e) => {
            e.preventDefault();
            // ... (Logic upload ·∫£nh, l·∫•y v·ªã tr√≠)

            const reportData = {
                type: document.getElementById('reportType').value,
                content: document.getElementById('content').value,
                pct: document.getElementById('pct').value,
                // D·ªØ li·ªáu b·ªï sung n·∫øu l√† vi·ªác ƒë∆∞·ª£c giao
                progress: document.getElementById('reportType').value === 'assigned' ? document.getElementById('progress').value : 'N/A',
                reason: (document.getElementById('reportType').value === 'assigned' && document.getElementById('progress').value !== '100%') ? document.getElementById('reason').value : '',
                // ... (C·∫•c tr∆∞·ªùng uid, workerName, timestamp nh∆∞ c≈©)
            };
            
            // ... (Ti·∫øn h√†nh l∆∞u v√†o Firestore)
        };

        // ... (Ph·∫ßn c√≤n l·∫°i c·ªßa t·ªáp index v1.16)
        window.toggleSidebar = () => {
            const side = document.getElementById('sidebar');
            const over = document.getElementById('overlay');
            side.classList.toggle('hidden-menu');
            over.classList.toggle('hidden');
            if (!over.classList.contains('hidden')) setTimeout(() => over.classList.add('opacity-100'), 10);
            else over.classList.remove('opacity-100');
        };
    </script>
</body>
</html>
