<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω C√¥ng vi·ªác - v1.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #0068ff; }
        body { background: #f8fafc; font-family: sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .header { height: 60px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; }
        .main-container { flex: 1; display: flex; overflow: hidden; }
        .tab-content { flex: 1; display: flex; overflow: hidden; }
        .active-tab { border-bottom: 3px solid var(--primary); color: var(--primary); }
        #map { height: 100%; width: 100%; border-radius: 12px; }
        .table-container { height: 100%; overflow-y: auto; }
        th { position: sticky; top: 0; background: #f1f5f9; z-index: 10; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="header">
        <h1 class="font-black text-blue-700 uppercase tracking-tighter">H·ªá th·ªëng Qu·∫£n l√Ω C√¥ng vi·ªác</h1>
        <div class="flex items-center gap-6">
            <nav class="flex gap-4 h-full">
                <button onclick="switchTab('reports')" id="btn-reports" class="tab-btn active-tab font-bold text-sm h-[60px]">B√ÅO C√ÅO</button>
                <button onclick="switchTab('assign')" id="btn-assign" class="tab-btn font-bold text-sm h-[60px]">GIAO VI·ªÜC</button>
                <button onclick="switchTab('workers')" id="btn-workers" class="tab-btn font-bold text-sm h-[60px]">NH√ÇN S·ª∞</button>
            </nav>
            <div class="flex items-center gap-3 border-l pl-4">
                <span id="adminName" class="text-xs font-bold text-gray-600"></span>
                <button onclick="window.logout()" class="text-red-500 text-xs font-bold bg-red-50 px-3 py-1.5 rounded-lg">THO√ÅT</button>
            </div>
        </div>
    </div>

    <div id="tab-reports" class="tab-content">
        <div class="w-[70%] flex flex-col border-r bg-white">
            <div class="p-4 bg-slate-50 border-b flex items-center justify-between gap-4">
                <div class="flex gap-2">
                    <select id="timeFilter" onchange="loadReports()" class="border p-2 rounded text-xs font-bold outline-none">
                        <option value="today">H√¥m nay</option>
                        <option value="week">Tu·∫ßn n√†y</option>
                        <option value="month">Th√°ng n√†y</option>
                    </select>
                    <select id="workerFilter" onchange="loadReports()" class="border p-2 rounded text-xs font-bold outline-none">
                        <option value="all">T·∫•t c·∫£ c√¥ng nh√¢n</option>
                    </select>
                </div>
                <button onclick="exportExcel()" class="bg-green-600 text-white text-xs px-4 py-2 rounded font-bold">XU·∫§T EXCEL</button>
            </div>
            <div class="table-container p-4">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[11px] uppercase text-gray-400 border-b">
                            <th class="p-3">Th·ªùi gian</th>
                            <th class="p-3">Nh√¢n vi√™n</th>
                            <th class="p-3">N·ªôi dung c√¥ng vi·ªác</th>
                            <th class="p-3">Minh ch·ª©ng</th>
                            <th class="p-3 text-center">Duy·ªát</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody" class="text-sm"></tbody>
                </table>
            </div>
        </div>
        <div class="w-[30%] p-4 bg-gray-100">
            <div id="map"></div>
        </div>
    </div>

    <div id="tab-assign" class="tab-content hidden p-6 overflow-y-auto">
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-sm border">
            <h2 class="text-xl font-bold mb-6 text-blue-700">Giao vi·ªác cho t·ªï vi√™n</h2>
            <form id="assignForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold mb-1">C√îNG NH√ÇN NH·∫¨N VI·ªÜC</label>
                    <select id="assignTarget" required class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold mb-1">N·ªòI DUNG GIAO VI·ªÜC</label>
                    <textarea id="assignContent" rows="4" required class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold mb-1">TH·ªúI H·∫†N (DEADLINE)</label>
                        <input type="date" id="assignDeadline" required class="w-full p-3 border rounded-xl outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1">FILE ƒê√çNH K√àM (PCT/LCT)</label>
                        <input type="file" id="assignFile" class="w-full p-2 border border-dashed rounded-xl text-xs">
                    </div>
                </div>
                <button type="submit" id="btnAssign" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition">PH√ÅT L·ªÜNH GIAO VI·ªÜC</button>
            </form>
        </div>
    </div>

    <div id="tab-workers" class="tab-content hidden p-6 overflow-y-auto">
        <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-sm border p-6">
            <h2 class="text-xl font-bold mb-4">Qu·∫£n l√Ω nh√¢n s·ª± trong t·ªï</h2>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50 text-xs font-bold">
                        <th class="p-4 border-b">H·ªç t√™n</th>
                        <th class="p-4 border-b">M√£ NV</th>
                        <th class="p-4 border-b">Ch·ª©c v·ª•</th>
                        <th class="p-4 border-b">Email</th>
                        <th class="p-4 border-b">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="workerTableBody" class="text-sm"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, query, where, orderBy, Timestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwanzWLo8PhCuOnTGrP-Ra_5rbYvkCgdgbIr-gSPMxbsXJ-5creXdid0_GYQM6AufT4rA/exec";
        const firebaseConfig = {
            apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M",
            authDomain: "baocaongay-e73a2.firebaseapp.com",
            projectId: "baocaongay-e73a2",
            storageBucket: "baocaongay-e73a2.firebasestorage.app",
            messagingSenderId: "75165392007",
            appId: "1:75165392007:web:4ec22bb1612108b096ac22",
            measurementId: "G-TEGTD9KFCW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        let map, markers = [], allReports = [];

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                const p = snap.exists() ? snap.data() : {};
                document.getElementById('adminName').innerText = p.name || user.email;
                initMap();
                loadWorkers();
                loadReports();
            } else { window.location.href = "index.html"; }
        });

        window.switchTab = (name) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            document.getElementById('tab-' + name).classList.remove('hidden');
            document.getElementById('btn-' + name).classList.add('active-tab');
            if(name === 'reports') map.invalidateSize();
        };

        // --- QU·∫¢N L√ù B√ÅO C√ÅO ---
        window.loadReports = async () => {
            const timeMode = document.getElementById('timeFilter').value;
            const workerFilter = document.getElementById('workerFilter').value;
            let start = new Date(); start.setHours(0,0,0,0);
            if(timeMode === 'week') start.setDate(start.getDate() - 7);
            if(timeMode === 'month') start.setDate(1);

            let q = query(collection(db, "daily_reports"), where("timestamp", ">=", Timestamp.fromDate(start)), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = "";
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            allReports = [];

            snap.forEach(d => {
                const r = d.data();
                if(workerFilter !== 'all' && r.workerName !== workerFilter) return;
                
                allReports.push(r);
                const id = d.id;
                const timeStr = r.timestamp.toDate().toLocaleString('vi-VN');
                const isReviewed = r.status === 'reviewed';

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-blue-50 transition">
                        <td class="p-3 text-[11px] font-bold text-gray-500">${timeStr}</td>
                        <td class="p-3 font-bold">${r.workerName}</td>
                        <td class="p-3 text-gray-700">${r.content} ${r.reply ? `<br><span class="text-xs text-blue-600 font-bold italic">Ph·∫£n h·ªìi: ${r.reply}</span>` : ''}</td>
                        <td class="p-3">${r.attachments ? r.attachments.map((u,i) => `<a href="${u}" target="_blank" class="text-blue-500 mr-2">üìé</a>`).join('') : ''}</td>
                        <td class="p-3 text-center flex gap-2 justify-center">
                            <button onclick="reviewReport('${id}')" title="Duy·ªát">${isReviewed ? 'üîí' : 'üëÅÔ∏è'}</button>
                            <button onclick="replyReport('${id}')" title="Ph·∫£n h·ªìi">üí¨</button>
                        </td>
                    </tr>`;
                
                if(r.locationCoords?.lat) {
                    const m = L.marker([r.locationCoords.lat, r.locationCoords.lng]).addTo(map).bindPopup(r.workerName);
                    markers.push(m);
                }
            });
        };

        window.reviewReport = async (id) => {
            await updateDoc(doc(db, "daily_reports", id), { status: "reviewed" });
            loadReports();
        };

        window.replyReport = async (id) => {
            const msg = prompt("G·ª≠i √Ω ki·∫øn ph·∫£n h·ªìi cho b√°o c√°o n√†y:");
            if(msg) {
                await updateDoc(doc(db, "daily_reports", id), { reply: msg });
                loadReports();
            }
        };

        // --- QU·∫¢N L√ù NH√ÇN S·ª∞ ---
        window.loadWorkers = async () => {
            const snap = await getDocs(collection(db, "users"));
            const tbody = document.getElementById('workerTableBody');
            const selectAssign = document.getElementById('assignTarget');
            const selectFilter = document.getElementById('workerFilter');
            
            tbody.innerHTML = "";
            selectAssign.innerHTML = "";
            selectFilter.innerHTML = `<option value="all">T·∫•t c·∫£ c√¥ng nh√¢n</option>`;

            snap.forEach(d => {
                const w = d.data();
                const id = d.id;
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-4"><input onchange="updateWorker('${id}', 'name', this.value)" value="${w.name}" class="bg-transparent font-bold"></td>
                        <td class="p-4"><input onchange="updateWorker('${id}', 'empId', this.value)" value="${w.empId}" class="bg-transparent"></td>
                        <td class="p-4"><input onchange="updateWorker('${id}', 'role', this.value)" value="${w.role}" class="bg-transparent text-blue-600 font-bold"></td>
                        <td class="p-4 text-gray-400">${w.email}</td>
                        <td class="p-4"><button onclick="deleteUser('${id}')" class="text-red-500">üóëÔ∏è</button></td>
                    </tr>`;
                selectAssign.innerHTML += `<option value="${w.empId}">${w.name} (${w.empId})</option>`;
                selectFilter.innerHTML += `<option value="${w.name}">${w.name}</option>`;
            });
        };

        window.updateWorker = async (id, field, value) => {
            await updateDoc(doc(db, "users", id), { [field]: value });
        };

        // --- GIAO VI·ªÜC ---
        document.getElementById('assignForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnAssign');
            btn.innerText = "ƒêANG G·ª¨I L·ªÜNH..."; btn.disabled = true;

            let fileUrl = "";
            const file = document.getElementById('assignFile').files[0];
            if(file) {
                let reader = new FileReader();
                let base64 = await new Promise(r => { reader.readAsDataURL(file); reader.onload = () => r(reader.result.split(',')[1]) });
                const res = await fetch(APPS_SCRIPT_URL, { method: "POST", body: JSON.stringify({ filename: "GIAOVIEC_"+file.name, mimeType: file.type, file: base64 }) });
                const json = await res.json();
                fileUrl = json.url;
            }

            await addDoc(collection(db, "assigned_tasks"), {
                targetId: document.getElementById('assignTarget').value,
                content: document.getElementById('assignContent').value,
                deadline: document.getElementById('assignDeadline').value,
                attachment: fileUrl,
                status: "new",
                createdAt: Timestamp.now()
            });

            alert("ƒê√£ giao vi·ªác th√†nh c√¥ng!");
            document.getElementById('assignForm').reset();
            btn.innerText = "PH√ÅT L·ªÜNH GIAO VI·ªÜC"; btn.disabled = false;
        };

        function initMap() {
            map = L.map('map').setView([10.7769, 106.7009], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        window.logout = () => signOut(auth).then(() => location.reload());
        window.exportExcel = () => {
            const ws = XLSX.utils.json_to_sheet(allReports.map(r => ({ "Gi·ªù": r.timestamp.toDate().toLocaleString(), "Nh√¢n vi√™n": r.workerName, "N·ªôi dung": r.content, "Ph·∫£n h·ªìi": r.reply || "" })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "BaoCao");
            XLSX.writeFile(wb, "H·ªá_Th·ªëng_Qu·∫£n_L√Ω.xlsx");
        };
    </script>
</body>
</html>
