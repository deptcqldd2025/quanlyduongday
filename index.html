<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o T·ªï ƒê∆∞·ªùng D√¢y - v1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // C·∫•u h√¨nh Firebase c·ªßa b·∫°n
        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };

        // Kh·ªüi t·∫°o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DANH S√ÅCH NH√ÇN VI√äN T·ªî ƒê∆Ø·ªúNG D√ÇY (ƒê√£ c·∫≠p nh·∫≠t theo danh s√°ch th·ª±c t·∫ø) ---
        const workers = [
            "Tr·∫ßn Ng·ªçc L√¢m (T·ªï tr∆∞·ªüng) - 005469",
            "ƒêinh C√¥ng Ngh·ªá (T·ªï ph√≥) - 003597",
            "Tr·∫ßn Quang Hi·ªÅn (C√¥ng nh√¢n) - 001989",
            "Tr·∫ßn Qu·ªëc ƒê·∫°t (C√¥ng nh√¢n) - 010550",
            "B√πi D∆∞∆°ng ƒê√¥ng (C√¥ng nh√¢n) - 004319",
            "Nguy·ªÖn Minh H·∫£i (C√¥ng nh√¢n) - 009712",
            "Nguy·ªÖn Thanh Khoa (C√¥ng nh√¢n) - 009718",
            "Nguy·ªÖn Ng·ªçc Th√†nh Tr∆∞·ªùng (C√¥ng nh√¢n) - 009114",
            "Ph√πng Quang Tr∆∞·ªùng (C√¥ng nh√¢n) - 005932",
            "Tr·∫ßn Thanh Hi·ªÅn (C√¥ng nh√¢n) - 005937",
            "L∆∞u Tr·ªçng Hi·∫øu (C√¥ng nh√¢n) - 009467",
            "Nguy·ªÖn Ho√†ng Long (C√¥ng nh√¢n) - 010549",
            "Tr·∫ßn Quang Nh√£ (C√¥ng nh√¢n) - 005934",
            "Nguy·ªÖn Thanh Nh√†n (C√¥ng nh√¢n) - 008378",
            "Tr·∫ßn Thanh Phong (C√¥ng nh√¢n) - 009724",
            "Nguy·ªÖn Th√°i S∆°n (C√¥ng nh√¢n) - 006906",
            "Nguy·ªÖn Ho√†ng Trung (C√¥ng nh√¢n) - 009738",
            "Nguy·ªÖn B√° Trung (C√¥ng nh√¢n) - 007470"
        ];

        // H√†m ƒëi·ªÅn danh s√°ch nh√¢n vi√™n v√†o Select box
        function populateWorkerSelect() {
            const select = document.getElementById('workerSelect');
            workers.forEach(info => {
                const option = document.createElement('option');
                option.value = info;
                option.text = info;
                select.appendChild(option);
            });
        }

        // X·ª≠ l√Ω g·ª≠i b√°o c√°o
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.innerText;
            submitBtn.innerText = "ƒêang g·ª≠i...";
            submitBtn.disabled = true;

            const reportData = {
                worker: document.getElementById('workerSelect').value,
                date: document.getElementById('reportDate').value,
                location: document.getElementById('location').value,
                workContent: document.getElementById('workContent').value,
                safetyCheck: {
                    ppe: document.getElementById('checkPPE').checked,
                    tools: document.getElementById('checkTools').checked,
                    loc: document.getElementById('checkLoc').checked
                },
                notes: document.getElementById('notes').value,
                createdAt: Timestamp.now()
            };

            try {
                await addDoc(collection(db, "daily_reports"), reportData);
                alert("B√°o c√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!");
                document.getElementById('reportForm').reset();
                // Reset ng√†y v·ªÅ h√¥m nay
                document.getElementById('reportDate').valueAsDate = new Date();
                loadReports(); // T·∫£i l·∫°i danh s√°ch
            } catch (error) {
                console.error("L·ªói khi g·ª≠i b√°o c√°o: ", error);
                alert("C√≥ l·ªói x·∫£y ra: " + error.message);
            } finally {
                submitBtn.innerText = originalBtnText;
                submitBtn.disabled = false;
            }
        });

        // H√†m t·∫£i v√† hi·ªÉn th·ªã b√°o c√°o (M·∫∑c ƒë·ªãnh t·∫£i b√°o c√°o h√¥m nay)
        async function loadReports() {
            const listContainer = document.getElementById('reportList');
            listContainer.innerHTML = '<p class="text-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</p>';
            
            // L·∫•y ng√†y hi·ªán t·∫°i t·ª´ input ƒë·ªÉ l·ªçc (ho·∫∑c m·∫∑c ƒë·ªãnh h√¥m nay)
            const selectedDate = document.getElementById('reportDate').value;

            try {
                const q = query(
                    collection(db, "daily_reports"), 
                    where("date", "==", selectedDate),
                    orderBy("createdAt", "desc")
                );

                const querySnapshot = await getDocs(q);
                listContainer.innerHTML = '';

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 italic">Ch∆∞a c√≥ b√°o c√°o n√†o cho ng√†y n√†y.</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = "bg-white p-4 rounded-lg shadow border-l-4 border-blue-500 mb-3";
                    
                    let safetyBadges = '';
                    if(data.safetyCheck.ppe) safetyBadges += '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mr-1">ƒê·ªß BHLƒê</span>';
                    else safetyBadges += '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded mr-1">Thi·∫øu BHLƒê</span>';
                    
                    if(data.safetyCheck.tools) safetyBadges += '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mr-1">D·ª•ng c·ª• OK</span>';
                    
                    if(data.safetyCheck.loc) safetyBadges += '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded mr-1">Phi·∫øu PCT/LCT</span>';

                    item.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg text-gray-800">${data.worker}</h3>
                            <span class="text-xs text-gray-500">${new Date(data.createdAt.seconds * 1000).toLocaleTimeString('vi-VN')}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1"><span class="font-semibold">üìç V·ªã tr√≠:</span> ${data.location}</p>
                        <div class="mb-2">${safetyBadges}</div>
                        <div class="bg-gray-50 p-2 rounded text-gray-700 text-sm whitespace-pre-line">${data.workContent}</div>
                        ${data.notes ? `<p class="text-xs text-gray-500 mt-2 italic">Ghi ch√∫: ${data.notes}</p>` : ''}
                    `;
                    listContainer.appendChild(item);
                });
            } catch (error) {
                console.error("L·ªói t·∫£i b√°o c√°o:", error);
                listContainer.innerHTML = `<p class="text-center text-red-500">C·∫ßn t·∫°o Index tr√™n Firebase ho·∫∑c l·ªói m·∫°ng. Xem Console ƒë·ªÉ bi·∫øt chi ti·∫øt.</p>`;
            }
        }

        // Kh·ªüi ch·∫°y khi trang t·∫£i xong
        window.addEventListener('DOMContentLoaded', () => {
            populateWorkerSelect();
            document.getElementById('reportDate').valueAsDate = new Date();
            loadReports();

            // T·ª± ƒë·ªông t·∫£i l·∫°i khi ƒë·ªïi ng√†y
            document.getElementById('reportDate').addEventListener('change', loadReports);
        });
    </script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="container mx-auto px-4 py-8 max-w-md">
        
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-blue-700 uppercase">B√°o C√°o C√¥ng Vi·ªác</h1>
            <p class="text-sm text-gray-600">T·ªï Qu·∫£n L√Ω V·∫≠n H√†nh ƒê∆∞·ªùng D√¢y</p>
            <p class="text-xs text-gray-400 mt-1">Version 1.1</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <form id="reportForm" class="space-y-4">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ng√†y b√°o c√°o</label>
                        <input type="date" id="reportDate" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nh√¢n vi√™n</label>
                        <select id="workerSelect" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm">
                            <option value="">-- Ch·ªçn t√™n --</option>
                            </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">V·ªã tr√≠ / Kho·∫£ng c·ªôt</label>
                    <input type="text" id="location" placeholder="Vd: C·ªôt 45-48, XT 471..." required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">N·ªôi dung th·ª±c hi·ªán</label>
                    <textarea id="workContent" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác..." required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>

                <div class="bg-blue-50 p-3 rounded border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-2">üõ°Ô∏è Ki·ªÉm tra an to√†n ƒë·∫ßu gi·ªù</label>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="checkPPE" class="w-4 h-4 text-blue-600 rounded">
                            <span class="text-sm text-gray-700">ƒê√£ trang b·ªã ƒë·ªß BHLƒê (M≈©, √°o, d√¢y da...)</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="checkTools" class="w-4 h-4 text-blue-600 rounded">
                            <span class="text-sm text-gray-700">D·ª•ng c·ª• thi c√¥ng ƒë·∫°t chu·∫©n</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="checkLoc" class="w-4 h-4 text-blue-600 rounded">
                            <span class="text-sm text-gray-700">ƒê√£ c√≥ Phi·∫øu c√¥ng t√°c / L·ªánh c√¥ng t√°c</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ghi ch√∫ / ƒê·ªÅ xu·∫•t</label>
                    <input type="text" id="notes" placeholder="V·∫≠t t∆∞ thi·∫øu, s·ª± c·ªë ph√°t sinh..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-200 shadow-md">
                    G·ª¨I B√ÅO C√ÅO
                </button>
            </form>
        </div>

        <div>
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">üìã Nh·∫≠t K√Ω H√¥m Nay</h2>
                <button onclick="loadReports()" class="text-sm text-blue-600 hover:underline">L√†m m·ªõi</button>
            </div>
            
            <div id="reportList" class="space-y-3">
                </div>
        </div>

    </div>

</body>
</html>
