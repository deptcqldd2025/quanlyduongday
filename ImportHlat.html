<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Auto HLAT - v1.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #0068ff; }
        body { background: #f8fafc; font-family: system-ui, sans-serif; }
        .card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <header class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-black text-blue-800 uppercase italic">Gemini Auto Import</h1>
                <p class="text-gray-500 text-sm">Tr√≠ch xu·∫•t h·ªì s∆° HLAT t·ª± ƒë·ªông b·∫±ng AI</p>
            </div>
            <div class="text-right">
                <span class="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded">API KEY ACTIVE</span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="space-y-4">
                <div class="card p-10 border-2 border-dashed border-blue-200 text-center hover:bg-blue-50 transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" class="hidden" multiple accept="image/*,application/pdf">
                    <div class="text-5xl mb-4">üì§</div>
                    <p class="font-black text-gray-700 uppercase">Ch·ªçn h·ªì s∆° HLAT</p>
                    <p class="text-xs text-gray-400 mt-2">C√≥ th·ªÉ ch·ªçn nhi·ªÅu file c√πng l√∫c (PDF/·∫¢nh)</p>
                </div>

                <div id="fileList" class="space-y-2"></div>

                <button id="btnScan" onclick="startAutoScan()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-200 hover:bg-blue-700 disabled:bg-gray-300 transition">
                    B·∫ÆT ƒê·∫¶U QU√âT B·∫∞NG AI
                </button>
            </div>

            <div class="card p-6 min-h-[400px]">
                <h3 class="font-bold text-gray-800 mb-6 uppercase italic border-b pb-2 flex justify-between">
                    Kho c√¥ng vi·ªác ch·ªù l∆∞u
                    <span id="countBox" class="text-blue-600">0</span>
                </h3>
                
                <div id="resultArea" class="space-y-4">
                    <p class="text-center text-gray-400 mt-20 italic text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i h·ªì s∆° v√† b·∫•m qu√©t.</p>
                </div>

                <button id="btnSaveAll" onclick="saveAllToPool()" class="hidden w-full bg-green-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-green-700 mt-6 transition">
                    X√ÅC NH·∫¨N L∆ØU T·∫§T C·∫¢ V√ÄO KHO
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // C·∫•u h√¨nh API c·ªßa anh
        const API_KEY = "AIzaSyCyPQUxDvVBFpAClGoS8X9mvWX72y97XMA";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        window.startAutoScan = async () => {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h·ªì s∆°!");

            const btn = document.getElementById('btnScan');
            const resultArea = document.getElementById('resultArea');
            
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> ƒêANG PH√ÇN T√çCH...`;
            resultArea.innerHTML = `<div class="text-center mt-20"><span class="loader"></span><p class="text-xs font-bold text-blue-500 mt-2">GEMINI ƒêANG ƒê·ªåC H·ªí S∆†...</p></div>`;

            try {
                // Chuy·ªÉn ƒë·ªïi files sang ƒë·ªãnh d·∫°ng Gemini hi·ªÉu
                const imageParts = await Promise.all([...files].map(fileToGenerativePart));

                const prompt = `Tr√≠ch xu·∫•t th√¥ng tin h·ªì s∆° HLAT t·ª´ c√°c file n√†y. Tr·∫£ v·ªÅ m·ªôt m·∫£ng JSON (Array). 
                M·ªói ƒë·ªëi t∆∞·ª£ng g·ªìm: don_vi_de_nghi, nguoi_lien_he, so_dien_thoai, dia_chi_cong_trinh, dt_hlat_thuc_te, dt_hlat_quy_hoach. 
                Ch·ªâ tr·∫£ v·ªÅ JSON, kh√¥ng gi·∫£i th√≠ch.`;

                const result = await model.generateContent([prompt, ...imageParts]);
                const response = await result.response;
                const text = response.text().replace(/```json|```/g, "");
                const data = JSON.parse(text);

                displayResults(data);
            } catch (error) {
                console.error(error);
                alert("L·ªói khi g·ªçi Gemini API. Anh h√£y ki·ªÉm tra l·∫°i file ho·∫∑c h·∫°n m·ª©c API.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `B·∫ÆT ƒê·∫¶U QU√âT B·∫∞NG AI`;
            }
        };

        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        }

        function displayResults(items) {
            const resultArea = document.getElementById('resultArea');
            const countBox = document.getElementById('countBox');
            const btnSave = document.getElementById('btnSaveAll');
            
            const dataArr = Array.isArray(items) ? items : [items];
            countBox.innerText = dataArr.length;
            resultArea.innerHTML = "";
            btnSave.classList.remove('hidden');

            dataArr.forEach((item, index) => {
                resultArea.innerHTML += `
                    <div class="border-2 border-blue-100 p-4 rounded-2xl bg-white shadow-sm hover:border-blue-500 transition">
                        <p class="text-[10px] font-bold text-blue-500 mb-1 uppercase">H·ªì s∆° #${index + 1}</p>
                        <h4 class="font-black text-gray-800 leading-tight">${item.don_vi_de_nghi}</h4>
                        <p class="text-[11px] text-gray-500 mt-1">${item.dia_chi_cong_trinh}</p>
                        <div class="flex gap-4 mt-3 pt-3 border-t border-dashed">
                            <div class="text-[10px]"><b>Th·ª±c t·∫ø:</b> <span class="text-red-600 font-bold">${item.dt_hlat_thuc_te}m2</span></div>
                            <div class="text-[10px]"><b>Quy ho·∫°ch:</b> <span class="text-red-600 font-bold">${item.dt_hlat_quy_hoach}m2</span></div>
                        </div>
                    </div>
                `;
            });
        }

        window.saveAllToPool = () => {
            alert("ƒê√£ l∆∞u t·∫•t c·∫£ h·ªì s∆° v√†o kho c√¥ng vi·ªác c·ªßa QLLƒê 2!");
            window.location.reload();
        };

        document.getElementById('fileInput').onchange = (e) => {
            const list = document.getElementById('fileList');
            list.innerHTML = "";
            [...e.target.files].forEach(f => {
                list.innerHTML += `<div class="text-[10px] bg-blue-100 text-blue-700 p-2 rounded-lg font-bold">üìÑ ${f.name}</div>`;
            });
        };
    </script>
</body>
</html>
