<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản Trị - Admin v1.90</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-tab { cursor: pointer; padding: 12px 20px; font-weight: 700; color: #64748B; border-bottom: 3px solid transparent; transition: 0.3s; white-space: nowrap; font-size: 13px; }
        .admin-tab:hover { background-color: #F8FAFC; }
        .admin-tab.active { color: #1A479A; border-bottom-color: #1A479A; background-color: #EFF6FF; }
        .table-header { background: #F1F5F9; color: #475569; font-size: 11px; text-transform: uppercase; font-weight: 800; }
        .table-row { border-bottom: 1px solid #E2E8F0; transition: 0.2s; }
        .table-row:hover { background: #F8FAFC; }
        .td-cell { padding: 12px; font-size: 12px; color: #334155; vertical-align: middle; }
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; }
        #auth-loading { position: fixed; inset: 0; background: #F4F7FA; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-[#F4F7FA] pb-10">

    <div id="auth-loading">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mb-4"></div>
        <p class="text-xs font-bold text-slate-500 uppercase">Đang xác thực quyền Admin...</p>
    </div>

    <div id="admin-main-content" class="hidden">
        <div id="sidebar-container"></div>

        <div class="evn-header">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fa fa-bars text-2xl cursor-pointer mr-4 lg:hidden" onclick="toggleSidebar()"></i>
                    <h1 class="font-black text-xl italic uppercase leading-none">Hệ thống quản trị</h1>
                </div>
                <div class="flex flex-col items-end">
                    <div class="text-[10px] bg-white/20 px-3 py-1 rounded-full font-bold">SUPER ADMIN</div>
                    <span id="current-admin-name" class="text-[9px] mt-1 opacity-80">...</span>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto px-4 mt-6">
            <div class="bg-white rounded-t-2xl shadow-sm border-b border-slate-200 flex overflow-x-auto no-scrollbar">
                <div class="admin-tab active" onclick="switchTab(event, 'reports')"><i class="fa fa-file-alt mr-2"></i>Báo cáo</div>
                <div class="admin-tab" onclick="switchTab(event, 'notifications')"><i class="fa fa-history mr-2"></i>Lịch sử TB</div>
                <div class="admin-tab" onclick="switchTab(event, 'tasks')"><i class="fa fa-history mr-2"></i>Lịch sử Việc</div>
                <div class="admin-tab" onclick="switchTab(event, 'users')"><i class="fa fa-users mr-2"></i>Nhân sự</div>
                <div class="admin-tab text-red-600" onclick="switchTab(event, 'create-notify')"><i class="fa fa-bullhorn mr-2"></i>Soạn Thông báo</div>
                <div class="admin-tab text-green-600" onclick="switchTab(event, 'create-task')"><i class="fa fa-plus-circle mr-2"></i>Giao Việc Mới</div>
            </div>

            <div class="bg-white rounded-b-2xl shadow-lg min-h-[500px] p-4 overflow-x-auto">
                
                <div id="tab-reports" class="tab-content">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-black text-blue-900 text-sm uppercase">Dữ liệu báo cáo ngày</h3><button onclick="loadReports()" class="text-xs bg-slate-100 p-2 rounded hover:bg-slate-200"><i class="fa fa-sync"></i></button></div>
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead><tr class="table-header"><th class="p-3">Thời gian</th><th class="p-3">Nhân viên</th><th class="p-3">Loại</th><th class="p-3 w-1/3">Nội dung</th><th class="p-3 text-center">File</th><th class="p-3 text-center">Xóa</th></tr></thead>
                        <tbody id="tbody-reports"></tbody>
                    </table>
                </div>

                <div id="tab-users" class="tab-content hidden">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="font-black text-blue-900 text-sm uppercase">Quản lý nhân viên</h3>
                        
                        <div class="flex gap-2 w-full md:w-auto">
                            <div class="relative flex-1">
                                <i class="fa fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                                <input type="text" id="user-search" onkeyup="filterUsers()" placeholder="Tìm tên, email..." class="pl-8 pr-3 py-2 border rounded-lg text-xs font-bold w-full md:w-64 focus:border-blue-500 outline-none">
                            </div>
                            <select id="user-filter" onchange="filterUsers()" class="border rounded-lg px-3 py-2 text-xs font-bold text-slate-600 outline-none">
                                <option value="all">Tất cả</option>
                                <option value="pending">Chờ duyệt</option>
                                <option value="approved">Hoạt động</option>
                                <option value="blocked">Đã khóa</option>
                            </select>
                            <button onclick="loadUsers()" class="bg-slate-100 p-2 rounded-lg hover:bg-slate-200"><i class="fa fa-sync text-slate-600"></i></button>
                        </div>
                    </div>

                    <table class="w-full text-left border-collapse min-w-[900px]">
                        <thead>
                            <tr class="table-header">
                                <th class="p-3">Thông tin</th>
                                <th class="p-3 text-center">Trạng thái</th>
                                <th class="p-3">Chức vụ (Sửa)</th>
                                <th class="p-3">Đơn vị (Sửa)</th>
                                <th class="p-3 text-center">Cập nhật</th>
                                <th class="p-3 text-center">Quyền</th>
                                <th class="p-3 text-center">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-users"></tbody>
                    </table>
                </div>

                <div id="tab-notifications" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-black text-blue-900 text-sm uppercase">Lịch sử thông báo</h3><button onclick="loadNoti()" class="text-xs bg-slate-100 p-2 rounded hover:bg-slate-200"><i class="fa fa-sync"></i></button></div>
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead><tr class="table-header"><th class="p-3">Ngày gửi</th><th class="p-3">Tiêu đề</th><th class="p-3">Người gửi</th><th class="p-3">Nội dung</th><th class="p-3 text-center">File</th><th class="p-3 text-center">Đã xem</th><th class="p-3 text-center">Xóa</th></tr></thead>
                        <tbody id="tbody-notifications"></tbody>
                    </table>
                </div>

                <div id="tab-tasks" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-black text-blue-900 text-sm uppercase">Theo dõi giao việc</h3><button onclick="loadTasks()" class="text-xs bg-slate-100 p-2 rounded hover:bg-slate-200"><i class="fa fa-sync"></i></button></div>
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead><tr class="table-header"><th class="p-3">Ngày giao</th><th class="p-3">Hạn chót</th><th class="p-3">Tên việc</th><th class="p-3">Người làm</th><th class="p-3">Trạng thái</th><th class="p-3 text-center">File</th><th class="p-3 text-center">Xóa</th></tr></thead>
                        <tbody id="tbody-tasks"></tbody>
                    </table>
                </div>

                <div id="tab-create-notify" class="tab-content hidden">
                    <div class="max-w-2xl mx-auto space-y-4">
                        <h3 class="font-black text-blue-900 text-sm uppercase border-l-4 border-red-500 pl-3">Soạn thông báo</h3>
                        <input type="text" id="nt-title" class="input-evn" placeholder="Tiêu đề...">
                        <select id="nt-priority" class="input-evn"><option value="normal">Thông thường</option><option value="urgent">Khẩn cấp ⚡</option><option value="warning">An toàn ⚠️</option></select>
                        <textarea id="nt-content" rows="5" class="input-evn" placeholder="Nội dung..."></textarea>
                        <div id="nt-file-list" class="space-y-2"></div>
                        <div class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer" onclick="document.getElementById('nt-file-in').click()"><input type="file" id="nt-file-in" class="hidden" multiple><div class="text-[11px] font-bold text-blue-500">+ File</div></div>
                        <button onclick="sendNotificationAdmin()" id="btn-send-nt" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg">PHÁT HÀNH</button>
                    </div>
                </div>

                <div id="tab-create-task" class="tab-content hidden">
                    <div class="max-w-2xl mx-auto space-y-4">
                        <h3 class="font-black text-blue-900 text-sm uppercase border-l-4 border-green-500 pl-3">Giao việc mới</h3>
                        <input type="text" id="task-name" class="input-evn" placeholder="Tên công việc...">
                        <select id="task-assignee" class="input-evn"><option>Đang tải...</option></select>
                        <textarea id="task-desc" rows="4" class="input-evn" placeholder="Mô tả..."></textarea>
                        <input type="date" id="task-deadline" class="input-evn">
                        <div id="task-file-list" class="space-y-2"></div>
                        <div class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer" onclick="document.getElementById('task-file-in').click()"><input type="file" id="task-file-in" class="hidden" multiple><div class="text-[11px] font-bold text-blue-500">+ File</div></div>
                        <button onclick="assignTaskAdmin()" id="btn-send-task" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg">GIAO VIỆC</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="detailModal" class="modal"><div class="modal-content relative"><span class="absolute top-2 right-4 text-2xl font-bold cursor-pointer text-slate-400 hover:text-red-500" onclick="closeModal()">&times;</span><h2 id="modal-title" class="font-black text-lg text-blue-900 mb-4 border-b pb-2">Chi tiết</h2><div id="modal-body" class="text-sm text-slate-700 leading-relaxed"></div></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M", authDomain: "baocaongay-e73a2.firebaseapp.com", projectId: "baocaongay-e73a2", storageBucket: "baocaongay-e73a2.firebasestorage.app", messagingSenderId: "75165392007", appId: "1:75165392007:web:4ec22bb1612108b096ac22", measurementId: "G-TEGTD9KFCW" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); const auth = firebase.auth();
        const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbwanzWLo8PhCuOnTGrP-Ra_5rbYvkCgdgbIr-gSPMxbsXJ-5creXdid0_GYQM6AufT4rA/exec";
        
        let currentUser = null, notifyFiles = [], taskFiles = [], allUsersData = [];

        fetch('sidebar.html').then(r=>r.text()).then(d=>{ document.getElementById('sidebar-container').innerHTML=d; });

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const doc = await db.collection("users").doc(user.email).get();
                    if(doc.exists && ["Tổ phó","Tổ trưởng","Đội phó","Đội trưởng","Lãnh đạo"].includes(doc.data().position)) {
                        currentUser = user;
                        document.getElementById('current-admin-name').innerText = user.displayName;
                        document.getElementById('auth-loading').classList.add('hidden');
                        document.getElementById('admin-main-content').classList.remove('hidden');
                        loadReports(); 
                    } else { alert("Không có quyền Admin!"); window.location.href="index.html"; }
                } catch(e) { window.location.href="index.html"; }
            } else { window.location.href="index.html"; }
        });

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            if(event) event.currentTarget.classList.add('active');
            
            if(tabName === 'reports') loadReports();
            if(tabName === 'users') loadUsers();
            if(tabName === 'notifications') loadNoti();
            if(tabName === 'tasks') loadTasks();
            if(tabName === 'create-task') loadStaffForAssign();
        }

        // --- USER MANAGEMENT (NEW) ---
        async function loadUsers() {
            const tbody = document.getElementById('tbody-users');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Đang tải...</td></tr>';
            try {
                // Lấy tất cả user một lần, sau đó lưu vào biến toàn cục để filter client-side cho nhanh
                const snap = await db.collection("users").orderBy("status", "desc").get();
                allUsersData = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
                
                // Render lần đầu
                filterUsers();
            } catch(e) { console.error(e); tbody.innerHTML = '<tr><td colspan="7" class="text-center text-red-500 p-4">Lỗi tải dữ liệu</td></tr>'; }
        }

        function filterUsers() {
            const search = document.getElementById('user-search').value.toLowerCase();
            const filter = document.getElementById('user-filter').value;
            const tbody = document.getElementById('tbody-users');

            const filtered = allUsersData.filter(u => {
                const matchSearch = (u.name || '').toLowerCase().includes(search) || (u.email || '').toLowerCase().includes(search);
                const matchFilter = filter === 'all' ? true : (filter === 'approved' ? (u.status === 'approved' || !u.status) : u.status === filter);
                return matchSearch && matchFilter;
            });

            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-slate-400">Không tìm thấy nhân sự nào</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(d => {
                const isPending = d.status === 'pending';
                const isBlocked = d.status === 'blocked';
                
                let statusHtml = `<span class="bg-green-100 text-green-600 px-2 py-1 rounded text-[9px] font-bold uppercase">Hoạt động</span>`;
                if(isPending) statusHtml = `<span class="bg-orange-100 text-orange-600 px-2 py-1 rounded text-[9px] font-black uppercase animate-pulse">Chờ duyệt</span>`;
                if(isBlocked) statusHtml = `<span class="bg-red-100 text-red-600 px-2 py-1 rounded text-[9px] font-bold uppercase">Đã khóa</span>`;

                // Nút Hành động Quyền (Duyệt / Khóa / Mở)
                let actionBtn = "";
                if(isPending) {
                    actionBtn = `<button onclick="setUserStatus('${d.id}', 'approved')" class="bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold shadow hover:bg-green-700 w-full mb-1"><i class="fa fa-check mr-1"></i> DUYỆT</button>`;
                } else if(isBlocked) {
                    actionBtn = `<button onclick="setUserStatus('${d.id}', 'approved')" class="bg-slate-500 text-white px-3 py-1 rounded text-[10px] font-bold shadow hover:bg-slate-600 w-full mb-1"><i class="fa fa-unlock mr-1"></i> MỞ KHÓA</button>`;
                } else {
                    actionBtn = `<button onclick="setUserStatus('${d.id}', 'blocked')" class="bg-yellow-500 text-white px-3 py-1 rounded text-[10px] font-bold shadow hover:bg-yellow-600 w-full mb-1"><i class="fa fa-lock mr-1"></i> KHÓA</button>`;
                }

                return `
                <tr class="table-row ${isPending ? 'bg-orange-50/50' : (isBlocked ? 'bg-red-50/30' : '')}">
                    <td class="td-cell">
                        <div class="font-bold text-blue-900">${d.name || 'Chưa cập nhật'}</div>
                        <div class="text-[10px] text-slate-500">${d.email}</div>
                        <div class="text-[9px] text-slate-400 mt-1">${d.phone || ''}</div>
                    </td>
                    <td class="td-cell text-center">${statusHtml}</td>
                    <td class="td-cell">
                        <select id="role-${d.id}" class="border rounded p-1 text-[11px] font-bold bg-white w-full">
                            <option value="Công nhân" ${d.position=='Công nhân'?'selected':''}>Công nhân</option>
                            <option value="Kỹ thuật viên" ${d.position=='Kỹ thuật viên'?'selected':''}>Kỹ thuật viên</option>
                            <option value="Tổ phó" ${d.position=='Tổ phó'?'selected':''}>Tổ phó</option>
                            <option value="Tổ trưởng" ${d.position=='Tổ trưởng'?'selected':''}>Tổ trưởng</option>
                            <option value="Đội phó" ${d.position=='Đội phó'?'selected':''}>Đội phó</option>
                            <option value="Đội trưởng" ${d.position=='Đội trưởng'?'selected':''}>Đội trưởng</option>
                            <option value="Lãnh đạo" ${d.position=='Lãnh đạo'?'selected':''}>Lãnh đạo</option>
                        </select>
                    </td>
                    <td class="td-cell">
                        <select id="unit-${d.id}" class="border rounded p-1 text-[11px] font-bold bg-white w-full">
                            <option value="Nhóm 1" ${d.unit=='Nhóm 1'?'selected':''}>Nhóm 1</option>
                            <option value="Nhóm 2" ${d.unit=='Nhóm 2'?'selected':''}>Nhóm 2</option>
                            <option value="Nhóm 3" ${d.unit=='Nhóm 3'?'selected':''}>Nhóm 3</option>
                            <option value="Nhóm 4" ${d.unit=='Nhóm 4'?'selected':''}>Nhóm 4</option>
                            <option value="Nhóm kỹ thuật" ${d.unit=='Nhóm kỹ thuật'?'selected':''}>Nhóm kỹ thuật</option>
                            <option value="Văn phòng đội" ${d.unit=='Văn phòng đội'?'selected':''}>Văn phòng đội</option>
                        </select>
                    </td>
                    <td class="td-cell text-center">
                        <button onclick="updateUserInfo('${d.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold hover:bg-blue-700 w-full">Lưu Info</button>
                    </td>
                    <td class="td-cell text-center">${actionBtn}</td>
                    <td class="td-cell text-center"><i class="fa fa-trash text-red-400 cursor-pointer text-lg" onclick="deleteItem('users','${d.id}')"></i></td>
                </tr>`;
            }).join('');
        }

        async function updateUserInfo(id) {
            const role = document.getElementById(`role-${id}`).value;
            const unit = document.getElementById(`unit-${id}`).value;
            if(confirm("Cập nhật thông tin cho user này?")) {
                await db.collection("users").doc(id).update({ position: role, unit: unit });
                alert("Đã lưu thông tin!"); loadUsers();
            }
        }

        async function setUserStatus(id, status) {
            const action = status === 'approved' ? 'DUYỆT / MỞ KHÓA' : 'KHÓA';
            if(confirm(`Bạn có chắc muốn ${action} tài khoản này?`)) {
                await db.collection("users").doc(id).update({ status: status });
                loadUsers();
            }
        }

        // --- CÁC HÀM KHÁC (GIỮ NGUYÊN) ---
        function renderFileIcons(files) { return (files&&files.length)?`<i class="fa fa-paperclip text-blue-500"></i> ${files.length}`:'-'; }
        async function deleteItem(col, id) {
            if(confirm("Xóa vĩnh viễn dữ liệu này?")) {
                await db.collection(col).doc(id).delete();
                alert("Đã xóa!"); 
                if(col==='users') loadUsers(); else if(col==='daily_reports') loadReports(); else if(col==='notifications') loadNoti(); else loadTasks();
            }
        }
        
        async function loadReports() { const tbody=document.getElementById('tbody-reports'); tbody.innerHTML='<tr><td colspan="6">Đang tải...</td></tr>'; const s=await db.collection("daily_reports").orderBy("timestamp","desc").limit(50).get(); tbody.innerHTML=s.docs.map(d=>`<tr class="table-row"><td class="td-cell">${d.data().date}</td><td class="td-cell font-bold">${d.data().worker}</td><td class="td-cell">${d.data().reportType}</td><td class="td-cell truncate max-w-xs">${d.data().content}</td><td class="td-cell text-center">${renderFileIcons(d.data().files)}</td><td class="td-cell text-center"><i class="fa fa-trash text-red-400 cursor-pointer" onclick="deleteItem('daily_reports','${d.id}')"></i></td></tr>`).join(''); }
        
        async function loadNoti() { const s=await db.collection("notifications").orderBy("timestamp","desc").limit(30).get(); document.getElementById('tbody-notifications').innerHTML=s.docs.map(d=>`<tr class="table-row"><td class="td-cell">${d.data().date}</td><td class="td-cell font-bold">${d.data().title}</td><td class="td-cell">${d.data().sender}</td><td class="td-cell truncate max-w-xs">${d.data().content}</td><td class="td-cell text-center">${renderFileIcons(d.data().files)}</td><td class="td-cell text-center">${d.data().read_by?d.data().read_by.length:0}</td><td class="td-cell text-center"><i class="fa fa-trash text-red-400 cursor-pointer" onclick="deleteItem('notifications','${d.id}')"></i></td></tr>`).join(''); }
        
        async function loadTasks() { const s=await db.collection("tasks").orderBy("created_at","desc").limit(50).get(); document.getElementById('tbody-tasks').innerHTML=s.docs.map(d=>`<tr class="table-row"><td class="td-cell">${new Date(d.data().created_at.seconds*1000).toLocaleDateString('vi-VN')}</td><td class="td-cell text-red-500 font-bold">${d.data().deadline}</td><td class="td-cell font-bold">${d.data().don_vi_de_nghi}</td><td class="td-cell">${d.data().assigned_leader}</td><td class="td-cell">${d.data().accepted_at?'Đã nhận':'Chưa'}</td><td class="td-cell text-center">${renderFileIcons(d.data().files)}</td><td class="td-cell text-center"><i class="fa fa-trash text-red-400 cursor-pointer" onclick="deleteItem('tasks','${d.id}')"></i></td></tr>`).join(''); }

        function setupFileHandler(inputId, listId, storageArr) { document.getElementById(inputId).onchange=(e)=>{ Array.from(e.target.files).forEach(f=>{ const r=new FileReader(); r.onload=(v)=>{ storageArr.push({name:f.name,type:f.type,data:v.target.result.split(',')[1]}); document.getElementById(listId).innerHTML=storageArr.map((f,i)=>`<div class="text-xs"><i class="fa fa-file"></i> ${f.name} <i class="fa fa-times text-red-500 cursor-pointer" onclick="removeFile('${listId}',${i})"></i></div>`).join(''); }; r.readAsDataURL(f); }); }; }
        window.removeFile=(lid,i)=>{ if(lid.includes('nt')) notifyFiles.splice(i,1); else taskFiles.splice(i,1); document.getElementById(lid).innerHTML=""; } /* Note: Simplified remove logic for demo */
        setupFileHandler('nt-file-in','nt-file-list',notifyFiles); setupFileHandler('task-file-in','task-file-list',taskFiles);

        window.sendNotificationAdmin = async () => { const t=document.getElementById('nt-title').value, c=document.getElementById('nt-content').value; if(!t||!c)return alert("Thiếu thông tin"); if(notifyFiles.length) fetch(APPSCRIPT_URL,{method:"POST",mode:"no-cors",body:JSON.stringify({files:notifyFiles,user:currentUser.email})}); await db.collection("notifications").add({title:t,content:c,priority:document.getElementById('nt-priority').value,sender:currentUser.displayName,files:notifyFiles.map(f=>({name:f.name})),read_by:[],date:new Date().toLocaleDateString('vi-VN'),timestamp:firebase.firestore.FieldValue.serverTimestamp()}); alert("Đã gửi"); notifyFiles=[]; switchTab(null,'notifications'); }
        window.assignTaskAdmin = async () => { const n=document.getElementById('task-name').value; if(!n)return alert("Thiếu tên"); if(taskFiles.length) fetch(APPSCRIPT_URL,{method:"POST",mode:"no-cors",body:JSON.stringify({files:taskFiles,user:currentUser.email})}); await db.collection("tasks").add({don_vi_de_nghi:n,description:document.getElementById('task-desc').value,assigned_leader:document.getElementById('task-assignee').value,deadline:document.getElementById('task-deadline').value,status:"assigned",sender:currentUser.displayName,files:taskFiles.map(f=>({name:f.name})),accepted_at:null,created_at:firebase.firestore.FieldValue.serverTimestamp()}); alert("Đã giao"); taskFiles=[]; switchTab(null,'tasks'); }
        async function loadStaffForAssign(){ const s=await db.collection("users").get(); document.getElementById('task-assignee').innerHTML=s.docs.map(d=>`<option value="${d.data().name}">${d.data().name} (${d.data().position})</option>`).join(''); }

        function showModal(title, content) { document.getElementById('modal-title').innerText=title; document.getElementById('modal-body').innerHTML=content; document.getElementById('detailModal').style.display="block"; }
        function closeModal() { document.getElementById('detailModal').style.display="none"; }
        window.onclick = function(e) { if(e.target==document.getElementById('detailModal')) closeModal(); }
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.menuAction = (a) => window.location.href="index.html";
        window.handleLogout = () => confirm("Đăng xuất?") && auth.signOut().then(()=>window.location.href='index.html');
    </script>
</body>
</html>
