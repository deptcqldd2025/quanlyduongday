<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng ƒêi·ªÅu h√†nh QLLƒê 2 - v21.12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root { --primary: #0068ff; }
        body { background: #f1f5f9; font-family: system-ui, sans-serif; }
        .tab-btn { padding: 12px 24px; font-weight: 800; font-size: 13px; text-transform: uppercase; color: #94a3b8; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #f8faff; }
        .card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; }
        .hidden { display: none; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="bg-white rounded-3xl shadow-sm border mb-8 overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black text-slate-800 uppercase italic">ƒêi·ªÅu h√†nh QLLƒê 2</h1>
                    <p id="connection-status" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest italic">ƒêang k·∫øt n·ªëi Firebase...</p>
                </div>
            </div>
            <nav class="flex bg-slate-50/50">
                <button onclick="switchTab('khoviec')" id="btn-khoviec" class="tab-btn flex-1 active">Kho vi·ªác & Ph√¢n c√¥ng</button>
                <button onclick="switchTab('nhansu')" id="btn-nhansu" class="tab-btn flex-1">Nh√¢n s·ª± (t·ª´ Index)</button>
            </nav>
        </header>

        <section id="tab-khoviec-content" class="space-y-6">
            <div id="workGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 italic text-slate-400">
                ƒêang t·∫£i danh s√°ch c√¥ng vi·ªác...
            </div>
        </section>

        <section id="tab-nhansu-content" class="hidden space-y-6 text-center">
            <div id="staffGrid" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                </div>
        </section>
    </div>

    <div id="assignModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-lg font-black text-slate-800 uppercase italic mb-1">Giao vi·ªác cho t·ªï</h3>
            <p id="modalTaskName" class="text-xs font-bold text-blue-600 mb-6 pb-4 border-b"></p>
            
            <form class="space-y-6">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-2 tracking-tighter">Nh√≥m tr∆∞·ªüng ch·ªãu tr√°ch nhi·ªám</label>
                    <select id="selectMain" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-700 outline-none focus:border-blue-500">
                        </select>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-2 tracking-tighter">Nh√≥m vi√™n ph·ªëi h·ª£p</label>
                    <div id="checkSupport" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto pr-2">
                        </div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-400 text-xs">H·ª¶Y</button>
                    <button type="button" onclick="confirmAssign()" class="flex-[2] bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-200 uppercase text-xs">X√°c nh·∫≠n giao</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh Firebase c·ªßa anh
        const firebaseConfig = {
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
            authDomain: "tavietnam-78ae8.firebaseapp.com",
            projectId: "tavietnam-78ae8",
            storageBucket: "tavietnam-78ae8.firebasestorage.app",
            messagingSenderId: "670121705534",
            appId: "1:670121705534:web:1027ad98550573ad37116f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let staffList = []; // Ch·ª©a danh s√°ch c√¥ng nh√¢n l·∫•y t·ª´ Firebase

        // 1. L·∫§Y D·ªÆ LI·ªÜU NH√ÇN S·ª∞ T·ª™ COLLECTION 'users' (Gi·∫£ ƒë·ªãnh trang Index l∆∞u v√†o ƒë√¢y)
        async function fetchStaff() {
            try {
                const snapshot = await db.collection("users").get();
                staffList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    staffList.push({ id: doc.id, name: data.name || data.displayName, rank: data.rank || "B·∫≠c th·ª£" });
                });
                document.getElementById('connection-status').innerText = `‚úÖ ƒê√£ k·∫øt n·ªëi: ${staffList.length} nh√¢n s·ª±`;
                updateStaffUI();
            } catch (error) {
                console.error("L·ªói l·∫•y nh√¢n s·ª±:", error);
                document.getElementById('connection-status').innerText = "‚ùå L·ªói k·∫øt n·ªëi Firebase";
            }
        }

        function updateStaffUI() {
            const grid = document.getElementById('staffGrid');
            grid.innerHTML = staffList.map(s => `
                <div class="card p-4 flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center font-black text-blue-600 text-xs">${s.name.charAt(0)}</div>
                    <div class="text-left">
                        <h4 class="text-[10px] font-black text-slate-800 uppercase">${s.name}</h4>
                        <p class="text-[8px] text-slate-400 font-bold">${s.rank}</p>
                    </div>
                </div>
            `).join('');
        }

        // 2. L·∫§Y D·ªÆ LI·ªÜU C√îNG VI·ªÜC T·ª™ COLLECTION 'tasks'
        async function fetchTasks() {
            const grid = document.getElementById('workGrid');
            try {
                const snapshot = await db.collection("tasks").where("status", "==", "new").get();
                if (snapshot.empty) {
                    grid.innerHTML = '<p class="col-span-full text-center py-10">Kho vi·ªác tr·ªëng.</p>';
                    return;
                }
                grid.innerHTML = "";
                snapshot.forEach(doc => {
                    const w = doc.data();
                    grid.innerHTML += `
                        <div class="card p-5 flex flex-col h-full bg-white">
                            <h4 class="font-black text-slate-800 text-[13px] mb-1 uppercase">${w.don_vi_de_nghi || 'H·ªì s∆° HLAT'}</h4>
                            <p class="text-[10px] text-slate-500 mb-4 italic">üìç ${w.dia_chi_cong_trinh || 'N/A'}</p>
                            <div class="grid grid-cols-2 gap-2 bg-slate-50 p-3 rounded-2xl border mb-5">
                                <div class="text-center"><span class="block text-[8px] font-bold text-slate-400 uppercase italic">Th·ª±c t·∫ø</span><span class="text-[11px] font-black text-red-600">${w.dt_hlat_thuc_te} m¬≤</span></div>
                                <div class="text-center border-l"><span class="block text-[8px] font-bold text-slate-400 uppercase italic">Quy ho·∫°ch</span><span class="text-[11px] font-black text-red-600">${w.dt_hlat_quy_hoach} m¬≤</span></div>
                            </div>
                            <button onclick="openAssignModal('${doc.id}', '${w.don_vi_de_nghi}')" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg uppercase text-[10px] mt-auto">Ph√¢n c√¥ng t·ªï</button>
                        </div>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        // 3. ƒêI·ªÄU KHI·ªÇN MODAL & PH√ÇN C√îNG
        let currentTaskId = "";
        function openAssignModal(id, name) {
            currentTaskId = id;
            document.getElementById('modalTaskName').innerText = name;
            
            // N·∫°p c√¥ng nh√¢n v√†o Modal
            const mainSelect = document.getElementById('selectMain');
            const supportCheck = document.getElementById('checkSupport');
            
            mainSelect.innerHTML = '<option value="">-- Ch·ªçn Tr∆∞·ªüng nh√≥m --</option>' + 
                staffList.map(s => `<option value="${s.name}">${s.name} (${s.rank})</option>`).join('');
            
            supportCheck.innerHTML = staffList.map(s => `
                <label class="flex items-center p-2 bg-slate-50 border rounded-lg cursor-pointer">
                    <input type="checkbox" name="support" value="${s.name}" class="mr-2"> <span class="text-[10px] font-bold text-slate-600">${s.name}</span>
                </label>
            `).join('');

            document.getElementById('assignModal').classList.remove('hidden');
        }

        async function confirmAssign() {
            const leader = document.getElementById('selectMain').value;
            const supporters = Array.from(document.querySelectorAll('input[name="support"]:checked')).map(el => el.value);

            if (!leader) return alert("Vui l√≤ng ch·ªçn Nh√≥m tr∆∞·ªüng!");

            try {
                await db.collection("tasks").doc(currentTaskId).update({
                    status: "assigned",
                    assigned_leader: leader,
                    assigned_team: supporters,
                    assigned_at: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`ƒê√£ giao h·ªì s∆° cho ${leader} v√† nh√≥m ph·ªëi h·ª£p!`);
                closeModal();
                fetchTasks();
            } catch (e) { alert("L·ªói ph√¢n c√¥ng: " + e.message); }
        }

        function switchTab(tab) {
            document.getElementById('tab-nhansu-content').classList.toggle('hidden', tab !== 'nhansu');
            document.getElementById('tab-khoviec-content').classList.toggle('hidden', tab !== 'khoviec');
            document.getElementById('btn-nhansu').classList.toggle('active', tab === 'nhansu');
            document.getElementById('btn-khoviec').classList.toggle('active', tab === 'khoviec');
        }

        function closeModal() { document.getElementById('assignModal').classList.add('hidden'); }

        // Kh·ªüi ch·∫°y ƒë·ªìng b·ªô
        fetchStaff();
        fetchTasks();
    </script>
</body>
</html>
