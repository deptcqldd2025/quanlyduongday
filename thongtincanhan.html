<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông tin cá nhân - Fix lỗi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="pb-16 bg-[#F4F7FA]">

    <div id="sidebar-container"></div>

    <div class="evn-header">
        <div class="max-w-md mx-auto flex items-center">
            <i class="fa fa-bars text-2xl cursor-pointer mr-4" onclick="toggleSidebar()"></i>
            <h1 class="font-black text-lg italic uppercase leading-none">Hồ sơ nhân sự</h1>
        </div>
    </div>

    <div class="max-w-md mx-auto px-6 -mt-8 space-y-6">
        <div class="bg-white p-6 rounded-[30px] shadow-xl border border-slate-50 flex flex-col items-center relative">
            <div class="w-24 h-24 bg-blue-50 rounded-full p-1 mb-3 relative">
                <img id="profile-img" src="https://img.icons8.com/fluency/96/user-male-circle.png" class="w-full h-full rounded-full object-cover shadow-sm">
            </div>
            <h2 id="display-name" class="font-black text-xl text-[#1A479A] uppercase text-center">Đang tải...</h2>
            <p id="display-email" class="text-xs text-slate-400 font-bold mb-4">...</p>
            <div class="flex gap-2">
                <span id="role-badge" class="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-[10px] font-black uppercase">...</span>
                <span id="unit-badge" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-[10px] font-black uppercase">...</span>
            </div>
        </div>

        <section class="bg-white p-6 rounded-[30px] shadow-lg border border-slate-50 space-y-4">
            <div class="flex justify-between items-center border-b pb-2 mb-2">
                <h3 class="text-[11px] font-black text-slate-800 uppercase tracking-widest border-l-4 border-blue-700 pl-2">Thông tin chi tiết</h3>
                <i class="fa fa-pen text-blue-600 cursor-pointer p-2 hover:bg-blue-50 rounded-full transition" onclick="enableEdit()"></i>
            </div>
            
            <div>
                <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Họ và tên</label>
                <input type="text" id="inp-name" class="input-evn font-bold text-[#1A479A]" disabled>
            </div>

            <div>
                <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Số điện thoại</label>
                <input type="tel" id="inp-phone" class="input-evn font-bold" placeholder="Cập nhật SĐT..." disabled>
            </div>

            <div>
                <div class="flex justify-between ml-2">
                    <label class="text-[9px] font-black text-slate-400 uppercase">Chức vụ</label>
                    <i class="fa fa-lock text-[10px] text-slate-300"></i>
                </div>
                <select id="inp-position" class="input-evn select-evn font-bold bg-slate-100 text-slate-500 cursor-not-allowed" disabled>
                    <option value="Công nhân">Công nhân</option>
                    <option value="Kỹ thuật viên">Kỹ thuật viên</option>
                    <option value="Tổ phó">Tổ phó</option>
                    <option value="Tổ trưởng">Tổ trưởng</option>
                    <option value="Đội phó">Đội phó</option>
                    <option value="Đội trưởng">Đội trưởng</option>
                    <option value="Lãnh đạo">Lãnh đạo</option>
                </select>
            </div>

            <div>
                <div class="flex justify-between ml-2">
                    <label class="text-[9px] font-black text-slate-400 uppercase">Đơn vị công tác</label>
                    <i class="fa fa-lock text-[10px] text-slate-300"></i>
                </div>
                <select id="inp-unit" class="input-evn select-evn font-bold bg-slate-100 text-slate-500 cursor-not-allowed" disabled>
                    <option value="Nhóm 1">Nhóm 1</option>
                    <option value="Nhóm 2">Nhóm 2</option>
                    <option value="Nhóm 3">Nhóm 3</option>
                    <option value="Nhóm 4">Nhóm 4</option>
                    <option value="Nhóm kỹ thuật">Nhóm kỹ thuật</option>
                    <option value="Văn phòng đội">Văn phòng đội</option>
                </select>
            </div>

            <p class="text-[9px] text-red-400 italic text-center mt-2 hidden" id="admin-note">* Liên hệ Admin để thay đổi Chức vụ/Đơn vị</p>

            <button onclick="saveProfile()" id="btn-save" class="w-full bg-[#1A479A] text-white font-black py-4 rounded-[18px] shadow-lg uppercase text-[11px] tracking-widest hidden active:scale-95 transition">
                Lưu thay đổi
            </button>
        </section>
    </div>

    <div class="footer-evn"><p>Hệ thống quản lý nhân sự - Fix Loading</p></div>

    <script>
        // CẤU HÌNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M",
            authDomain: "baocaongay-e73a2.firebaseapp.com",
            projectId: "baocaongay-e73a2",
            storageBucket: "baocaongay-e73a2.firebasestorage.app",
            messagingSenderId: "75165392007",
            appId: "1:75165392007:web:4ec22bb1612108b096ac22",
            measurementId: "G-TEGTD9KFCW"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = null;

        // TẢI SIDEBAR
        fetch('sidebar.html').then(r=>r.text()).then(d=>{
            document.getElementById('sidebar-container').innerHTML=d;
            if(currentUser) updateSidebarInfo(currentUser);
            highlightActiveMenu();
        });

        // AUTH & LOAD DATA
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                // Điền thông tin cơ bản ngay lập tức
                document.getElementById('display-email').innerText = user.email;
                if(user.photoURL) document.getElementById('profile-img').src = user.photoURL;
                
                updateSidebarInfo(user);
                checkManagerRoleForSidebar(user.email);
                
                // Bắt đầu tải dữ liệu chi tiết
                loadUserProfile(user);
            } else {
                window.location.href = "index.html";
            }
        });

        // HÀM TẢI DỮ LIỆU - CÓ XỬ LÝ LỖI TREO
        async function loadUserProfile(user) {
            try {
                // Thử đọc từ Database
                const doc = await db.collection("users").doc(user.email).get();
                
                if (doc.exists) {
                    // TRƯỜNG HỢP 1: ĐÃ CÓ DỮ LIỆU
                    const data = doc.data();
                    fillFormData(data.name || user.displayName, data.phone, data.position, data.unit);
                } else {
                    // TRƯỜNG HỢP 2: CHƯA CÓ DỮ LIỆU (USER MỚI)
                    // -> Tự động tạo dữ liệu mặc định để lần sau không bị lỗi
                    console.log("User mới, đang khởi tạo hồ sơ mặc định...");
                    const defaultData = {
                        name: user.displayName,
                        phone: "",
                        position: "Công nhân",
                        unit: "Nhóm 1",
                        email: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Ghi vào DB
                    await db.collection("users").doc(user.email).set(defaultData);
                    
                    // Hiển thị lên màn hình
                    fillFormData(user.displayName, "", "Công nhân", "Nhóm 1");
                }
            } catch (e) {
                console.error("Lỗi:", e);
                // Nếu lỗi mạng hoặc quyền, vẫn hiển thị thông tin cơ bản từ Google để không bị treo
                fillFormData(user.displayName, "", "Công nhân", "Nhóm 1");
                if(e.code === 'permission-denied') {
                    alert("Cảnh báo: Bạn chưa cấu hình Firestore Rules cho phép đọc dữ liệu!");
                }
            }
        }

        function fillFormData(name, phone, position, unit) {
            document.getElementById('display-name').innerText = name;
            document.getElementById('inp-name').value = name;
            document.getElementById('inp-phone').value = phone || "";
            
            // Xử lý giá trị mặc định nếu null
            const finalPos = position || "Công nhân";
            const finalUnit = unit || "Nhóm 1";

            document.getElementById('inp-position').value = finalPos;
            document.getElementById('inp-unit').value = finalUnit;
            
            document.getElementById('role-badge').innerText = finalPos;
            document.getElementById('unit-badge').innerText = finalUnit;
        }

        async function checkManagerRoleForSidebar(email) {
            try {
                const doc = await db.collection("users").doc(email).get();
                if(doc.exists) {
                    const role = doc.data().position || "";
                    const allowed = ["Tổ trưởng", "Tổ phó", "Đội trưởng", "Đội phó"];
                    if(allowed.includes(role)) setTimeout(() => document.querySelectorAll('.manager-only').forEach(el => el.classList.remove('hidden')), 500);
                }
            } catch(e) {}
        }

        function updateSidebarInfo(user) {
            const nameEl = document.getElementById('sidebar-user-name');
            const emailEl = document.getElementById('sidebar-user-email');
            if(nameEl && emailEl) { nameEl.innerText = user.displayName; emailEl.innerText = user.email; }
        }
        function highlightActiveMenu() {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(item => { if(item.getAttribute('onclick').includes('profile')) item.classList.add('active'); });
        }

        window.enableEdit = () => {
            document.getElementById('inp-name').disabled = false;
            document.getElementById('inp-name').classList.add('bg-blue-50');
            document.getElementById('inp-phone').disabled = false;
            document.getElementById('inp-phone').classList.add('bg-blue-50');
            document.getElementById('btn-save').classList.remove('hidden');
            document.getElementById('admin-note').classList.remove('hidden');
            document.getElementById('inp-name').focus();
        };

        window.saveProfile = async () => {
            const btn = document.getElementById('btn-save'); btn.innerText = "ĐANG LƯU..."; btn.disabled = true;
            try {
                await db.collection("users").doc(currentUser.email).set({
                    name: document.getElementById('inp-name').value,
                    phone: document.getElementById('inp-phone').value,
                    // Giữ nguyên chức vụ/đơn vị hiện tại
                    position: document.getElementById('inp-position').value, 
                    unit: document.getElementById('inp-unit').value,
                    email: currentUser.email,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                alert("Đã lưu thông tin!"); location.reload();
            } catch (e) { alert("Lỗi: " + e.message); btn.innerText = "LƯU THAY ĐỔI"; btn.disabled = false; }
        };

        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.menuAction = (a) => {
            toggleSidebar();
            if(a==='report'||a==='assigned') window.location.href="index.html";
            else if(a==='guide') window.location.href="huongdan.html";
            else if(a==='send-notify') window.location.href="guithongbao.html";
            else if(a==='assign-task') window.location.href="giaocongviec.html";
        };
        window.handleLogout = () => confirm("Đăng xuất?") && auth.signOut().then(() => window.location.href = "index.html");
    </script>
</body>
</html>
