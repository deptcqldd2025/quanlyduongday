<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o T·ªï ƒê∆∞·ªùng D√¢y - v1.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, query, where, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- C·∫§U H√åNH QUAN TR·ªåNG ---
        // H√£y d√°n Link Web App (Google Apps Script) c·ªßa b·∫°n v√†o gi·ªØa d·∫•u ngo·∫∑c k√©p b√™n d∆∞·ªõi:
        const APPS_SCRIPT_URL = "D√ÅN_LINK_WEB_APP_C·ª¶A_B·∫†N_V√ÄO_ƒê√ÇY"; 

        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUserProfile = null;

        // --- AUTH LOGIC ---
        window.loginGoogle = () => {
            signInWithPopup(auth, provider).catch(err => alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message));
        };

        window.logout = () => {
            signOut(auth).then(() => location.reload());
        };

        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('loginScreen');
            const appScreen = document.getElementById('appScreen');
            const profileModal = document.getElementById('profileModal');

            if (user) {
                loginScreen.classList.add('hidden');
                // Ki·ªÉm tra xem user ƒë√£ c√≥ th√¥ng tin trong Firestore ch∆∞a
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    currentUserProfile = userSnap.data();
                    appScreen.classList.remove('hidden');
                    document.getElementById('userNameDisplay').innerHTML = `üë§ <b>${currentUserProfile.name}</b> (${currentUserProfile.role})`;
                    loadReports();
                } else {
                    // Ch∆∞a c√≥ th√¥ng tin -> Hi·ªán form c·∫≠p nh·∫≠t
                    profileModal.classList.remove('hidden');
                    document.getElementById('profileEmail').value = user.email;
                }
            } else {
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }
        });

        // L∆∞u th√¥ng tin c√° nh√¢n l·∫ßn ƒë·∫ßu
        window.saveProfile = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const btn = document.getElementById('saveProfileBtn');
            btn.innerText = "ƒêang l∆∞u...";
            btn.disabled = true;

            const profileData = {
                name: document.getElementById('profileName').value,
                empId: document.getElementById('profileId').value,
                role: document.getElementById('profileRole').value,
                email: user.email,
                uid: user.uid,
                updatedAt: Timestamp.now()
            };

            try {
                await setDoc(doc(db, "users", user.uid), profileData);
                document.getElementById('profileModal').classList.add('hidden');
                location.reload(); 
            } catch (error) {
                alert("L·ªói l∆∞u h·ªì s∆°: " + error.message);
                btn.innerText = "L∆ØU TH√îNG TIN";
                btn.disabled = false;
            }
        };

        // --- X·ª¨ L√ù FILE (G·ª≠i sang Google Apps Script) ---
        const convertBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.readAsDataURL(file);
                fileReader.onload = () => resolve(fileReader.result.split(',')[1]);
                fileReader.onerror = (error) => reject(error);
            });
        };

        async function uploadFiles(files) {
            const uploadedUrls = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const base64 = await convertBase64(file);
                
                const payload = {
                    filename: `${Date.now()}_${file.name}`,
                    mimeType: file.type,
                    file: base64
                };

                try {
                    // S·ª≠ d·ª•ng no-cors ƒë·ªÉ tr√°nh l·ªói blocked, tuy nhi√™n s·∫Ω kh√¥ng ƒë·ªçc ƒë∆∞·ª£c response JSON
                    // C√°ch t·ªët nh·∫•t l√† fetch b√¨nh th∆∞·ªùng v√† Apps Script tr·∫£ v·ªÅ header CORS ƒë√∫ng.
                    // ·ªû ƒë√¢y ta d√πng fetch c∆° b·∫£n.
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if(result.status === 'success') uploadedUrls.push(result.url);
                } catch (e) {
                    console.error("Upload l·ªói:", e);
                    // N·∫øu l·ªói do CORS nh∆∞ng file v·∫´n l√™n, ta kh√≥ b·∫Øt ƒë∆∞·ª£c link.
                    // Gi·∫£ ƒë·ªãnh Apps Script config ƒë√∫ng.
                    console.log("C√≥ l·ªói khi k·∫øt n·ªëi Apps Script. Vui l√≤ng ki·ªÉm tra l·∫°i URL.");
                }
            }
            return uploadedUrls;
        }

        // --- X·ª¨ L√ù B√ÅO C√ÅO ---
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.innerText = "üìç ƒêang l·∫•y t·ªça ƒë·ªô...";
            btn.disabled = true;

            // 1. L·∫•y t·ªça ƒë·ªô GPS (·∫®n)
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    await processReportSubmission(position.coords.latitude, position.coords.longitude, btn, originalText);
                }, (error) => {
                    console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS:", error.message);
                    // V·∫´n cho g·ª≠i nh∆∞ng ghi ch√∫ l√† kh√¥ng c√≥ t·ªça ƒë·ªô
                    await processReportSubmission(0, 0, btn, originalText); 
                }, { timeout: 10000 });
            } else {
                await processReportSubmission(0, 0, btn, originalText);
            }
        });

        async function processReportSubmission(lat, lng, btn, originalText) {
            btn.innerText = "üì§ ƒêang t·∫£i file l√™n Drive...";

            // 2. Upload file
            const fileInput = document.getElementById('fileInput');
            let fileLinks = [];
            
            if (fileInput.files.length > 0) {
                if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes("D√ÅN_LINK")) {
                    alert("L·ªñI: Ch∆∞a c·∫•u h√¨nh URL Google Apps Script trong code!");
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return;
                }
                
                try {
                    fileLinks = await uploadFiles(fileInput.files);
                    if (fileLinks.length === 0 && fileInput.files.length > 0) {
                        // Fallback n·∫øu upload th·∫•t b·∫°i ho·∫∑c kh√¥ng l·∫•y ƒë∆∞·ª£c link
                        console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c link file (c√≥ th·ªÉ do l·ªói m·∫°ng ho·∫∑c CORS).");
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            btn.innerText = "üíæ ƒêang l∆∞u d·ªØ li·ªáu...";

            // 3. Chu·∫©n b·ªã d·ªØ li·ªáu
            const reportData = {
                uid: auth.currentUser.uid,
                workerName: currentUserProfile.name,
                workerId: currentUserProfile.empId,
                role: currentUserProfile.role,
                timestamp: Timestamp.now(), // Th·ªùi ƒëi·ªÉm b√°o c√°o th·ª±c t·∫ø
                reportDateString: new Date().toLocaleDateString('vi-VN'), // ƒê·ªÉ l·ªçc theo ng√†y
                locationCoords: { lat: lat, lng: lng }, // T·ªça ƒë·ªô ·∫©n
                workContent: document.getElementById('workContent').value,
                pct_lct: document.getElementById('pctLct').value,
                notes: document.getElementById('notes').value,
                attachments: fileLinks
            };

            // 4. L∆∞u v√†o Firestore
            try {
                await addDoc(collection(db, "daily_reports"), reportData);
                alert("‚úÖ B√°o c√°o th√†nh c√¥ng!");
                document.getElementById('reportForm').reset();
                loadReports();
            } catch (err) {
                alert("‚ùå L·ªói l∆∞u b√°o c√°o: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // --- T·∫¢I DANH S√ÅCH ---
        async function loadReports() {
            const list = document.getElementById('reportList');
            list.innerHTML = '<p class="text-center text-gray-400">ƒêang t·∫£i...</p>';
            
            const todayStr = new Date().toLocaleDateString('vi-VN');
            
            try {
                const q = query(
                    collection(db, "daily_reports"), 
                    where("reportDateString", "==", todayStr),
                    orderBy("timestamp", "desc")
                );

                const snap = await getDocs(q);
                list.innerHTML = "";

                if (snap.empty) {
                    list.innerHTML = '<p class="text-center text-gray-400 italic">Ch∆∞a c√≥ b√°o c√°o n√†o h√¥m nay.</p>';
                    return;
                }

                snap.forEach(doc => {
                    const data = doc.data();
                    const dateObj = data.timestamp.toDate();
                    const timeStr = dateObj.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                    
                    let filesHtml = "";
                    if (data.attachments && data.attachments.length > 0) {
                        filesHtml = `<div class="mt-2 text-sm bg-gray-50 p-2 rounded border border-gray-200">
                            <span class="font-bold text-gray-600">üìé ƒê√≠nh k√®m:</span> `;
                        data.attachments.forEach((link, idx) => {
                            filesHtml += `<a href="${link}" target="_blank" class="text-blue-600 hover:underline mr-3 font-semibold">M·ªü File ${idx+1}</a>`;
                        });
                        filesHtml += `</div>`;
                    }

                    // X·ª≠ l√Ω hi·ªÉn th·ªã t·ªça ƒë·ªô (ch·ªâ hi·ªán icon n·∫øu c√≥)
                    const hasLoc = (data.locationCoords && data.locationCoords.lat !== 0);
                    const locBadge = hasLoc ? '<span title="ƒê√£ l∆∞u v·ªã tr√≠" class="text-green-500 text-xs">üìç GPS OK</span>' : '<span class="text-gray-400 text-xs">No GPS</span>';

                    const item = document.createElement("div");
                    item.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-3 hover:shadow-md transition";
                    item.innerHTML = `
                        <div class="flex justify-between items-start border-b pb-2 mb-2">
                            <div>
                                <span class="font-bold text-blue-800 text-lg">${data.workerName}</span>
                                <span class="text-xs text-gray-500 block">${data.role} - ID: ${data.workerId}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xl font-bold text-gray-700 block">${timeStr}</span>
                                ${locBadge}
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-gray-700">
                             ${data.pct_lct ? `<p><span class="font-semibold text-gray-600">Phi·∫øu:</span> <span class="bg-yellow-100 text-yellow-800 px-1 rounded text-sm font-bold">${data.pct_lct}</span></p>` : ''}
                            
                            <div>
                                <span class="font-semibold text-gray-600">N·ªôi dung:</span>
                                <p class="whitespace-pre-line mt-1 text-sm bg-gray-50 p-2 rounded">${data.workContent}</p>
                            </div>

                            ${data.notes ? `<p class="text-sm italic text-gray-500"><span class="font-semibold not-italic">Ghi ch√∫:</span> ${data.notes}</p>` : ''}
                        </div>

                        ${filesHtml}
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error(error);
                list.innerHTML = `<p class="text-red-500 text-center text-sm">C·∫ßn t·∫°o Index Firestore ho·∫∑c l·ªói m·∫°ng.<br>${error.message}</p>`;
            }
        }

        window.onload = () => {
             document.getElementById('profileForm').addEventListener('submit', window.saveProfile);
        }
    </script>
</head>
<body class="bg-gray-100 font-sans text-sm md:text-base leading-relaxed">

    <div id="loginScreen" class="hidden h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-600 to-blue-400 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center w-full max-w-sm">
            <div class="mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">T·ªî ƒê∆Ø·ªúNG D√ÇY</h1>
                <p class="text-gray-500 text-sm">H·ªá th·ªëng b√°o c√°o hi·ªán tr∆∞·ªùng</p>
                <p class="text-xs text-gray-300 mt-2">Version 1.3</p>
            </div>
            
            <button onclick="window.loginGoogle()" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-lg flex items-center justify-center shadow-sm transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 mr-3">
                ƒêƒÉng nh·∫≠p b·∫±ng Gmail
            </button>
        </div>
    </div>

    <div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm animate-fade-in-down">
            <h2 class="text-xl font-bold mb-2 text-center text-gray-800">C·∫≠p Nh·∫≠t H·ªì S∆°</h2>
            <p class="text-xs text-center text-gray-500 mb-6">Vui l√≤ng khai b√°o th√¥ng tin cho l·∫ßn ƒë·∫ßu s·ª≠ d·ª•ng</p>
            
            <form id="profileForm" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Email</label>
                    <input type="text" id="profileEmail" disabled class="w-full p-2 bg-gray-100 border rounded text-gray-500 text-sm">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">H·ªç v√† T√™n</label>
                    <input type="text" id="profileName" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A" required class="w-full p-2 border border-gray-300 rounded focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">M√£ Nh√¢n Vi√™n</label>
                    <input type="text" id="profileId" placeholder="V√≠ d·ª•: 001234" required class="w-full p-2 border border-gray-300 rounded focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Ch·ª©c danh</label>
                    <select id="profileRole" class="w-full p-2 border border-gray-300 rounded bg-white">
                        <option value="C√¥ng nh√¢n">C√¥ng nh√¢n</option>
                        <option value="T·ªï tr∆∞·ªüng">T·ªï tr∆∞·ªüng</option>
                        <option value="T·ªï ph√≥">T·ªï ph√≥</option>
                        <option value="K·ªπ thu·∫≠t vi√™n">K·ªπ thu·∫≠t vi√™n</option>
                        <option value="L√°i xe">L√°i xe</option>
                    </select>
                </div>
                <button type="submit" id="saveProfileBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg mt-2 shadow-lg transition">L∆ØU TH√îNG TIN</button>
            </form>
        </div>
    </div>

    <div id="appScreen" class="hidden container mx-auto px-4 py-6 max-w-lg">
        <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm">
            <div>
                <h1 class="text-lg font-bold text-blue-800 leading-tight">B√ÅO C√ÅO C√îNG VI·ªÜC</h1>
                <p id="userNameDisplay" class="text-sm text-gray-600 mt-1">...</p>
            </div>
            <button onclick="window.logout()" class="bg-red-50 text-red-500 px-3 py-1 rounded-full text-xs font-bold hover:bg-red-100">Tho√°t</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="bg-blue-600 h-2 w-full"></div> <form id="reportForm" class="p-5 space-y-4">
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2 bg-blue-50 p-2 rounded text-center border border-blue-100">
                        <p class="text-xs text-blue-600 uppercase font-bold">Th·ªùi gian b√°o c√°o</p>
                        <p class="font-bold text-blue-900 text-lg">HI·ªÜN T·∫†I (Auto)</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">S·ªë PCT / LCT / L·ªánh PB</label>
                    <input type="text" id="pctLct" placeholder="Nh·∫≠p s·ªë phi·∫øu..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">N·ªôi dung c√¥ng vi·ªác <span class="text-red-500">*</span></label>
                    <textarea id="workContent" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác, v·ªã tr√≠, k·∫øt qu·∫£..." required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">H√¨nh ·∫£nh / T√†i li·ªáu</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition cursor-pointer relative">
                        <input type="file" id="fileInput" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                        <div class="space-y-1">
                            <svg class="mx-auto h-8 w-8 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="text-xs text-gray-500">Ch·∫°m ƒë·ªÉ ch·ªçn ·∫£nh/file</p>
                            <p class="text-xs text-blue-500">(T·ª± ƒë·ªông l∆∞u Drive)</p>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Ghi ch√∫ / ƒê·ªÅ xu·∫•t</label>
                    <input type="text" id="notes" placeholder="Ki·∫øn ngh·ªã v·∫≠t t∆∞, xe m√°y..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3.5 px-4 rounded-lg shadow-md transform active:scale-95 transition-all duration-200 flex justify-center items-center">
                    G·ª¨I B√ÅO C√ÅO NGAY
                </button>
            </form>
        </div>

        <div>
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-800 border-l-4 border-blue-600 pl-3">Nh·∫≠t k√Ω h√¥m nay</h2>
                <button onclick="loadReports()" class="bg-white border border-gray-300 px-3 py-1 rounded text-xs font-semibold text-gray-600 hover:bg-gray-50">L√†m m·ªõi</button>
            </div>
            
            <div id="reportList" class="space-y-4 pb-10">
                </div>
        </div>
    </div>

</body>
</html>
