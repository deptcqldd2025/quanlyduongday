<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini HLAT Fix - v1.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #0068ff; }
        body { background: #f8fafc; font-family: system-ui, sans-serif; }
        .card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <header class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-black text-blue-800 uppercase italic">Gemini Auto Import</h1>
                [span_0](start_span)<p class="text-gray-500 text-sm">H·ªó tr·ª£ tr√≠ch xu·∫•t h·ªì s∆°: <span class="font-bold">C√¥ng ty Trung Vi·ªát</span>[span_0](end_span)</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-4">
                <div class="card p-10 border-2 border-dashed border-blue-200 text-center hover:bg-blue-50 transition cursor-pointer" id="uploadZone">
                    <input type="file" id="fileInput" class="hidden" multiple accept="image/*,application/pdf">
                    <div class="text-5xl mb-4">üì§</div>
                    <p class="font-black text-gray-700 uppercase">Ch·ªçn h·ªì s∆° HLAT</p>
                    <p id="fileCount" class="text-xs text-gray-400 mt-2 italic">Ch∆∞a ch·ªçn file</p>
                </div>
                <div id="fileListPreview" class="flex flex-wrap gap-2"></div>
                <button id="btnScan" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition">B·∫ÆT ƒê·∫¶U QU√âT B·∫∞NG AI</button>
            </div>

            <div class="card p-6 min-h-[400px]">
                <h3 class="font-bold text-gray-800 mb-6 uppercase italic border-b pb-2">D·ªØ li·ªáu tr√≠ch xu·∫•t</h3>
                <div id="resultArea" class="space-y-4">
                    <p class="text-center text-gray-300 mt-20 text-sm">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const API_KEY = "AIzaSyCyPQUxDvVBFpAClGoS8X9mvWX72y97XMA";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        const fileInput = document.getElementById('fileInput');
        const uploadZone = document.getElementById('uploadZone');
        const btnScan = document.getElementById('btnScan');
        const resultArea = document.getElementById('resultArea');

        uploadZone.onclick = () => fileInput.click();

        fileInput.onchange = (e) => {
            const files = e.target.files;
            document.getElementById('fileCount').innerText = `ƒê√£ ch·ªçn ${files.length} file`;
            const preview = document.getElementById('fileListPreview');
            preview.innerHTML = "";
            [...files].forEach(f => {
                preview.innerHTML += `<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-1 rounded-md font-bold">${f.name}</span>`;
            });
        };

        btnScan.onclick = async () => {
            const files = fileInput.files;
            if (files.length === 0) return alert("Vui l√≤ng ch·ªçn file tr∆∞·ªõc!");

            btnScan.disabled = true;
            btnScan.innerHTML = `<span class="loader"></span> ƒêANG QU√âT...`;
            resultArea.innerHTML = `<div class="text-center mt-20"><span class="loader"></span><p class="text-xs font-bold text-blue-500 mt-2">AI ƒêANG PH√ÇN T√çCH...</p></div>`;

            try {
                const prompt = "Tr√≠ch xu·∫•t th√¥ng tin h·ªì s∆° HLAT. Tr·∫£ v·ªÅ m·∫£ng JSON g·ªìm: don_vi_de_nghi, dia_chi_cong_trinh, dt_hlat_thuc_te, dt_hlat_quy_hoach. Ch·ªâ tr·∫£ v·ªÅ JSON.";
                const imageParts = await Promise.all([...files].map(fileToGenerativePart));
                
                const result = await model.generateContent([prompt, ...imageParts]);
                const response = await result.response;
                const text = response.text().replace(/```json|```/g, "").trim();
                const data = JSON.parse(text);

                renderResults(data);
            } catch (error) {
                resultArea.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-xl text-xs font-bold">L·ªói: ${error.message}</div>`;
            } finally {
                btnScan.disabled = false;
                btnScan.innerHTML = `B·∫ÆT ƒê·∫¶U QU√âT B·∫∞NG AI`;
            }
        };

        async function fileToGenerativePart(file) {
            const base64Data = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return { inlineData: { data: base64Data, mimeType: file.type } };
        }

        function renderResults(data) {
            const items = Array.isArray(data) ? data : [data];
            resultArea.innerHTML = items.map(item => `
                <div class="border-2 border-blue-50 p-4 rounded-2xl bg-slate-50">
                    <h4 class="font-black text-blue-800 text-sm mb-1">${item.don_vi_de_nghi || "N/A"}</h4>
                    <p class="text-[11px] text-gray-500 mb-2">${item.dia_chi_cong_trinh || "N/A"}</p>
                    <div class="flex gap-4 border-t pt-2 border-dashed">
                        <div class="text-[10px]"><b>Th·ª±c t·∫ø:</b> <span class="text-red-500 font-bold">${item.dt_hlat_thuc_te} m2</span></div>
                        <div class="text-[10px]"><b>Quy ho·∫°ch:</b> <span class="text-red-500 font-bold">${item.dt_hlat_quy_hoach} m2</span></div>
                    </div>
                </div>
            `).join("");
        }
    </script>
</body>
</html>
