<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S·ªï tay c√¥ng vi·ªác - v1.20</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0068ff">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #0068ff; --bg: #f8fafc; }
        body { background-color: var(--bg); font-family: -apple-system, sans-serif; overflow-x: hidden; }
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; width: 80%; position: fixed; top: 0; left: 0; height: 100%; }
        #sidebar.hidden-menu { transform: translateX(-101%); }
        #overlay { transition: opacity 0.3s ease; z-index: 900; }
        .form-input { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 14px; outline: none; background: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loader { width: 20px; height: 20px; border: 3px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rot 1s linear infinite; display: inline-block; }
        @keyframes rot { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 font-bold text-xs uppercase tracking-widest">ƒêang t·∫£i...</p>
    </div>

    <div id="loginScreen" class="hidden fixed inset-0 bg-white z-[1500] flex flex-col items-center justify-center p-6 text-center">
        <div class="w-20 h-20 bg-blue-50 rounded-3xl flex items-center justify-center mb-6 shadow-sm"><span class="text-4xl">‚ö°</span></div>
        <h1 class="text-2xl font-black text-blue-800 mb-2 uppercase">S·ªï tay c√¥ng vi·ªác</h1>
        <p class="text-gray-400 text-sm mb-10">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</p>
        <button id="mainLoginBtn" class="w-full max-w-xs bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">
            ƒêƒÉng nh·∫≠p b·∫±ng Google
        </button>
    </div>

    <div id="overlay" class="hidden fixed inset-0 bg-black/60 opacity-0 pointer-events-none transition-opacity"></div>
    <div id="sidebar" class="hidden-menu bg-white shadow-2xl flex flex-col overflow-hidden">
        <div class="p-6 bg-blue-600 text-white flex justify-between items-start">
            <div>
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-xl mb-3">üë§</div>
                <div id="uNameSide" class="font-bold text-lg leading-tight">...</div>
                <div id="uRoleSide" class="text-xs text-blue-100 mt-1 uppercase italic">...</div>
            </div>
            <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center bg-black/10 rounded-full text-xl font-bold active:bg-black/20 transition">‚úï</button>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <button onclick="showPage('reportForm')" class="w-full text-left p-4 hover:bg-blue-50 rounded-2xl font-bold text-sm">‚úçÔ∏è G·ª≠i b√°o c√°o</button>
            <button onclick="showPage('assignedTasks')" class="w-full text-left p-4 hover:bg-blue-50 rounded-2xl font-bold text-sm">üìã C√¥ng vi·ªác m·ªõi</button>
            <button onclick="showPage('history')" class="w-full text-left p-4 hover:bg-blue-50 rounded-2xl font-bold text-sm">üïí Nh·∫≠t k√Ω</button>
        </nav>
        <div class="p-4 border-t"><button id="mainLogoutBtn" class="w-full p-4 text-red-500 font-bold bg-red-50 rounded-2xl">THO√ÅT</button></div>
    </div>

    <div id="appScreen" class="hidden flex flex-col h-screen">
        <header class="bg-white border-b px-4 py-4 flex items-center justify-between sticky top-0 z-10 shadow-sm">
            <button onclick="toggleSidebar()" class="text-2xl p-1 bg-gray-50 rounded-xl w-10 h-10">‚ò∞</button>
            <h1 class="font-black text-blue-600 text-sm uppercase">S·ªï tay c√¥ng vi·ªác</h1>
            <div class="w-10"></div>
        </header>
        <main class="flex-1 overflow-y-auto p-4 pb-20">
            <div id="page-reportForm" class="page-section">
                <form id="form" class="space-y-4">
                    <select id="reportType" onchange="handleTypeChange()" class="form-input font-black text-blue-600 border-2 border-blue-50">
                        <option value="assigned">üìù C√¥ng vi·ªác ƒë∆∞·ª£c giao</option>
                        <option value="urgent">‚ö†Ô∏è B√°o c√°o ƒë·ªôt xu·∫•t</option>
                        <option value="daily">üìÖ B√°o c√°o h√†ng ng√†y</option>
                    </select>
                    <div id="assignedFields" class="space-y-4 bg-blue-50 p-4 rounded-2xl border-2 border-blue-100">
                        <select id="taskSelect" class="form-input font-bold border-blue-200"><option value="">-- Ch·ªçn c√¥ng vi·ªác --</option></select>
                        <div class="grid grid-cols-2 gap-3">
                            <select id="progress" onchange="handleProgressChange()" class="form-input font-bold border-blue-200">
                                <option value="100%">Xong 100%</option>
                                <option value="70%">70%</option><option value="50%">50%</option><option value="25%">25%</option>
                            </select>
                            <input id="reason" placeholder="L√Ω do..." class="hidden form-input border-red-100">
                        </div>
                    </div>
                    <textarea id="content" rows="4" placeholder="N·ªôi dung th·ª±c hi·ªán..." required class="form-input shadow-sm"></textarea>
                    <button type="submit" id="sBtn" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl">G·ª¨I B√ÅO C√ÅO</button>
                </form>
            </div>
            <div id="page-history" class="page-section hidden"><div id="list" class="space-y-4"></div></div>
        </main>
    </div>

    <div id="profileModal" class="hidden fixed inset-0 bg-black/80 z-[2000] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <form id="pForm"><input id="pName" placeholder="H·ªç t√™n" required class="form-input mb-3"><button class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">L∆ØU</button></form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, query, where, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M", authDomain: "baocaongay-e73a2.firebaseapp.com", projectId: "baocaongay-e73a2", storageBucket: "baocaongay-e73a2.firebasestorage.app", messagingSenderId: "75165392007", appId: "1:75165392007:web:4ec22bb1612108b096ac22" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // G√°n s·ª± ki·ªán cho n√∫t ƒëƒÉng nh·∫≠p b·∫±ng code (Tr√°nh l·ªói module)
        document.getElementById('mainLoginBtn').onclick = () => {
            signInWithPopup(auth, provider)
            .then(() => console.log("Login success"))
            .catch(err => alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message));
        };

        document.getElementById('mainLogoutBtn').onclick = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            if (user) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    const u = snap.data();
                    document.getElementById('uNameSide').innerText = u.name;
                    document.getElementById('uRoleSide').innerText = u.role;
                } else { document.getElementById('profileModal').classList.remove('hidden'); }
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        });

        // C√°c h√†m Sidebar & UI
        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('hidden-menu');
            document.getElementById('overlay').classList.toggle('hidden');
        };
        window.handleTypeChange = () => {
            const isAssigned = document.getElementById('reportType').value === 'assigned';
            document.getElementById('assignedFields').classList.toggle('hidden', !isAssigned);
        };
        window.handleProgressChange = () => {
            const needReason = document.getElementById('progress').value !== '100%';
            document.getElementById('reason').classList.toggle('hidden', !needReason);
        };
    </script>
</body>
</html>
