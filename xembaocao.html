<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo dõi báo cáo - v1.76</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        function toggleSidebar() {
            var sb = document.getElementById('sidebar');
            if(sb) sb.classList.toggle('active');
        }
        function menuAction(action) {
            toggleSidebar();
            if (action === 'report') window.location.href = "index.html";
            else if (action === 'assigned') window.location.href = "congvieccuatoi.html";
            else if (action === 'notification') window.location.href = "xemthongbao.html";
            else if (action === 'profile') window.location.href = "thongtincanhan.html";
            else if (action === 'guide') window.location.href = "huongdan.html";
            else if (action === 'send-notify') window.location.href = "guithongbao.html";
            else if (action === 'assign-task') window.location.href = "giaocongviec.html";
            else if (action === 'view-reports') window.location.reload(); 
        }
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="pb-16 bg-[#F4F7FA]">

    <div id="sidebar-container"></div>

    <div class="evn-header">
        <div class="max-w-md mx-auto flex items-center">
            <i class="fa fa-bars text-2xl cursor-pointer mr-4" onclick="toggleSidebar()"></i>
            <h1 class="font-black text-lg italic uppercase leading-none">Theo dõi báo cáo</h1>
        </div>
    </div>

    <div id="debug-log" class="text-center text-[10px] text-red-500 font-mono bg-yellow-50 p-2 border-b border-yellow-200 hidden"></div>

    <div class="max-w-md mx-auto px-4 -mt-8 space-y-4">
        
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-slate-500 uppercase">Ngày xem:</span>
                <input type="date" id="filter-date" class="border border-slate-200 rounded-lg px-3 py-1 text-sm font-bold text-blue-900 outline-none focus:border-blue-500">
            </div>
            <p id="status-text" class="text-[10px] text-slate-400 text-right italic">Đang khởi tạo...</p>
        </div>

        <div id="stats-container" class="grid grid-cols-2 gap-3">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-green-500">
                <p class="text-[10px] text-slate-400 font-bold uppercase">Đã báo cáo</p>
                <p class="text-2xl font-black text-green-600" id="count-reported">0</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-red-500">
                <p class="text-[10px] text-slate-400 font-bold uppercase">Chưa báo cáo</p>
                <p class="text-2xl font-black text-red-600" id="count-missing">0</p>
            </div>
        </div>

        <div id="missing-section" class="hidden">
            <div class="bg-red-50 border border-red-100 p-4 rounded-2xl">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa fa-triangle-exclamation text-red-500 animate-pulse"></i>
                    <h3 class="font-black text-red-600 text-xs uppercase" id="warning-title">Chưa báo cáo</h3>
                </div>
                <div id="missing-list" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <div>
            <h3 class="font-black text-blue-900 text-xs uppercase mb-3 ml-2">Chi tiết (<span id="list-count">0</span>)</h3>
            <div id="report-list" class="space-y-3">
                <p class="text-center text-xs text-slate-400 py-10">Vui lòng đợi...</p>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[24px] p-6 relative shadow-2xl">
            <i class="fa fa-times absolute top-4 right-4 text-slate-400 cursor-pointer text-xl" onclick="closeModal()"></i>
            <h3 class="font-black text-lg text-[#1A479A] uppercase mb-4 border-b pb-2">Nội dung báo cáo</h3>
            <div id="modal-content" class="text-sm text-slate-700 leading-relaxed max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <div class="footer-evn"><p>Hệ thống quản lý - Version 1.76 (Fix)</p></div>

    <script>
        // --- LOGGING ---
        function logError(msg) {
            var d = document.getElementById('debug-log');
            if(d) {
                d.classList.remove('hidden');
                d.innerHTML += msg + "<br>";
            }
            console.log(msg);
        }

        // --- 2. SET NGÀY NGAY LẬP TỨC (KHÔNG CHỜ FIREBASE) ---
        try {
            var now = new Date();
            var y = now.getFullYear();
            var m = String(now.getMonth() + 1).padStart(2,'0');
            var d = String(now.getDate()).padStart(2,'0');
            document.getElementById('filter-date').value = y + "-" + m + "-" + d;
        } catch(e) { logError("Lỗi ngày tháng: " + e.message); }

        // --- 3. LOAD SIDEBAR ---
        fetch('sidebar.html').then(function(r){ return r.text() }).then(function(d){
            document.getElementById('sidebar-container').innerHTML = d;
        });

        // --- 4. CƠ CHẾ CHỜ FIREBASE (RETRY LOOP) ---
        var attempts = 0;
        var initInterval = setInterval(function() {
            attempts++;
            document.getElementById('status-text').innerText = "Đang kết nối... (" + attempts + ")";
            
            if (typeof firebase !== 'undefined' && firebase.apps) {
                clearInterval(initInterval);
                startApp(); // Firebase đã sẵn sàng, chạy app
            } else if (attempts > 10) {
                // Quá 10 giây không thấy Firebase
                clearInterval(initInterval);
                logError("Lỗi: Không thể kết nối máy chủ Firebase. Vui lòng kiểm tra mạng!");
                document.getElementById('status-text').innerText = "Lỗi kết nối mạng.";
            }
        }, 1000); // Kiểm tra mỗi 1 giây

        // --- 5. LOGIC CHÍNH ---
        function startApp() {
            try {
                // Config
                var firebaseConfig = { apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M", authDomain: "baocaongay-e73a2.firebaseapp.com", projectId: "baocaongay-e73a2", storageBucket: "baocaongay-e73a2.firebasestorage.app", messagingSenderId: "75165392007", appId: "1:75165392007:web:4ec22bb1612108b096ac22", measurementId: "G-TEGTD9KFCW" };
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                var db = firebase.firestore();
                var auth = firebase.auth();
                var currentUser = null;

                document.getElementById('status-text').innerText = "Đã kết nối. Đang xác thực...";

                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        currentUser = user;
                        var n = document.getElementById('sidebar-user-name'); 
                        if(n) n.innerText = user.displayName;
                        
                        // Check quyền
                        db.collection("users").doc(user.email).get().then(function(doc){
                            if(doc.exists && ["Tổ trưởng", "Tổ phó", "Đội trưởng", "Đội phó", "Lãnh đạo"].includes(doc.data().position)) {
                                loadDashboard(db);
                            } else {
                                alert("Không có quyền!"); window.location.href="index.html";
                            }
                        }).catch(function(e){ logError("Lỗi quyền: " + e.message); });

                    } else { window.location.href = "index.html"; }
                });

                // Sự kiện đổi ngày
                document.getElementById('filter-date').addEventListener('change', function() { loadDashboard(db); });

            } catch(e) { logError("Crash startApp: " + e.message); }
        }

        async function loadDashboard(db) {
            var reportListEl = document.getElementById('report-list');
            var statusText = document.getElementById('status-text');
            var inputVal = document.getElementById('filter-date').value;
            
            if(!inputVal) return;
            var parts = inputVal.split('-');
            var startOfDay = new Date(parts[0], parts[1]-1, parts[2], 0, 0, 0);
            var endOfDay = new Date(parts[0], parts[1]-1, parts[2], 23, 59, 59);

            statusText.innerText = "Đang tải: " + startOfDay.toLocaleDateString('vi-VN');
            reportListEl.innerHTML = '<p class="text-center text-xs text-slate-400 py-4">Đang truy xuất...</p>';

            try {
                // 1. Get Users
                var usersSnap = await db.collection("users").get();
                var allUsers = [];
                usersSnap.forEach(function(doc){ if(doc.data().name) allUsers.push({email:doc.id, name:doc.data().name}); });

                // 2. Get Reports
                var reportsSnap = await db.collection("daily_reports")
                                        .where("timestamp", ">=", startOfDay)
                                        .where("timestamp", "<=", endOfDay)
                                        .get();
                var reportedEmails = [];
                var reports = [];
                reportsSnap.forEach(function(doc){
                    var d = doc.data();
                    reportedEmails.push(d.email);
                    reports.push({...d, id:doc.id});
                });

                // 3. Stats
                var missingUsers = allUsers.filter(function(u){ return !reportedEmails.includes(u.email); });
                document.getElementById('count-reported').innerText = reports.length;
                document.getElementById('count-missing').innerText = missingUsers.length;
                document.getElementById('list-count').innerText = reports.length;

                // 4. Render Missing
                var missingEl = document.getElementById('missing-list');
                var missingSec = document.getElementById('missing-section');
                missingEl.innerHTML = "";
                if(missingUsers.length > 0) {
                    missingSec.classList.remove('hidden');
                    // Cảnh báo 19h
                    var now = new Date();
                    var isToday = now.getDate() == startOfDay.getDate();
                    var isLate = now.getHours() >= 19;
                    var titleEl = document.getElementById('warning-title');
                    if(isToday && isLate) {
                        titleEl.innerText = "CẢNH BÁO: QUÁ 19H CHƯA BÁO CÁO";
                        titleEl.className = "font-black text-red-600 text-xs uppercase animate-pulse";
                    } else {
                        titleEl.innerText = "Chưa báo cáo";
                        titleEl.className = "font-black text-red-600 text-xs uppercase";
                    }
                    missingEl.innerHTML = missingUsers.map(function(u){ return '<span class="bg-white border border-slate-200 text-slate-600 text-[10px] font-bold px-2 py-1 rounded shadow-sm">'+u.name+'</span>'; }).join('');
                } else { missingSec.classList.add('hidden'); }

                // 5. Render Reports
                if(reports.length === 0) reportListEl.innerHTML = '<p class="text-center text-xs text-slate-400 italic py-4">Chưa có dữ liệu</p>';
                else {
                    reports.sort(function(a,b){ return (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0) });
                    reportListEl.innerHTML = reports.map(function(r){
                        var fileIcon = (r.files&&r.files.length>0) ? '<i class="fa fa-paperclip text-blue-500 ml-1"></i>' : "";
                        var cleanContent = r.content.replace(/'/g, "\\'").replace(/\n/g, '<br>');
                        return '<div class="bg-white p-4 rounded-[20px] shadow-sm border border-slate-50 cursor-pointer hover:bg-slate-50 transition" onclick="showContent(\''+r.worker+'\', \''+cleanContent+'\')"><div class="flex justify-between items-start mb-1"><h4 class="font-black text-xs text-[#1A479A] uppercase">'+r.worker+'</h4><span class="bg-blue-50 text-blue-600 text-[9px] font-bold px-2 py-0.5 rounded">'+r.reportType+'</span></div><p class="text-xs text-slate-600 line-clamp-2">'+r.content+'</p>'+(fileIcon?'<p class="text-[9px] text-slate-400 mt-1">'+fileIcon+' Có đính kèm file</p>':'')+'</div>';
                    }).join('');
                }
                statusText.innerText = "Hoàn tất.";

            } catch(e) { logError("Lỗi tải data: " + e.message); }
        }

        // Utils
        function showContent(w, c) { document.getElementById('modal-content').innerHTML = '<b>'+w+'</b><br><br>'+c; document.getElementById('detailModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }
    </script>
</body>
</html>
