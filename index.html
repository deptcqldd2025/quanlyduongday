<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sổ tay công việc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="pb-16">
    <div id="login-screen" class="login-overlay"><div class="text-center mb-10"><h1 class="text-3xl font-black italic uppercase tracking-tighter mb-2">Sổ tay công việc</h1><p class="text-xs font-bold text-blue-200 uppercase tracking-widest">Đội quản lý lưới điện 2</p></div><button onclick="handleLogin()" class="btn-google uppercase text-xs"><img src="https://img.icons8.com/color/48/000000/google-logo.png" class="w-5 h-5"/> Đăng nhập Gmail</button><p id="loading-text" class="mt-4 text-[10px] text-white/50 hidden font-bold">Đang kết nối...</p></div>
    <div id="sidebar-container"></div>
    <div id="main-app" class="hidden">
        <div class="evn-header"><div class="max-w-md mx-auto flex items-center"><i class="fa fa-bars text-2xl cursor-pointer mr-4" onclick="toggleSidebar()"></i><div><h1 class="font-black text-lg italic uppercase leading-none">Sổ tay công việc</h1><p id="header-user-name" class="text-[10px] font-bold text-blue-200 mt-1 uppercase italic">...</p></div></div></div>
        <div class="max-w-md mx-auto px-6 -mt-6 space-y-6">
            <section class="bg-white p-6 rounded-[30px] shadow-2xl space-y-4 border border-slate-50">
                <h2 id="form-title" class="text-[10px] font-black text-slate-800 uppercase tracking-widest border-l-4 border-blue-700 pl-2">Gửi báo cáo</h2>
                <div><label class="text-[9px] font-black text-slate-400 uppercase ml-2 mb-1 block">Loại hình</label><select id="report-type" class="input-evn select-evn font-bold text-blue-900" onchange="handleTypeChange()"><option value="Báo cáo ngày">Báo cáo ngày</option><option value="Báo cáo đột xuất">Báo cáo đột xuất</option><option value="Công việc được giao" id="opt-assigned" class="hidden">Công việc được giao</option></select></div>
                <div id="assigned-tasks-container" class="hidden"><label class="text-[9px] font-black text-orange-500 uppercase ml-2 mb-1 block">Chọn việc</label><select id="assigned-task-list" class="input-evn border-orange-200 bg-orange-50/30 font-bold text-slate-700"></select></div>
                <textarea id="job-content" rows="4" class="input-evn" placeholder="Nội dung công việc *"></textarea>
                <div id="file-list-container" class="space-y-2"></div>
                <div class="border-2 border-dashed border-slate-100 rounded-[20px] p-4 text-center bg-slate-50/50 cursor-pointer" onclick="document.getElementById('file-in').click()"><input type="file" id="file-in" class="hidden" multiple accept="image/*,.pdf"><div class="text-[10px] font-black text-blue-700 uppercase italic">+ Chọn file ảnh/PDF</div></div>
                <input type="text" id="job-note" class="input-evn" placeholder="Ghi chú">
                <button onclick="submitReport()" id="btn-submit" class="w-full bg-[#1A479A] text-white font-black py-4 rounded-[18px] shadow-lg uppercase text-[11px] tracking-widest active:scale-95 transition-all">Gửi báo cáo</button>
                <button id="btn-cancel-edit" onclick="resetForm()" class="hidden w-full text-red-500 font-bold text-[10px] uppercase py-2">Hủy sửa</button>
            </section>
            <section class="space-y-4 pb-16"><h3 class="font-black text-slate-800 text-[11px] uppercase italic px-2 border-b pb-2">Nhật ký hôm nay</h3><div id="history-list" class="space-y-4"></div></section>
        </div>
    </div>
    <div class="footer-evn"><p>Thiết kế bởi: Trần Công Đẹp | Phiên bản: 1.50</p></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M", authDomain: "baocaongay-e73a2.firebaseapp.com", projectId: "baocaongay-e73a2", storageBucket: "baocaongay-e73a2.firebasestorage.app", messagingSenderId: "75165392007", appId: "1:75165392007:web:4ec22bb1612108b096ac22", measurementId: "G-TEGTD9KFCW" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); const auth = firebase.auth();
        const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbwanzWLo8PhCuOnTGrP-Ra_5rbYvkCgdgbIr-gSPMxbsXJ-5creXdid0_GYQM6AufT4rA/exec";
        let selectedFiles = [], editingId = null;

        fetch('sidebar.html').then(r=>r.text()).then(d=>{ document.getElementById('sidebar-container').innerHTML=d; });

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('header-user-name').innerText = user.displayName;
                updateSidebarInfo(user); checkManager(user.email); checkAssigned(user.displayName); loadHistory(user.email);
                
                const preTask = localStorage.getItem('preselect_task_id');
                if(preTask) { document.getElementById('report-type').value = "Công việc được giao"; handleTypeChange(); setTimeout(()=>{ const s=document.getElementById('assigned-task-list'); if(s) s.value=preTask; localStorage.removeItem('preselect_task_id'); }, 1500); }
            } else { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('main-app').classList.add('hidden'); }
        });

        async function checkManager(email) { try{const d=await db.collection("users").doc(email).get(); if(d.exists && ["Tổ trưởng","Tổ phó","Đội trưởng","Đội phó"].includes(d.data().position)) setTimeout(()=>document.querySelectorAll('.manager-only').forEach(e=>e.classList.remove('hidden')),500);}catch(e){} }
        async function checkAssigned(name) { try{const s=await db.collection("tasks").where("assigned_leader","==",name).where("status","==","assigned").get(); if(!s.empty){document.getElementById('opt-assigned').classList.remove('hidden'); document.getElementById('assigned-task-list').innerHTML=s.docs.map(d=>`<option value="${d.id}">${d.data().don_vi_de_nghi}</option>`).join('');}}catch(e){} }
        function updateSidebarInfo(u){ const n=document.getElementById('sidebar-user-name'),e=document.getElementById('sidebar-user-email'); if(n&&e){n.innerText=u.displayName;e.innerText=u.email;} }
        
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.menuAction = (a) => { toggleSidebar(); if(a=='report') {window.scrollTo({top:0,behavior:'smooth'});resetForm();} else if(a=='assigned') window.location.href="congvieccuatoi.html"; else if(a=='profile') window.location.href="thongtincanhan.html"; else if(a=='guide') window.location.href="huongdan.html"; else if(a=='notification') window.location.href="xemthongbao.html"; else if(a=='send-notify') window.location.href="guithongbao.html"; else if(a=='assign-task') window.location.href="giaocongviec.html"; };
        window.handleLogin = () => {document.getElementById('loading-text').classList.remove('hidden');auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());};
        window.handleLogout = () => confirm("Đăng xuất?") && auth.signOut();
        window.handleTypeChange = () => document.getElementById('assigned-tasks-container').classList.toggle('hidden', document.getElementById('report-type').value !== 'Công việc được giao');
        
        document.getElementById('file-in').onchange = (e) => { Array.from(e.target.files).forEach(f => { const r = new FileReader(); r.onload = (v) => { selectedFiles.push({name:f.name, type:f.type, data:v.target.result.split(',')[1]}); renderFiles(); }; r.readAsDataURL(f); }); };
        function renderFiles() { document.getElementById('file-list-container').innerHTML = selectedFiles.map((f,i) => `<div class="file-item"><span class="truncate"><i class="fa fa-file-image mr-2 text-blue-500"></i>${f.name}</span><i class="fa fa-trash-alt text-red-500 cursor-pointer" onclick="removeFile(${i})"></i></div>`).join(''); }
        window.removeFile = (i) => { selectedFiles.splice(i,1); renderFiles(); };

        window.submitReport = async () => {
            const u = auth.currentUser, c = document.getElementById('job-content').value; if(!c) return alert("Chưa nhập nội dung!");
            const btn = document.getElementById('btn-submit'); btn.disabled=true; btn.innerText="ĐANG GỬI...";
            try {
                if(selectedFiles.length) fetch(APPSCRIPT_URL, {method:"POST", mode:"no-cors", body:JSON.stringify({files:selectedFiles, user:u.email})});
                const d = { worker:u.displayName, email:u.email, reportType:document.getElementById('report-type').value, assignedTaskId:document.getElementById('assigned-task-list').value, reportTitle:`Báo cáo ngày ${new Date().toLocaleDateString('vi-VN')}`, content:c, note:document.getElementById('job-note').value, status:"pending", date:new Date().toLocaleDateString('vi-VN'), timestamp:firebase.firestore.FieldValue.serverTimestamp() };
                if(editingId) await db.collection("daily_reports").doc(editingId).update(d); else await db.collection("daily_reports").add(d);
                alert("Thành công!"); resetForm(); setTimeout(()=>loadHistory(u.email),800);
            } catch(e){ alert(e.message); } finally { btn.disabled=false; btn.innerText="Gửi báo cáo"; }
        };

        async function loadHistory(email) {
            const list=document.getElementById('history-list'), today=new Date().toLocaleDateString('vi-VN');
            try { let s; try{s=await db.collection("daily_reports").where("email","==",email).where("date","==",today).orderBy("timestamp","desc").get();}catch(e){s=await db.collection("daily_reports").where("email","==",email).where("date","==",today).get();}
            if(s.empty) {list.innerHTML=`<p class="text-center py-10 text-slate-300 text-[10px] font-black uppercase">Chưa có báo cáo</p>`; return;}
            list.innerHTML=s.docs.map(d=>{ const v=d.data(), e=v.status==="pending"; return `<div class="card-history"><div class="flex justify-between mb-2"><span class="text-[8px] font-black px-2 py-0.5 rounded ${e?'bg-orange-50 text-orange-600':'bg-green-50 text-green-600'} uppercase">${v.reportType}</span>${e?`<i class="fa fa-edit text-blue-600 cursor-pointer" onclick="editReport('${d.id}')"></i>`:''}</div><p class="text-[9px] font-black text-blue-800 uppercase">${v.reportTitle}</p><p class="text-xs text-slate-600 font-bold mt-2">${v.content}</p></div>`; }).join(''); } catch(e){}
        }
        window.editReport = async (id) => { const d = (await db.collection("daily_reports").doc(id).get()).data(); editingId=id; document.getElementById('job-content').value=d.content; document.getElementById('job-note').value=d.note; document.getElementById('report-type').value=d.reportType; if(d.reportType==='Công việc được giao'){document.getElementById('assigned-tasks-container').classList.remove('hidden'); document.getElementById('assigned-task-list').value=d.assignedTaskId;} document.getElementById('form-title').innerText="Sửa báo cáo"; document.getElementById('btn-cancel-edit').classList.remove('hidden'); };
        window.resetForm = () => { editingId=null; document.getElementById('job-content').value=""; document.getElementById('job-note').value=""; document.getElementById('report-type').value="Báo cáo ngày"; document.getElementById('assigned-tasks-container').classList.add('hidden'); document.getElementById('form-title').innerText="Gửi báo cáo"; document.getElementById('btn-cancel-edit').classList.add('hidden'); selectedFiles=[]; renderFiles(); };
    </script>
</body>
</html>
