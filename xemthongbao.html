<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông báo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="pb-16 bg-[#F4F7FA]">
    <div id="sidebar-container"></div>
    <div class="evn-header"><div class="max-w-md mx-auto flex items-center"><i class="fa fa-bars text-2xl cursor-pointer mr-4" onclick="toggleSidebar()"></i><h1 class="font-black text-lg italic uppercase leading-none">Thông báo mới</h1></div></div>
    <div class="max-w-md mx-auto px-6 -mt-8 space-y-4" id="notification-list"><p class="text-center text-xs text-slate-400 italic py-10">Đang tải...</p></div>
    <div class="footer-evn"><p>Hệ thống quản lý - Version 1.50</p></div>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M", authDomain: "baocaongay-e73a2.firebaseapp.com", projectId: "baocaongay-e73a2", storageBucket: "baocaongay-e73a2.firebasestorage.app", messagingSenderId: "75165392007", appId: "1:75165392007:web:4ec22bb1612108b096ac22", measurementId: "G-TEGTD9KFCW" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); const auth = firebase.auth(); let currentUser = null;

        fetch('sidebar.html').then(r=>r.text()).then(d=>{ document.getElementById('sidebar-container').innerHTML=d; if(currentUser) updateSidebarInfo(currentUser); });
        auth.onAuthStateChanged(user => { if (user) { currentUser=user; updateSidebarInfo(user); checkManager(user); loadNoti(); } else { window.location.href = "index.html"; } });

        async function loadNoti() {
            const list=document.getElementById('notification-list');
            try {
                const s = await db.collection("notifications").orderBy("timestamp", "desc").limit(20).get();
                if (s.empty) { list.innerHTML=`<div class="text-center text-slate-400 mt-10"><p class="text-xs">Không có thông báo</p></div>`; return; }
                list.innerHTML = s.docs.map(d => {
                    const v=d.data(), icon=v.priority==='urgent'?"fa-bolt text-red-500 bg-red-100":v.priority==='warning'?"fa-triangle-exclamation text-orange-500 bg-orange-100":"fa-bell text-blue-500 bg-blue-100";
                    return `<div class="bg-white p-5 rounded-[24px] shadow-sm border border-slate-100 relative"><div class="flex gap-3 mb-2"><div class="w-8 h-8 rounded-full ${icon} flex items-center justify-center shrink-0"><i class="fa ${icon.split(' ')[0]} text-xs"></i></div><div><h3 class="font-black text-sm text-slate-800 leading-tight">${v.title}</h3><p class="text-[10px] text-slate-400 mt-1">${v.date} • ${v.sender}</p></div></div><div class="text-xs text-slate-600 leading-relaxed pl-11">${v.content}</div></div>`;
                }).join('');
            } catch(e) { list.innerHTML=`<p class="text-red-400 text-center text-xs">Lỗi: ${e.message}</p>`; }
        }
        async function checkManager(user) { try{const d=await db.collection("users").doc(user.email).get(); if(d.exists && ["Tổ trưởng","Tổ phó","Đội trưởng","Đội phó"].includes(d.data().position)) setTimeout(()=>document.querySelectorAll('.manager-only').forEach(e=>e.classList.remove('hidden')),500);}catch(e){} }
        function updateSidebarInfo(u){ const n=document.getElementById('sidebar-user-name'),e=document.getElementById('sidebar-user-email'); if(n&&e){n.innerText=u.displayName;e.innerText=u.email;} }
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.menuAction = (a) => { toggleSidebar(); if(a=='report') window.location.href="index.html"; else if(a=='assigned') window.location.href="congvieccuatoi.html"; else if(a=='notification') {}; else if(a=='profile') window.location.href="thongtincanhan.html"; else if(a=='guide') window.location.href="huongdan.html"; else if(a=='send-notify') window.location.href="guithongbao.html"; else if(a=='assign-task') window.location.href="giaocongviec.html"; };
        window.handleLogout = () => confirm("Đăng xuất?") && auth.signOut().then(()=>window.location.href='index.html');
    </script>
</body>
</html>
