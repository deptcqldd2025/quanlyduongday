<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√°o C√°o T·ªï ƒê∆∞·ªùng D√¢y - v1.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #2563eb; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* ·∫®n thanh cu·ªôn tr√™n mobile nh∆∞ng v·∫´n cu·ªôn ƒë∆∞·ª£c */
        body::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, query, where, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- C·∫§U H√åNH (B·∫ÆT BU·ªòC PH·∫¢I D√ÅN LINK) ---
        // üëá D√ÅN LINK GOOGLE APPS SCRIPT V√ÄO D∆Ø·ªöI ƒê√ÇY üëá
        const APPS_SCRIPT_URL = "D√ÅN_LINK_WEB_APP_C·ª¶A_B·∫†N_V√ÄO_ƒê√ÇY"; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyBlK2eFfv1Ca-3b_Ew1yXTG3GcWdYw_b5M",
            authDomain: "baocaongay-e73a2.firebaseapp.com",
            projectId: "baocaongay-e73a2",
            storageBucket: "baocaongay-e73a2.firebasestorage.app",
            messagingSenderId: "75165392007",
            appId: "1:75165392007:web:4ec22bb1612108b096ac22",
            measurementId: "G-TEGTD9KFCW"
        };

        // Kh·ªüi t·∫°o
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUserProfile = null;

        // --- AUTH: ƒêƒÇNG NH·∫¨P & B·∫ÆT L·ªñI T√äN MI·ªÄN ---
        window.loginGoogle = () => {
            const btn = document.getElementById('loginBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="loader" style="width:20px;height:20px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:5px;"></span> ƒêang k·∫øt n·ªëi Google...`;
            btn.disabled = true;

            signInWithPopup(auth, provider).catch(err => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                console.error("Login Error:", err);

                // B·∫Øt l·ªói Domain ch∆∞a cho ph√©p tr√™n Firebase (L·ªói ph·ªï bi·∫øn nh·∫•t tr√™n GitHub Pages)
                if (err.code === 'auth/unauthorized-domain') {
                    const currentDomain = window.location.hostname;
                    alert(`‚õî L·ªñI T√äN MI·ªÄN CH∆ØA ƒê∆Ø·ª¢C C·∫§P QUY·ªÄN!\n\nFirebase ƒëang ch·∫∑n t√™n mi·ªÅn: ${currentDomain}\n\nC√ÅCH S·ª¨A:\n1. V√†o Firebase Console -> Authentication -> Settings -> Authorized Domains.\n2. Th√™m d√≤ng: ${currentDomain}`);
                } else if (err.code === 'auth/popup-closed-by-user') {
                    // Ng∆∞·ªùi d√πng t·ª± t·∫Øt popup, kh√¥ng l√†m g√¨ c·∫£
                } else {
                    alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message);
                }
            });
        };

        window.logout = () => {
            if(confirm("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?")) {
                signOut(auth).then(() => location.reload());
            }
        };

        // --- LU·ªíNG TR·∫†NG TH√ÅI ---
        onAuthStateChanged(auth, async (user) => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            if (user) {
                // ƒê√£ login
                document.getElementById('loginScreen').classList.add('hidden');
                try {
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    loadingOverlay.classList.add('hidden');

                    if (userSnap.exists()) {
                        currentUserProfile = userSnap.data();
                        showAppScreen();
                    } else {
                        // Ch∆∞a c√≥ h·ªì s∆° -> Form c·∫≠p nh·∫≠t
                        document.getElementById('profileModal').classList.remove('hidden');
                        document.getElementById('profileEmail').value = user.email;
                    }
                } catch (e) {
                    loadingOverlay.classList.add('hidden');
                    console.error(e);
                    alert("L·ªói t·∫£i d·ªØ li·ªáu. H√£y ki·ªÉm tra l·∫°i Firestore Database.");
                }
            } else {
                // Ch∆∞a login
                loadingOverlay.classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
            }
        });

        function showAppScreen() {
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerHTML = `Xin ch√†o, <b>${currentUserProfile.name}</b>`;
            document.getElementById('userRoleDisplay').innerText = currentUserProfile.role + " - ID: " + currentUserProfile.empId;
            loadReports();
        }

        // --- C·∫¨P NH·∫¨T H·ªí S∆† ---
        window.saveProfile = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const btn = document.getElementById('saveProfileBtn');
            btn.innerText = "ƒêang l∆∞u..."; btn.disabled = true;

            try {
                const profileData = {
                    name: document.getElementById('profileName').value.trim(),
                    empId: document.getElementById('profileId').value.trim(),
                    role: document.getElementById('profileRole').value,
                    email: user.email,
                    uid: user.uid,
                    updatedAt: Timestamp.now()
                };
                
                await setDoc(doc(db, "users", user.uid), profileData);
                document.getElementById('profileModal').classList.add('hidden');
                location.reload();
            } catch (error) {
                alert("L·ªói l∆∞u: " + error.message);
                btn.innerText = "L∆ØU TH√îNG TIN"; btn.disabled = false;
            }
        };

        // --- UPLOAD FILE (APPS SCRIPT) ---
        const convertBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        async function uploadFiles(files) {
            const urls = [];
            for (let i = 0; i < files.length; i++) {
                try {
                    const base64 = await convertBase64(files[i]);
                    // G·ª≠i request upload
                    // L∆∞u √Ω: Apps Script c·∫ßn ƒë∆∞·ª£c deploy v·ªõi quy·ªÅn "Anyone"
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            filename: `${Date.now()}_${files[i].name}`,
                            mimeType: files[i].type,
                            file: base64
                        })
                    });
                    const res = await response.json();
                    if(res.status === 'success') urls.push(res.url);
                } catch (e) {
                    console.warn("Upload file l·ªói (c√≥ th·ªÉ do CORS nh∆∞ng file v·∫´n l√™n):", e);
                }
            }
            return urls;
        }

        // --- G·ª¨I B√ÅO C√ÅO ---
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="loader" style="width:15px;height:15px;border-width:2px;display:inline-block;"></span> ƒêang x·ª≠ l√Ω...`;
            btn.disabled = true;

            // Check URL Apps Script
            if (APPS_SCRIPT_URL.includes("D√ÅN_LINK")) {
                alert("‚ùå L·ªñI: B·∫°n ch∆∞a d√°n Link Apps Script v√†o code!");
                btn.innerHTML = originalText; btn.disabled = false; return;
            }

            // 1. L·∫•y GPS (Timeout nhanh 5s ƒë·ªÉ kh√¥ng ƒë·ª£i l√¢u)
            let lat = 0, lng = 0;
            if ("geolocation" in navigator) {
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {timeout: 5000, enableHighAccuracy: false});
                    });
                    lat = pos.coords.latitude;
                    lng = pos.coords.longitude;
                } catch (err) { console.log("GPS Skip:", err.message); }
            }

            // 2. Upload ·∫¢nh
            const fileInput = document.getElementById('fileInput');
            let attachments = [];
            if (fileInput.files.length > 0) {
                btn.innerHTML = `üì§ ƒêang t·∫£i ${fileInput.files.length} file...`;
                attachments = await uploadFiles(fileInput.files);
            }

            // 3. L∆∞u Firestore
            btn.innerHTML = `üíæ ƒêang l∆∞u d·ªØ li·ªáu...`;
            try {
                await addDoc(collection(db, "daily_reports"), {
                    uid: auth.currentUser.uid,
                    workerName: currentUserProfile.name,
                    workerId: currentUserProfile.empId,
                    role: currentUserProfile.role,
                    timestamp: Timestamp.now(),
                    reportDateString: new Date().toLocaleDateString('vi-VN'),
                    locationCoords: { lat, lng },
                    pct_lct: document.getElementById('pctLct').value,
                    workContent: document.getElementById('workContent').value,
                    notes: document.getElementById('notes').value,
                    attachments: attachments
                });
                
                alert("‚úÖ B√°o c√°o th√†nh c√¥ng!");
                document.getElementById('reportForm').reset();
                // Reset file input label
                document.getElementById('fileLabelText').innerText = "Ch·ªçn ·∫£nh / t√†i li·ªáu (n·∫øu c√≥)";
                loadReports();
            } catch (err) {
                alert("L·ªói g·ª≠i b√°o c√°o: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // X·ª≠ l√Ω hi·ªÉn th·ªã t√™n file khi ch·ªçn
        document.getElementById('fileInput').addEventListener('change', function() {
            const count = this.files.length;
            const label = document.getElementById('fileLabelText');
            label.innerText = count > 0 ? `ƒê√£ ch·ªçn ${count} file` : "Ch·ªçn ·∫£nh / t√†i li·ªáu (n·∫øu c√≥)";
            label.classList.toggle('text-blue-600', count > 0);
        });

        // --- T·∫¢I DANH S√ÅCH ---
        async function loadReports() {
            const list = document.getElementById('reportList');
            list.innerHTML = '<div class="text-center py-4"><span class="loader"></span></div>';
            
            try {
                const todayStr = new Date().toLocaleDateString('vi-VN');
                const q = query(collection(db, "daily_reports"), where("reportDateString", "==", todayStr), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                
                list.innerHTML = "";
                if (snap.empty) {
                    list.innerHTML = '<div class="text-center p-6 bg-gray-50 rounded-lg text-gray-400 italic">Ch∆∞a c√≥ b√°o c√°o n√†o h√¥m nay</div>';
                    return;
                }

                snap.forEach(doc => {
                    const data = doc.data();
                    const time = data.timestamp.toDate().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
                    
                    let filesHtml = "";
                    if (data.attachments && data.attachments.length) {
                        filesHtml = `<div class="mt-2 flex flex-wrap gap-2">
                            ${data.attachments.map((link, i) => 
                                `<a href="${link}" target="_blank" class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold border border-blue-100 hover:bg-blue-100">üìé File ${i+1}</a>`
                            ).join('')}
                        </div>`;
                    }

                    const item = document.createElement("div");
                    item.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-3";
                    item.innerHTML = `
                        <div class="flex justify-between items-start border-b border-gray-100 pb-2 mb-2">
                            <div>
                                <div class="font-bold text-gray-800">${data.workerName}</div>
                                <div class="text-xs text-gray-500">${data.role}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-blue-600">${time}</div>
                                ${data.locationCoords.lat ? '<span class="text-[10px] text-green-500">üìç GPS OK</span>' : ''}
                            </div>
                        </div>
                        <div class="text-gray-700 text-sm whitespace-pre-line mb-2">${data.workContent}</div>
                        ${data.pct_lct ? `<div class="text-xs bg-yellow-50 text-yellow-700 p-1 rounded inline-block mb-1">üé´ Phi·∫øu: <b>${data.pct_lct}</b></div>` : ''}
                        ${data.notes ? `<div class="text-xs text-gray-400 italic mt-1">Ghi ch√∫: ${data.notes}</div>` : ''}
                        ${filesHtml}
                    `;
                    list.appendChild(item);
                });
            } catch (err) {
                console.error(err);
                list.innerHTML = `<div class="text-red-500 text-center text-sm">L·ªói t·∫£i danh s√°ch.<br>Ki·ªÉm tra Index Firestore.</div>`;
            }
        }

        window.onload = () => document.getElementById('profileForm').addEventListener('submit', window.saveProfile);
    </script>
</head>
<body class="bg-gray-50 font-sans text-base text-gray-800 h-screen flex flex-col">

    <div id="loadingOverlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-gray-500 font-medium animate-pulse">ƒêang k·∫øt n·ªëi h·ªá th·ªëng...</p>
    </div>

    <div id="loginScreen" class="hidden flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-br from-blue-700 to-cyan-500 text-white">
        <div class="w-full max-w-sm bg-white text-gray-800 p-8 rounded-2xl shadow-2xl text-center">
            <div class="mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg class="w-8 h-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <h1 class="text-2xl font-extrabold text-blue-800">T·ªî ƒê∆Ø·ªúNG D√ÇY</h1>
                <p class="text-gray-500 text-sm">B√°o C√°o Hi·ªán Tr∆∞·ªùng</p>
            </div>
            
            <button id="loginBtn" onclick="window.loginGoogle()" class="w-full bg-white border-2 border-gray-200 hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-xl flex items-center justify-center transition-all shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3">
                ƒêƒÉng nh·∫≠p b·∫±ng Gmail
            </button>
            <p class="text-xs text-gray-300 mt-6">Phi√™n b·∫£n 1.6</p>
        </div>
    </div>

    <div id="profileModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold text-center mb-1">C·∫≠p Nh·∫≠t H·ªì S∆°</h2>
            <p class="text-xs text-gray-500 text-center mb-5">Th√¥ng tin n√†y s·∫Ω hi·ªÉn th·ªã tr√™n b√°o c√°o</p>
            
            <form id="profileForm" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Email</label>
                    <input type="text" id="profileEmail" disabled class="w-full p-3 bg-gray-100 border border-transparent rounded-lg text-gray-500 font-medium">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">H·ªç v√† T√™n</label>
                    <input type="text" id="profileName" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A" required class="w-full p-3 border border-gray-200 rounded-lg focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">M√£ Nh√¢n Vi√™n</label>
                    <input type="text" id="profileId" placeholder="V√≠ d·ª•: 001234" required class="w-full p-3 border border-gray-200 rounded-lg focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Ch·ª©c danh</label>
                    <select id="profileRole" class="w-full p-3 border border-gray-200 rounded-lg bg-white outline-none">
                        <option value="C√¥ng nh√¢n">C√¥ng nh√¢n</option>
                        <option value="T·ªï tr∆∞·ªüng">T·ªï tr∆∞·ªüng</option>
                        <option value="T·ªï ph√≥">T·ªï ph√≥</option>
                        <option value="K·ªπ thu·∫≠t vi√™n">K·ªπ thu·∫≠t vi√™n</option>
                        <option value="L√°i xe">L√°i xe</option>
                    </select>
                </div>
                <button type="submit" id="saveProfileBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl mt-2 shadow-lg transition">L∆ØU TH√îNG TIN</button>
            </form>
        </div>
    </div>

    <div id="appScreen" class="hidden flex-1 flex flex-col max-w-lg mx-auto w-full">
        <div class="bg-white p-4 shadow-sm z-10 flex justify-between items-center sticky top-0">
            <div>
                <h1 class="text-lg font-bold text-blue-800 leading-tight">B√ÅO C√ÅO C√îNG VI·ªÜC</h1>
                <div class="text-xs text-gray-500 flex flex-col">
                    <span id="userNameDisplay">...</span>
                    <span id="userRoleDisplay" class="text-gray-400">...</span>
                </div>
            </div>
            <button onclick="window.logout()" class="text-xs text-red-500 font-medium bg-red-50 px-3 py-2 rounded-lg hover:bg-red-100 transition">Tho√°t</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            
            <form id="reportForm" class="bg-white rounded-2xl shadow-sm p-5 space-y-4">
                <div class="text-center">
                    <span class="bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1 rounded-full border border-blue-100">
                        üìÖ H√¥m nay: <span id="currentDateDisplay"></span>
                        <script>document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('vi-VN');</script>
                    </span>
                </div>

                <div>
                    <input type="text" id="pctLct" placeholder="S·ªë Phi·∫øu / L·ªánh (n·∫øu c√≥)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition text-sm">
                </div>

                <div>
                    <textarea id="workContent" rows="4" placeholder="N·ªôi dung c√¥ng vi·ªác th·ª±c hi·ªán..." required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition text-sm"></textarea>
                </div>

                <div class="relative group">
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:bg-gray-50 hover:border-blue-400 transition">
                        <input type="file" id="fileInput" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="flex flex-col items-center space-y-1">
                            <svg class="w-6 h-6 text-gray-400 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                            <span id="fileLabelText" class="text-xs text-gray-500 font-medium">Ch·ªçn ·∫£nh / t√†i li·ªáu (n·∫øu c√≥)</span>
                        </div>
                    </div>
                </div>

                <div>
                    <input type="text" id="notes" placeholder="Ghi ch√∫ / Ki·∫øn ngh·ªã..." class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition text-sm">
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transform active:scale-95 transition-all">
                    G·ª¨I B√ÅO C√ÅO
                </button>
            </form>

            <div>
                <div class="flex items-center justify-between mb-3 px-1">
                    <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Nh·∫≠t k√Ω trong ng√†y</h2>
                    <button type="button" onclick="loadReports()" class="text-xs text-blue-600 font-medium bg-white px-2 py-1 rounded shadow-sm border">L√†m m·ªõi</button>
                </div>
                <div id="reportList" class="pb-10">
                    </div>
            </div>
        </div>
    </div>

</body>
</html>
