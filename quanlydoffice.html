<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Văn bản Doffice - v1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        .status-late { color: #ef4444; font-weight: bold; }
        .status-near { color: #f59e0b; font-weight: bold; }
        .status-ok { color: #10b981; }
        .status-none { color: #9ca3af; font-style: italic; }
    </style>
</head>
<body class="bg-gray-50 p-4">
    <div class="max-w-6xl mx-auto">
        <header class="bg-indigo-700 text-white p-4 rounded-t-xl shadow-lg flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">HỆ THỐNG THEO DÕI VĂN BẢN DOFFICE</h1>
                <p class="text-xs opacity-80">Quản lý nội bộ - Chào anh Trần Công Đẹp</p>
            </div>
            <span class="text-sm bg-indigo-800 px-3 py-1 rounded-full font-mono">v1.1</span>
        </header>

        <div class="bg-white p-6 shadow-md mb-6 border-x border-b rounded-b-xl">
            <h2 class="text-sm font-bold mb-2 text-gray-600 uppercase tracking-wider">Dán nội dung từ Doffice:</h2>
            <textarea id="smartInput" class="w-full h-40 p-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:ring-0 outline-none mb-3 transition-all" 
                placeholder="Dán dữ liệu thô tại đây..."></textarea>
            <div class="flex gap-2">
                <button onclick="processData()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-8 rounded-lg shadow-sm transition-all transform active:scale-95">
                    Trích xuất & Lưu trữ
                </button>
                <button onclick="document.getElementById('smartInput').value=''" class="bg-gray-200 hover:bg-gray-300 text-gray-600 font-semibold py-2.5 px-4 rounded-lg transition-all">
                    Xóa ô nhập
                </button>
            </div>
        </div>

        <div class="bg-white shadow-xl rounded-xl overflow-hidden border border-gray-200">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
                        <th class="p-4 border-b">Số VB</th>
                        <th class="p-4 border-b">Nội dung / Người gửi</th>
                        <th class="p-4 border-b">Ngày gửi</th>
                        <th class="p-4 border-b">Hạn hoàn thành</th>
                        <th class="p-4 border-b">Chủ trì</th>
                        <th class="p-4 border-b text-center">Trạng thái</th>
                        <th class="p-4 border-b text-center">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="documentTableBody" class="text-sm text-gray-700">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo",
            authDomain: "tavietnam-78ae8.firebaseapp.com",
            projectId: "tavietnam-78ae8",
            storageBucket: "tavietnam-78ae8.firebasestorage.app",
            messagingSenderId: "670121705534",
            appId: "1:670121705534:web:1027ad98550573ad37116f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function processData() {
            const rawText = document.getElementById('smartInput').value;
            if (!rawText.trim()) return;

            const lines = rawText.split('\n').map(l => l.trim()).filter(l => l !== "");
            
            let docData = {
                soVB: "Chưa xác định",
                noiDung: "",
                ngayGui: "",
                hanHoanThanh: "",
                chuTri: "Chưa phân công",
                ngayTao: new Date().getTime()
            };

            // 1. Tìm Số VB (Dạng có dấu /)
            const soVBIndex = lines.findIndex(l => l.includes('/'));
            if (soVBIndex !== -1) docData.soVB = lines[soVBIndex];

            // 2. Tìm các mốc ngày (DD/MM/YYYY)
            const datePattern = /\d{2}\/\d{2}\/\d{4}/g;
            const allDates = rawText.match(datePattern) || [];
            
            if (allDates.length >= 1) docData.ngayGui = allDates[0];
            if (allDates.length >= 2) docData.hanHoanThanh = allDates[1];

            // 3. Tìm Chủ trì
            const chuTriLine = lines.find(l => l.toLowerCase().includes("chủ trì:"));
            if (chuTriLine) {
                docData.chuTri = chuTriLine.split(':')[1].trim();
            }

            // 4. Tìm Nội dung (Thường là dòng chữ dài không chứa ngày tháng hoặc số VB)
            // Lấy dòng sau Số VB nếu không phải là ngày
            if (lines[soVBIndex + 1] && !lines[soVBIndex + 1].match(datePattern)) {
                docData.noiDung = lines[soVBIndex + 1];
                // Nếu dòng tiếp theo cũng là chữ, cộng dồn vào nội dung
                if (lines[soVBIndex + 2] && !lines[soVBIndex + 2].match(datePattern) && !lines[soVBIndex + 2].toLowerCase().includes("chủ trì")) {
                    docData.noiDung += " - " + lines[soVBIndex + 2];
                }
            }

            db.ref('van_ban_doffice').push(docData).then(() => {
                document.getElementById('smartInput').value = "";
                alert("Đã trích xuất và thêm văn bản!");
            });
        }

        db.ref('van_ban_doffice').orderByChild('ngayTao').on('value', (snapshot) => {
            const tbody = document.getElementById('documentTableBody');
            tbody.innerHTML = "";
            const data = snapshot.val();

            if (!data) return;

            // Chuyển object thành array và đảo ngược để hiện mới nhất lên đầu
            const sortedKeys = Object.keys(data).reverse();

            sortedKeys.forEach(id => {
                const vb = data[id];
                const status = getStatus(vb.hanHoanThanh);
                
                const row = `
                    <tr class="hover:bg-indigo-50 border-b transition-colors">
                        <td class="p-4 font-bold text-indigo-900">${vb.soVB}</td>
                        <td class="p-4 max-w-xs">${vb.noiDung}</td>
                        <td class="p-4 text-gray-500">${vb.ngayGui}</td>
                        <td class="p-4 font-semibold text-orange-600">${vb.hanHoanThanh || '---'}</td>
                        <td class="p-4 font-medium">${vb.chuTri}</td>
                        <td class="p-4 text-center ${status.class}">${status.text}</td>
                        <td class="p-4 text-center">
                            <button onclick="deleteDoc('${id}')" class="text-red-400 hover:text-red-700 font-bold px-2 py-1">Xóa</button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        });

        function getStatus(deadlineStr) {
            if (!deadlineStr || deadlineStr === "") return { text: "Chờ cập nhật hạn", class: "status-none" };
            
            try {
                const parts = deadlineStr.split('/');
                const deadline = new Date(parts[2], parts[1] - 1, parts[0]);
                const today = new Date();
                today.setHours(0,0,0,0);

                const diffDays = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));

                if (diffDays < 0) return { text: "Quá hạn", class: "status-late" };
                if (diffDays <= 3) return { text: "Sắp đến hạn", class: "status-near" };
                return { text: "Đang xử lý", class: "status-ok" };
            } catch (e) {
                return { text: "Lỗi ngày", class: "status-late" };
            }
        }

        function deleteDoc(id) {
            if (confirm("Xác nhận xóa bản ghi này?")) {
                db.ref('van_ban_doffice/' + id).remove();
            }
        }
    </script>
</body>
</html>
